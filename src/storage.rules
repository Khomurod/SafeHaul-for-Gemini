rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // --- HELPERS ---
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user owns the folder (matches their UID)
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if user is Super Admin
    function isSuperAdmin() {
       return isSignedIn() && (
         request.auth.token.email == 'admin@trucking.com' || 
         (request.auth.token.keys().hasAny(['globalRole']) && request.auth.token.globalRole == 'super_admin') ||
         (request.auth.token.keys().hasAny(['roles']) && request.auth.token.roles.keys().hasAny(['globalRole']) && request.auth.token.roles.globalRole == 'super_admin')
      );
    }

    // Check if user is part of the company team
    function isCompanyTeam(companyId) {
      return isSignedIn() && (
        isSuperAdmin() || 
        (
          request.auth.token.keys().hasAny(['roles']) &&
          request.auth.token.roles.keys().hasAny([companyId]) &&
          request.auth.token.roles[companyId] in ['company_admin', 'hr_user']
        )
      );
    }
    
    // Validate file type and size for uploads
    function isValidFile() {
      return request.resource.size < 10 * 1024 * 1024 && // Max 10MB
             request.resource.contentType.matches('application/pdf|image/png|image/jpeg|image/gif|image/webp');
    }
    
    // --- RULES ---

    // 1. COMPANY ASSETS (Logos, branding)
    match /company_assets/{companyId}/{allPaths=**} {
      allow read: if true;
      allow write: if isCompanyTeam(companyId) && isValidFile();
    }

    // 2. MASTER DRIVER PROFILE UPLOADS
    match /drivers/{driverId}/{allPaths=**} {
      allow read: if isOwner(driverId) || isSuperAdmin();
      allow write: if (isOwner(driverId) || isSuperAdmin()) && isValidFile();
    }

    // 3. COMPANY APPLICATION FILES
    // Path: companies/{companyId}/applications/{applicantId}/...
    match /companies/{companyId}/applications/{applicantId}/{allPaths=**} {
      // Read: HR Team or the applicant who owns the files
      allow read: if isOwner(applicantId) || isCompanyTeam(companyId);
      
      // Write: Authenticated users with proper validation
      allow write: if (
        // Authenticated owner or company team with file validation
        (isSignedIn() && (isOwner(applicantId) || isCompanyTeam(companyId)) && isValidFile()) ||
        
        // Public guest uploads (for apply without login) - strict limits
        (
          request.resource.size < 5 * 1024 * 1024 && // Max 5MB for guests
          request.resource.contentType.matches('application/pdf|image/png|image/jpeg|image/gif')
        )
      );
    }

    // 4. GLOBAL LEADS FILES
    match /global_leads/{applicantId}/{allPaths=**} {
      allow read: if isOwner(applicantId) || isSuperAdmin();
      allow write: if (isOwner(applicantId) || isSuperAdmin()) && isValidFile();
    }

    // 5. SYSTEM HEALTH DIAGNOSTICS (Super Admin only in production)
    match /system_health_tests/{fileName} {
      allow read, write: if isSuperAdmin();
    }
    
    // 6. FALLBACK (Deny everything else)
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
