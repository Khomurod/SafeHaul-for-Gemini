rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // --- HELPERS ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    
    // SUPER ADMIN CHECK
    function isSuperAdmin() {
       return isSignedIn() && (
         request.auth.token.email == 'admin@trucking.com' || 
         (request.auth.token.keys().hasAny(['globalRole']) && request.auth.token.globalRole == 'super_admin') ||
         (request.auth.token.keys().hasAny(['roles']) && request.auth.token.roles.keys().hasAny(['globalRole']) && request.auth.token.roles.globalRole == 'super_admin')
      );
    }

    // COMPANY TEAM CHECK
    function isCompanyTeam(companyId) {
      return isSignedIn() && (
        isSuperAdmin() ||
        (
          request.auth.token.keys().hasAny(['roles']) && 
          request.auth.token.roles.keys().hasAny([companyId]) && 
          request.auth.token.roles[companyId] in ['company_admin', 'hr_user', 'recruiter']
        )
      );
    }
    
    // VALIDATION
    function isValidFile() {
      // Allow images and PDFs, max 10MB
      return request.resource.size < 10 * 1024 * 1024 &&
             request.resource.contentType.matches('application/pdf|image/.*');
    }

    // --- RULES ---

    // 1. Company Assets (Logos, Branding)
    // Public Read, Team Write
    match /company_assets/{companyId}/{allPaths=**} {
      allow read: if true;
      allow write: if isCompanyTeam(companyId) && isValidFile();
    }

    // 2. Driver Private Documents (e.g. License photos in their own folder)
    match /drivers/{driverId}/{allPaths=**} {
      allow read, write: if isOwner(driverId) || isSuperAdmin();
    }

    // 3. Application Attachments (Submitted to a Company)
    // Path: companies/{companyId}/applications/{applicantId}/...
    match /companies/{companyId}/applications/{applicantId}/{allPaths=**} {
      // Read: The Applicant or the Company Team
      allow read: if isOwner(applicantId) || isCompanyTeam(companyId) || isSuperAdmin();
      
      // Write:
      // 1. Super Admin (Always)
      // 2. Auth User (The Applicant) -> Can upload their files
      // 3. Company Team -> Can upload docs to the application
      allow write: if isSuperAdmin() || 
                      (isSignedIn() && (isOwner(applicantId) || isCompanyTeam(companyId)) && isValidFile());
    }

    // 4. Global Leads Files (General Pool)
    match /global_leads/{applicantId}/{allPaths=**} {
      allow read, write: if isOwner(applicantId) || isSuperAdmin();
    }
    
    // 5. System Health Tests
    match /system_health_tests/{fileName} {
      allow read, write: if isSuperAdmin();
    }
  }
}