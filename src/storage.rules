rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // --- HELPERS ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    
    // FIXED: Aligned with Firestore. Removed hardcoded email.
    function isSuperAdmin() {
       return isSignedIn() && (
         (request.auth.token.keys().hasAny(['globalRole']) && request.auth.token.globalRole == 'super_admin') ||
         (request.auth.token.keys().hasAny(['roles']) && request.auth.token.roles.keys().hasAny(['globalRole']) && request.auth.token.roles.globalRole == 'super_admin')
      );
    }

    function isCompanyTeam(companyId) {
      return isSignedIn() && (
        isSuperAdmin() ||
        (
          request.auth.token.keys().hasAny(['roles']) && 
          request.auth.token.roles.keys().hasAny([companyId]) && 
          request.auth.token.roles[companyId] in ['company_admin', 'hr_user', 'recruiter']
        )
      );
    }
    
    // Validation
    function isValidFile() {
      return request.resource.size < 10 * 1024 * 1024 &&
             request.resource.contentType.matches('application/pdf|image/png|image/jpeg|image/gif|image/webp');
    }

    function isValidGuestFile() {
      return request.resource.size < 5 * 1024 * 1024 && 
             request.resource.contentType.matches('application/pdf|image/png|image/jpeg');
    }

    // --- RULES ---

    // 1. Company Assets
    match /company_assets/{companyId}/{allPaths=**} {
      allow read: if true;
      allow write: if isCompanyTeam(companyId) && isValidFile();
    }

    // 2. Driver Private Documents
    match /drivers/{driverId}/{allPaths=**} {
      allow read, write: if isOwner(driverId) || isSuperAdmin();
    }

    // 3. Application Attachments
    match /companies/{companyId}/applications/{applicantId}/{allPaths=**} {
      allow read: if isOwner(applicantId) || isCompanyTeam(companyId);
      
      // Write Logic:
      // 1. Super Admin: BYPASSES 'isValidFile' (Allows .txt for diagnostics)
      // 2. Auth User: Standard validation
      // 3. Guest: Strict validation
      allow write: if (isSuperAdmin()) ||
                      (isSignedIn() && (isOwner(applicantId) || isCompanyTeam(companyId)) && isValidFile()) ||
                      (!isSignedIn() && isValidGuestFile());
    }

    // 4. Global Leads Files
    match /global_leads/{applicantId}/{allPaths=**} {
      allow read, write: if isOwner(applicantId) || isSuperAdmin();
    }
    
    // 5. System Health Tests (The .txt upload test)
    match /system_health_tests/{fileName} {
      allow read, write: if isSuperAdmin();
    }
  }
}