const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/form-options-DRTvQM9c.js","assets/index-Eut2KIY5.js","assets/pdfjs-CN6VhWT3.js","assets/index-BZGRJBJ7.css","assets/index-uZZlzjz-.js","assets/storage-gYyq0gBL.js"])))=>i.map(i=>d[i]);
import{y as B,z as M,A as Q,B as Y,S as J,C as m,D as s,L as K,U as W,F as X,q as Z,f as ee,a as j,w as te,V as ae,e as se,d as U,g as re,_ as T,j as q,x as ie,k as ne,l as oe,m as le,o as ce,p as ue,t as me}from"./index-Eut2KIY5.js";import{S as de}from"./Stepper-Da0qBMt9.js";import{g as pe,a as fe}from"./applicationId-D0tBiTrd.js";import"./pdfjs-CN6VhWT3.js";import"./form-options-DRTvQM9c.js";import"./file-text-fIi5thw4.js";import"./upload-CeDmLZPo.js";import"./circle-BoyhTIEe.js";import"./shield-B8dSCmK2.js";import"./beaker-BDw6Lckq.js";import"./pen-DKw8HDfG.js";import"./signature-CKsXCBTr.js";import"./file-pen-line-CZApjMvZ.js";import"./save-xDZOd2sT.js";const ye=n=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n),ge=n=>n.replace(/\D/g,"").length===10;function Ce(){const{slug:n}=B(),[y]=M(),F=Q(),{showSuccess:v,showError:h}=Y(),{setCurrentCompanyProfile:A}=J(),[L,w]=m.useState(!0),[P,I]=m.useState(""),[c,k]=m.useState(null),[R,S]=m.useState(0),[t,z]=m.useState({}),[$,D]=m.useState(!1),[_,N]=m.useState(null),E=m.useRef(!1);m.useEffect(()=>{if(E.current)return;E.current=!0;async function i(){if(!n){I("Invalid link - no company specified."),w(!1);return}try{let e=null,r=null;const o=Z(ee(j,"companies"),te("appSlug","==",n),ae(1)),u=await se(o);if(!u.empty)r=u.docs[0].id,e={id:r,...u.docs[0].data()};else{const x=U(j,"companies",n),d=await re(x);d.exists()&&(r=d.id,e={id:r,...d.data()})}if(!e){I("Company not found."),w(!1);return}k(e),A&&A(e);const p=y.get("r")||y.get("recruiter");p&&sessionStorage.setItem("pending_application_recruiter",p),sessionStorage.setItem("pending_application_company",r),w(!1)}catch(e){console.error("Error loading company:",e),I("Unable to load application."),w(!1)}}i()},[n,y,A]);const C=(i,e)=>{z(r=>({...r,[i]:e}))},V=i=>{i==="next"?S(e=>e+1):i==="back"?S(e=>Math.max(0,e-1)):typeof i=="number"&&S(i),window.scrollTo(0,0)},H=async(i,e)=>{if(e){D(!0);try{const{httpsCallable:r}=await T(async()=>{const{httpsCallable:a}=await import("./form-options-DRTvQM9c.js").then(l=>l.i);return{httpsCallable:a}},__vite__mapDeps([0,1,2,3])),{functions:o}=await T(async()=>{const{functions:a}=await import("./index-uZZlzjz-.js");return{functions:a}},__vite__mapDeps([4,1,2,3,5])),u=r(o,"getSignedUploadUrl"),{data:{url:p,storagePath:x,publicUrl:d}}=await u({companyId:c.id,fileName:e.name,fileType:e.type,folder:"applications"});if(!(await fetch(p,{method:"PUT",headers:{"Content-Type":e.type},body:e})).ok)throw new Error("Upload request failed");const g={name:e.name,url:d,storagePath:x};return C(i,g),v("File uploaded successfully."),g}catch(r){throw console.error("Upload Error:",r),h("Upload failed. Please try again."),r}finally{D(!1)}}},G=()=>{localStorage.setItem(`draft_${n}`,JSON.stringify(t)),v("Progress saved.")},O=async()=>{if(!t.signature||!t["final-certification"]){h("Please complete the electronic signature in Step 9."),S(8);return}if(!ye(t.email)){h("Invalid Email Address.");return}if(!ge(t.phone)){h("Invalid Phone Number.");return}if(_==="submitting")return;N("submitting");const i=t.email||"",e=t.phone||"";q({category:"submission",message:"Guest application submission started",data:{companyId:c.id,slug:n},level:"info"});try{let r=function(a){if(a===void 0||a===null)return null;if(a instanceof Date)return a;if(Array.isArray(a))return a.map(r);if(typeof a=="object"){const l={};for(const b in a)l[b]=r(a[b]);return l}return a},o;try{o=await pe(c.id,i,e)}catch{o=y.get("prefill")||y.get("leadId")||`guest_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const u=fe(),p=ie(),x=sessionStorage.getItem("pending_application_recruiter"),d=r({applicantId:o,applicationId:o,confirmationNumber:u,personalInfo:{firstName:t.firstName||"",lastName:t.lastName||"",email:i,phone:e},...t,email:i,phone:e,signature:t.signature,signatureType:t.signatureType||"drawn",companyId:c.id,companyName:c.companyName,recruiterCode:x||null,sourceType:"Public Application",sourceSlug:n,status:"New Application",submittedAt:p,createdAt:p,employers:Array.isArray(t.employers)?t.employers:[],violations:Array.isArray(t.violations)?t.violations:[],accidents:Array.isArray(t.accidents)?t.accidents:[],schools:Array.isArray(t.schools)?t.schools:[],military:Array.isArray(t.military)?t.military:[],lifecycle:{status:"pending",submittedAt:new Date().toISOString(),clientVersion:"2.0-bulletproof",isGuest:!0}});let f=null;if(ne())try{await oe(),f=await le(d,c.id,{type:"guest",userId:null}),console.log(`[PublicApplyHandler] Queued submission ${f}`)}catch(a){console.warn("[PublicApplyHandler] Queue failed:",a)}let g;for(let a=1;a<=3;a++)try{const l=U(j,"companies",c.id,"applications",o);if(await ce(l,d,{merge:!0}),f)try{await ue(f)}catch(b){console.warn("[PublicApplyHandler] Dequeue failed:",b)}N("success"),localStorage.removeItem(`draft_${n}`),sessionStorage.removeItem("pending_application_recruiter"),q({category:"submission",message:"Guest application submitted successfully",data:{applicationId:o,confirmationNumber:u},level:"info"}),sessionStorage.setItem("lastConfirmationNumber",u);return}catch(l){console.warn(`[PublicApplyHandler] Attempt ${a} failed:`,l),g=l,a<3&&await new Promise(b=>setTimeout(b,1e3*Math.pow(2,a-1)))}if(me(g,{tags:{flow:"guest_application",stage:"submission_failed"},extra:{applicationId:o,companyId:c.id,queueId:f}}),f)N("queued"),v("Your application is saved and will be submitted automatically when connection is restored.");else throw g}catch(r){console.error("Submission error:",r),N("error"),h("Failed to submit application. Please try again.")}};return L?s.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center",children:[s.jsx(K,{className:"animate-spin text-blue-600 mb-4",size:48}),s.jsx("h2",{className:"text-lg font-semibold text-gray-700",children:"Loading Application..."})]}):P?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg border border-red-100 text-center max-w-md",children:[s.jsx(W,{size:32,className:"text-red-600 mx-auto mb-4"}),s.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Link Error"}),s.jsx("p",{className:"text-gray-600",children:P})]})}):_==="success"?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white p-8 rounded-2xl shadow-xl text-center max-w-md border border-green-100",children:[s.jsx(X,{size:40,className:"text-green-600 mx-auto mb-6"}),s.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-3",children:"Application Submitted!"}),s.jsx("p",{className:"text-gray-600 mb-6",children:"Your application has been received and a recruiter will contact you soon."}),s.jsx("button",{onClick:()=>F("/"),className:"text-blue-600 hover:underline text-sm font-medium",children:"Go to home"})]})}):s.jsxs("div",{className:"min-h-screen bg-gray-50 pb-24",children:[s.jsx("div",{className:"bg-white border-b border-gray-200 sticky top-0 z-20 px-4 py-3 shadow-sm",children:s.jsx("div",{className:"max-w-4xl mx-auto flex items-center justify-between font-bold",children:c.companyName})}),s.jsx("div",{className:"max-w-4xl mx-auto mt-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:s.jsx(de,{step:R,formData:t,updateFormData:C,onNavigate:V,onPartialSubmit:G,onFinalSubmit:O,handleFileUpload:H,isUploading:$,submissionStatus:_})})]})}export{Ce as PublicApplyHandler};
