import{D as e,X as V,a0 as se,a1 as ae,C as r,d as F,a as C,g as L,S as ie,A as re,y as ne,B as oe,x as le,o as ce,L as de,a2 as W}from"./index-Eut2KIY5.js";import{u as ue,s as me}from"./driverService-BuYSst19.js";import{S as G}from"./Stepper-Da0qBMt9.js";import{F as fe}from"./file-text-fIi5thw4.js";import{S as pe}from"./save-xDZOd2sT.js";import"./pdfjs-CN6VhWT3.js";import"./applicationId-D0tBiTrd.js";import"./form-options-DRTvQM9c.js";import"./upload-CeDmLZPo.js";import"./circle-BoyhTIEe.js";import"./shield-B8dSCmK2.js";import"./beaker-BDw6Lckq.js";import"./pen-DKw8HDfG.js";import"./signature-CKsXCBTr.js";import"./file-pen-line-CZApjMvZ.js";function he({isOpen:o,draftData:n,onResume:f,onStartFresh:p,onClose:u}){if(!o)return null;const t=n?.lastStep||0,y=n?.lastSavedAt?new Date(n.lastSavedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"Unknown",d=n?.firstName||"",g=["Personal Information","Qualifications","License Information","Motor Vehicle Record","Accident History","Employment History","General Questions","Review","Signature"][t]||`Step ${t+1}`;return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:u}),e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-in zoom-in-95 slide-in-from-bottom-4 duration-300",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-5 text-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-white/20 rounded-lg",children:e.jsx(fe,{size:24})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold",children:["Welcome Back",d?`, ${d}`:"","!"]}),e.jsx("p",{className:"text-blue-100 text-sm mt-0.5",children:"You have an unfinished application"})]})]}),e.jsx("button",{onClick:u,className:"absolute top-4 right-4 p-1 text-white/70 hover:text-white transition-colors",children:e.jsx(V,{size:20})})]}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Last saved:"})," ",y]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Progress:"})," ",g]})]})}),e.jsx("p",{className:"text-gray-600 text-sm mb-6",children:"Would you like to continue where you left off, or start a fresh application?"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:f,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(se,{size:18}),"Continue Application"]}),e.jsxs("button",{onClick:p,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors",children:[e.jsx(ae,{size:18}),"Start Fresh"]})]}),e.jsx("p",{className:"text-xs text-gray-400 text-center mt-4",children:"Starting fresh will permanently delete your saved progress."})]})]})]})}function xe(o,n={}){if(!o?.sections)return{sections:[],fields:[]};const f=new Set(n.hiddenFields||[]),p=n.fieldOverrides||{},u=n.additionalQuestions||[],t=o.sections.map(d=>{const g=(d.fields||[]).filter(i=>i.dotRequired?!0:!(i.canCompanyHide&&f.has(i.key))).map(i=>{const b=p[i.key];return!b||!i.canCompanyModify?i:{...i,label:b.label||i.label,helpText:b.helpText||i.helpText,placeholder:b.placeholder||i.placeholder}});return{...d,fields:g}});if(u.length>0){const d={id:"companyCustomQuestions",title:"Additional Questions",stepNumber:8,order:50,isCustom:!0,fields:u.map((h,g)=>({...h,key:h.key||h.id||`custom-${g}`,isCustom:!0}))};t.push(d)}const y=t.flatMap(d=>(d.fields||[]).map(h=>({...h,sectionId:d.id,sectionTitle:d.title,stepNumber:d.stepNumber})));return{version:o.version,sections:t,fields:y}}function q(o,n){return o?.sections?o.sections.filter(f=>f.stepNumber===n).flatMap(f=>f.fields||[]):[]}function J(o,n={}){return o.dependsOn?n[o.dependsOn]===o.showWhen:!0}function ge(o,n,f={}){const p=q(o,n),u=[];for(const t of p){if(!t.required||!J(t,f))continue;const y=f[t.key];(y==null||y==="")&&u.push(t)}return{valid:u.length===0,missingFields:u}}const be="system_settings",ye="application_schema";function ve(o){const[n,f]=r.useState(null),[p,u]=r.useState(null),[t,y]=r.useState(!0),[d,h]=r.useState(null),g=r.useCallback(async()=>{y(!0),h(null);try{const x=F(C,be,ye),v=await L(x);if(v.exists()?f(v.data()):(console.warn("[useApplicationSchema] No global schema found"),f(null)),o){const R=F(C,"companies",o,"settings","custom_questions"),m=await L(R);m.exists()?u(m.data()):u({})}else u({})}catch(x){console.error("[useApplicationSchema] Error fetching schemas:",x),h(x.message)}finally{y(!1)}},[o]);r.useEffect(()=>{g()},[g]);const i=r.useMemo(()=>n?xe(n,p):null,[n,p]),b=r.useCallback(x=>i?q(i,x):[],[i]),c=r.useCallback((x,v)=>i?ge(i,x,v):{valid:!0,missingFields:[]},[i]),N=r.useCallback((x,v)=>J(x,v),[]),D=r.useMemo(()=>i?.sections?i.sections.some(x=>x.isCustom&&x.fields?.length>0):!1,[i]);return{schema:i,globalSchema:n,companyOverrides:p,loading:t,error:d,getStepFields:b,validateStepData:c,checkFieldVisible:N,hasCustomQuestions:D,refetch:g}}function Ie({isOpen:o,onClose:n,onSuccess:f,job:p,companyId:u}){const{currentUser:t}=ie(),y=re(),{companyId:d}=ne(),{showSuccess:h,showError:g}=oe(),[i,b]=r.useState(0),[c,N]=r.useState({}),[D,x]=r.useState(!0),[v,R]=r.useState(!1),[m,T]=r.useState(null),[O,P]=r.useState(null),[X,M]=r.useState(!1),[k,Y]=r.useState(null),[K,U]=r.useState(!1),A=r.useRef(null),$=r.useRef({}),_=r.useRef(!1),{schema:E}=ve(m),z=E?.sections?.find(s=>s.isCustom)?.fields||E?.fields?.filter(s=>s.isCustom)||[];r.useEffect(()=>{if(d)T(d);else if(u)T(u);else{const s=sessionStorage.getItem("pending_application_company");s&&T(s)}},[d,u]),r.useEffect(()=>{(async()=>{if(!(!t||!m))try{const a=`app_${m}`,l=F(C,"drivers",t.uid,"drafts",a),S=await L(l);if(S.exists()){const j=S.data();Y(j),j.lastStep>0||j.firstName||j.email?M(!0):(N(j),j.lastStep&&b(j.lastStep))}else N({email:t.email,phone:t.phoneNumber||"",firstName:t.displayName?.split(" ")[0]||"",lastName:t.displayName?.split(" ").slice(1).join(" ")||""})}catch(a){console.error("Error loading draft:",a)}finally{x(!1)}})()},[t,m]);const Z=()=>{k&&(N(k),k.lastStep&&b(k.lastStep)),M(!1)},ee=async()=>{if(t&&m)try{const s=`app_${m}`,a=F(C,"drivers",t.uid,"drafts",s);await W(a)}catch(s){console.error("Failed to clear draft:",s)}N({email:t?.email||"",phone:t?.phoneNumber||"",firstName:t?.displayName?.split(" ")[0]||"",lastName:t?.displayName?.split(" ").slice(1).join(" ")||""}),b(0),M(!1)},w=r.useCallback(async(s={})=>{if(!(!t||!m)){if(_.current){console.log("Skipping draft save - submission in progress");return}U(!0);try{const a={...c,...s,lastStep:i,updatedAt:le(),lastSavedAt:new Date().toISOString(),companyId:m};N(a),$.current=a;const l=`app_${m}`,S=F(C,"drivers",t.uid,"drafts",l);await ce(S,a,{merge:!0})}catch(a){console.error("Auto-save failed:",a)}finally{U(!1)}}},[t,c,i,m]);r.useEffect(()=>(A.current&&clearTimeout(A.current),t&&Object.keys(c).length>0&&!D&&(A.current=setTimeout(()=>{JSON.stringify(c)!==JSON.stringify($.current)&&w()},5e3)),()=>{A.current&&clearTimeout(A.current)}),[c,t,D,w]),r.useEffect(()=>{const s=a=>{t&&Object.keys(c).length>0&&m&&!_.current&&console.log("[DriverApplicationWizard] Page unload - draft check")};return window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)},[t,c,i,m]);const I=(s,a)=>{const l={...c,[s]:a};N(l)},Q=s=>{w(),s==="next"?b(a=>a+1):s==="back"?b(a=>Math.max(0,a-1)):typeof s=="number"&&b(s)},B=async(s,a)=>{if(!a)return null;R(!0);try{const l=await ue(m,t.uid,s,a);return I(s,l),await w({[s]:l}),h("File uploaded successfully."),l}catch(l){console.error("Upload failed:",l);let S="Upload failed. Please try again.";throw l.message.includes("exceeds 20MB")&&(S="File is too large (Max 20MB)."),g(S),l}finally{R(!1)}},te=()=>{if(!E?.sections)return[];const s=[];return E.sections.forEach(a=>{a.fields.forEach(l=>{l.required&&!c[l.id]&&c[l.id]!==0&&c[l.id]!==!1&&s.push(l.label)})}),z.forEach(a=>{a.required&&!c[a.id]&&s.push(a.label||a.question)}),s},H=async()=>{const s=te();if(s.length>0){g(`Missing required fields: ${s.slice(0,3).join(", ")}${s.length>3?"...":""}`);return}if(!c.signature||!c["final-certification"]){g("Please provide your signature and certify the application."),b(E?.sections?.length||8);return}_.current=!0;try{const a=m;await me(t,c,a,p);const l=`app_${a}`,S=F(C,"drivers",t.uid,"drafts",l);await W(S),sessionStorage.removeItem("pending_application_company"),P("success"),h("Application Submitted!"),f&&p?.id&&f(p.id),setTimeout(()=>{n?n():y("/driver/dashboard")},1500)}catch(a){console.error("Submission Error:",a),P("error"),g("Failed to submit application.")}};return D?o?null:e.jsx("div",{className:"h-screen flex items-center justify-center",children:e.jsx(de,{className:"animate-spin text-blue-600",size:40})}):o?e.jsx("div",{className:"fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-gray-50 w-full max-w-5xl max-h-[95vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"px-6 py-4 bg-white border-b border-gray-200 flex justify-between items-center shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Complete DOT Application"}),p&&e.jsxs("p",{className:"text-sm text-gray-500 font-medium italic",children:["Position: ",p.title]})]}),e.jsx("button",{onClick:n,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-all",children:e.jsx(V,{size:24})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 bg-white",children:e.jsx("div",{className:"max-w-4xl mx-auto border border-gray-100 rounded-xl shadow-sm",children:e.jsx(G,{step:i,formData:c,updateFormData:I,onNavigate:Q,onPartialSubmit:()=>{w(),h("Draft saved.")},onFinalSubmit:H,handleFileUpload:B,isUploading:v,submissionStatus:O,customQuestions:z})})})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-20",children:[e.jsx(he,{isOpen:X,draftData:k,onResume:Z,onStartFresh:ee,onClose:()=>M(!1)}),e.jsxs("div",{className:"bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-30",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"font-bold text-gray-900",children:"Driver Application"}),K&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-gray-400",children:[e.jsx(pe,{size:12,className:"animate-pulse"}),"Saving..."]})]}),e.jsx("button",{onClick:()=>y("/driver/dashboard"),className:"text-sm text-gray-500 hover:text-gray-800 font-medium",children:"Save & Exit"})]}),e.jsx("div",{className:"max-w-4xl mx-auto mt-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:e.jsx(G,{step:i,formData:c,updateFormData:I,onNavigate:Q,onPartialSubmit:()=>{w(),h("Draft saved.")},onFinalSubmit:H,handleFileUpload:B,isUploading:v,submissionStatus:O,customQuestions:z})})]})}export{Ie as DriverApplicationWizard};
