import{ar as S,au as R,aq as U,as as C,c as L,r,j as e,L as N,ay as k,F as M,x as A,y as D,X as F,H as P,p as z,d as _}from"./index-DL8sidqm.js";import{u as q,a as T,b as $,c as H,d as I}from"./userService-CF_Ufzlf.js";import{T as E}from"./trash-2-wanxsFLc.js";import{P as B}from"./plus-7Y37wSRt.js";async function Z(a,d){if(!a||!d)throw new Error("Company ID and file are required for upload.");const c=d.name.split(".").pop(),n=`company_assets/${a}/logo.${c}`,l=S(C,n);try{const m=await R(l,d);return await U(m.ref)}catch(m){throw console.error("Error uploading company logo:",m),new Error("File upload failed. Please try again.")}}const K=[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]],O=L("key-round",K);function V({userId:a,initialName:d,email:c,companyId:n,onSave:l}){const[m,g]=r.useState(d||""),[t,x]=r.useState(c||""),[u,h]=r.useState(!1),[p,i]=r.useState(""),[b,y]=r.useState(!1),[j,v]=r.useState(!1),s=async()=>{h(!0),i("Saving...");try{await q(a,{name:m,email:t},n),i("Profile saved!"),l&&l(),setTimeout(()=>i(""),2e3)}catch(o){console.error("Error updating user:",o),i("Error: "+(o.message||"Unknown error"))}finally{h(!1)}},f=async()=>{if(t&&window.confirm(`Send password reset email to ${t}?`)){y(!0);try{await k(M,t),alert(`Password reset email sent to ${t}`)}catch(o){console.error("Reset Password Error:",o),alert("Failed to send reset email: "+o.message)}finally{y(!1)}}},w=async()=>{if(window.confirm("Are you sure you want to delete this user? This action cannot be undone.")){v(!0);try{await A(D,"deletePortalUser")({userId:a,companyId:n}),alert("User deleted/removed successfully."),l&&l()}catch(o){console.error("Delete User Error:",o),alert("Failed to delete user: "+o.message)}finally{v(!1)}}};return e.jsxs("div",{className:"bg-white p-5 rounded-lg border border-gray-200 shadow-sm space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-700",children:"User Profile"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Update basic information."})]}),e.jsxs("form",{className:"space-y-4",onSubmit:o=>{o.preventDefault(),s()},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"edit-user-name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Full Name"}),e.jsx("input",{type:"text",id:"edit-user-name",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-shadow",required:!0,value:m,onChange:o=>g(o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"edit-user-email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email Address"}),e.jsx("input",{type:"email",id:"edit-user-email",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-shadow",required:!0,value:t,onChange:o=>x(o.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-4 pt-2",children:[e.jsxs("button",{type:"submit",className:"px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors shadow-sm flex items-center gap-2",disabled:u,children:[u&&e.jsx(N,{size:16,className:"animate-spin"}),u?"Saving...":"Save Changes"]}),e.jsx("p",{className:`text-sm font-medium ${p.startsWith("Error")?"text-red-600":"text-green-600"}`,children:p})]})]}),e.jsxs("div",{className:"pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-900 mb-4",children:"Account Actions"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("button",{type:"button",onClick:f,disabled:b,className:"flex-1 px-4 py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded-lg hover:bg-orange-100 font-medium text-sm flex items-center justify-center gap-2 transition-colors",children:[b?e.jsx(N,{size:16,className:"animate-spin"}):e.jsx(O,{size:16}),"Send Password Reset"]}),e.jsxs("button",{type:"button",onClick:w,disabled:j,className:"flex-1 px-4 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg hover:bg-red-100 font-medium text-sm flex items-center justify-center gap-2 transition-colors",children:[j?e.jsx(N,{size:16,className:"animate-spin"}):e.jsx(E,{size:16}),"Delete User"]})]})]})]})}function W({membership:a,companyName:d,onUpdate:c,onRemove:n}){const[l,m]=r.useState(a.role),[g,t]=r.useState(!1),[x,u]=r.useState(!1),h=async i=>{const b=i.target.value;t(!0);try{await H(a.id,b),m(b),c()}catch(y){console.error("Error updating role:",y),i.target.value=l}finally{t(!1)}},p=async()=>{u(!0);try{await I(a.id),n(),c()}catch(i){console.error("Error removing membership:",i),u(!1)}};return e.jsxs("div",{className:"flex items-center justify-between gap-3 p-3 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{children:e.jsx("strong",{className:"font-medium text-gray-800",children:d})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"w-full p-2 border border-gray-300 rounded-lg bg-white",value:l,onChange:h,disabled:g||x,children:[e.jsx("option",{value:"hr_user",children:"HR User"}),e.jsx("option",{value:"company_admin",children:"Company Admin"})]}),e.jsx("button",{className:"p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm disabled:opacity-50",onClick:p,disabled:g||x,title:"Remove Membership",children:x?e.jsx("div",{className:"w-5 h-5 border-2 border-red-300 border-t-red-600 rounded-full animate-spin"}):e.jsx(E,{size:18})})]})]})}function X({userId:a,allCompaniesMap:d,onDataUpdate:c}){const[n,l]=r.useState([]),[m,g]=r.useState(!0),[t,x]=r.useState(""),[u,h]=r.useState("hr_user"),[p,i]=r.useState(""),b=async()=>{g(!0);try{const f=(await T(a)).docs.map(w=>({id:w.id,...w.data()}));l(f)}catch(s){console.error("Error rendering user memberships:",s)}g(!1)};r.useEffect(()=>{b()},[a]);const y=r.useMemo(()=>new Set(n.map(s=>s.companyId)),[n]),j=r.useMemo(()=>Array.from(d.entries()).filter(([s])=>!y.has(s)),[d,y]),v=async s=>{if(s.preventDefault(),i(""),!t||!u){i("Please select a company and role.");return}try{await $({userId:a,companyId:t,role:u}),x(""),h("hr_user"),await b(),c()}catch(f){i(f.message)}};return e.jsxs("div",{className:"bg-white p-5 rounded-lg border border-gray-200 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-3",children:"Company Memberships"}),e.jsx("div",{id:"edit-user-memberships-list",className:"space-y-3 mb-4 max-h-48 overflow-y-auto p-1",children:m?e.jsx("p",{className:"text-center text-gray-500 py-4",children:"Loading memberships..."}):n.length>0?n.map(s=>e.jsx(W,{membership:s,companyName:d.get(s.companyId)||"Unknown Company",onUpdate:c,onRemove:b},s.id)):e.jsx("p",{className:"text-gray-500 italic text-center p-4",children:"This user has no company memberships."})}),e.jsxs("form",{id:"add-membership-form",className:"flex items-end gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200",onSubmit:v,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:"add-membership-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Add to Company"}),e.jsxs("select",{id:"add-membership-company",className:"w-full p-3 border border-gray-300 rounded-lg bg-white",required:!0,value:t,onChange:s=>x(s.target.value),disabled:j.length===0,children:[e.jsx("option",{value:"",children:"Select a company"}),j.map(([s,f])=>e.jsx("option",{value:s,children:f},s))]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:"add-membership-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"As Role"}),e.jsxs("select",{id:"add-membership-role",className:"w-full p-3 border border-gray-300 rounded-lg bg-white",required:!0,value:u,onChange:s=>h(s.target.value),children:[e.jsx("option",{value:"hr_user",children:"HR User"}),e.jsx("option",{value:"company_admin",children:"Company Admin"})]})]}),e.jsx("button",{type:"submit",className:"px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-all shadow-md",disabled:j.length===0,children:e.jsx(B,{size:20})})]}),p&&e.jsx("p",{className:"text-sm text-red-600 mt-2",children:p})]})}function ee({userId:a,companyId:d,allCompaniesMap:c,onClose:n,onSave:l}){const[m,g]=r.useState(!0),[t,x]=r.useState(null),u=async()=>{g(!0);try{const h=await P(z(_,"users",a));h.exists()&&x(h.data())}catch(h){console.error("Error fetching user data for modal:",h)}g(!1)};return r.useEffect(()=>{u()},[a]),e.jsx("div",{id:"edit-user-modal",className:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-200",children:[e.jsxs("header",{className:"p-5 border-b border-gray-200 flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Edit User"}),e.jsx("button",{className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full",onClick:n,children:e.jsx(F,{size:20})})]}),m||!t?e.jsx("div",{className:"p-6 text-center text-gray-500",children:"Loading user data..."}):e.jsxs("div",{className:"p-5 overflow-y-auto space-y-6 bg-gray-50",children:[e.jsx(V,{userId:a,initialName:t.name,email:t.email,companyId:d||Object.keys(c||{})[0]||null,onSave:l}),e.jsx(X,{userId:a,allCompaniesMap:c,onDataUpdate:l})]}),e.jsx("footer",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-end items-center rounded-b-xl",children:e.jsx("button",{id:"edit-user-close-btn",className:"px-5 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-all",onClick:n,children:"Close"})})]})})}export{ee as E,Z as u};
