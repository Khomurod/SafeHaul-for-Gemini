import{d as w,a as d,g as E,q as b,b as $,w as h,e as g,f as A,h as P,r as R,s as I,u as k,i as x,j as y,k as j,l as N,m as T,n as _,o as M,p as Q,t as z,v as O,x as q}from"./index-Eut2KIY5.js";import{g as B,a as F}from"./applicationId-D0tBiTrd.js";async function L(e,t,o,i=null){if(!e||!t)throw new Error("Missing ID");const r=e==="general-leads"?w(d,"leads",t):w(d,"companies",e,"applications",t),a={status:o,"offerDetails.response":o,"offerDetails.respondedAt":new Date().toISOString(),offerResponseDate:q()};return i&&(a["offerDetails.signature"]=i),await O(r,a),!0}async function U(e){try{const t=w(d,"drivers",e),o=await E(t);return o.exists()?o.data():null}catch(t){return console.error("Error fetching profile:",t),null}}async function C(e,t){if(!e&&!t)return[];const o=[],i=new Set,r=(a,s=!1)=>{a.docs.forEach(n=>{if(i.has(n.id))return;i.add(n.id);const c=n.data(),l=s?"general-leads":n.ref.parent.parent?n.ref.parent.parent.id:"unknown";o.push({id:`${n.id}_${l}`,originalId:n.id,companyId:l,companyName:s?"SafeHaul General Pool":c.companyName||"Unknown Company",isGeneral:s,...c})})};try{if(t){const a=b($(d,"applications"),h("driverId","==",t)),s=await g(a);r(s,!1)}if(e){const a=b($(d,"applications"),h("email","==",e)),s=await g(a);r(s,!1)}}catch(a){console.error("Error fetching company applications:",a)}try{if(t){const a=w(d,"leads",t),s=await E(a);s.exists()&&r({docs:[s]},!0)}if(e){const a=b(A(d,"leads"),h("email","==",e)),s=await g(a);r(s,!0)}}catch(a){console.warn("Error fetching leads:",a)}return o.sort((a,s)=>{const n=c=>c.submittedAt?.seconds?c.submittedAt.seconds:c.createdAt?.seconds?c.createdAt.seconds:0;return n(s)-n(a)})}async function H(e){if(!e)return[];try{const t=A(d,"companies"),o=b(t,h(`hiringPreferences.${e}`,"==",!0));return(await g(o)).docs.map(r=>({id:r.id,...r.data()}))}catch(t){return console.error("Error finding jobs:",t),[]}}async function V(e){if(!e)return[];try{const t=A(d,"drivers",e,"saved_jobs"),i=(await g(t)).docs.map(s=>s.id);if(i.length===0)return[];const r=[];for(let s=0;s<i.length;s+=10)r.push(i.slice(s,s+10));let a=[];for(const s of r){const n=b(A(d,"companies"),h(P(),"in",s)),l=(await g(n)).docs.map(p=>({id:p.id,...p.data()}));a=[...a,...l]}return a}catch(t){return console.error("Error fetching saved jobs:",t),[]}}async function Z(e,t,o,i){if(!i)return null;if(i.size>20*1024*1024)throw new Error("File exceeds 20MB limit.");const r=e?`companies/${e}/applications/${t}`:`global_leads/${t}`;let a=i.name.replace(/[^a-zA-Z0-9.-]/g,"_");if(a.length>64){const l=a.split("."),p=l.pop();a=`${l.join(".").substring(0,64-p.length-1)}.${p}`}const s=`${r}/${o}/${Date.now()}_${a}`,n=R(I,s);let c;for(let l=1;l<=3;l++)try{await k(n,i);const p=await x(n);return{name:i.name,url:p,storagePath:s,uploadedAt:new Date().toISOString()}}catch(p){console.warn(`Upload attempt ${l} failed:`,p),c=p,l<3&&await new Promise(u=>setTimeout(u,1e3))}throw new Error(`Upload failed after 3 attempts: ${c?.message}`)}function v(e){if(e===void 0||e===null)return null;if(e instanceof Date)return e;if(Array.isArray(e))return e.map(v);if(typeof e=="object"){const t={};for(const o in e)t[o]=v(e[o]);return t}return e}async function K(e,t,o,i){const r=t.email||e?.email||"",a=t.phone||"",s=o||"general-leads";y({category:"submission",message:"Application submission started",data:{companyId:s,hasEmail:!!r,hasPhone:!!a},level:"info"});let n;try{n=await B(s,r,a)}catch(f){console.warn("[submitDriverApplication] ID generation failed, using UID:",f),n=e.uid}const c=F(),l=q(),p=v({...t,signature:t.signature,signatureType:t.signatureType||"drawn",userId:e.uid,driverId:e.uid,email:r,phone:a,status:"New Application",submittedAt:l,createdAt:l,sourceType:o?"Company App":"Global Pool",companyId:s,jobId:i?.id||null,jobTitle:i?.title||null,applicationId:n,confirmationNumber:c,lifecycle:{status:"pending",submittedAt:new Date().toISOString(),clientVersion:"2.0-bulletproof"}});let u=null;if(j())try{await N(),u=await T(p,s,{type:"authenticated",userId:e.uid}),console.log(`[submitDriverApplication] Queued submission ${u}`),y({category:"submission",message:"Submission queued",data:{queueId:u,applicationId:n},level:"info"})}catch(f){console.warn("[submitDriverApplication] Queue failed, proceeding directly:",f),_("Submission queue unavailable","warning")}let D;for(let f=1;f<=3;f++)try{let m;if(o?m=w(d,"companies",o,"applications",n):m=w(d,"leads",n),await M(m,p),u)try{await Q(u),console.log(`[submitDriverApplication] Dequeued ${u} after success`)}catch(S){console.warn("[submitDriverApplication] Dequeue failed:",S)}return y({category:"submission",message:"Application submitted successfully",data:{applicationId:n,confirmationNumber:c,attempts:f},level:"info"}),{success:!0,applicationId:n,confirmationNumber:c,queueId:u}}catch(m){console.warn(`[submitDriverApplication] Attempt ${f} failed:`,m),D=m,y({category:"submission",message:`Attempt ${f} failed`,data:{error:m.message},level:"warning"}),f<3&&await new Promise(S=>setTimeout(S,1e3*Math.pow(2,f-1)))}if(z(D,{tags:{flow:"driver_application",stage:"submission_failed"},extra:{applicationId:n,companyId:s,queueId:u,attempts:3}}),u)return console.log(`[submitDriverApplication] All attempts failed, but data is queued: ${u}`),{success:!1,queued:!0,applicationId:n,confirmationNumber:c,queueId:u,error:"Submission failed but your application is saved. It will be automatically submitted when connection is restored."};throw new Error(`Submission failed after 3 attempts: ${D?.message}`)}export{C as a,H as b,U as f,V as g,L as r,K as s,Z as u};
