import{y as q,z as I,C as n,D as e,L as N,T as R,G as b,R as V,X as G,H as S,I as k}from"./index-Eut2KIY5.js";import{i as U,c as W,a as B,g as O}from"./signature-CKsXCBTr.js";import{D as H,P as K}from"./index-Dyi1V6Cy.js";import{c as M}from"./confetti.module-oQXWb4Lk.js";import{P as X}from"./pen-tool-CnWi3ktp.js";import{G as Y}from"./pdfjs-CN6VhWT3.js";import"./clsx-B-dksMZM.js";Y.workerSrc=new URL("/assets/pdf.worker.min-qwK7q_zL.mjs",import.meta.url).toString();function re(){const{companyId:g,requestId:h}=q(),[C]=I(),d=C.get("token"),[i,P]=n.useState(null),[z,p]=n.useState(!0),[f,y]=n.useState(""),[E,D]=n.useState(null),[o,j]=n.useState({}),[u,m]=n.useState(null),[w,v]=n.useState(!1),[F,L]=n.useState(!1);n.useEffect(()=>{async function s(){if(!d){y("Invalid Link: No access token provided."),p(!1);return}try{const c=(await S(k,"getPublicEnvelope")({companyId:g,requestId:h,accessToken:d})).data;if(P(c),c.fields){const l={};c.fields.forEach(r=>{l[r.id]=r.type==="checkbox"?!1:""}),j(l)}}catch(t){console.error("Load Error:",t),y("Document not found or link expired.")}finally{p(!1)}}s()},[g,h,d]),n.useEffect(()=>{u&&setTimeout(U,100)},[u]);const x=(s,t)=>{j(a=>({...a,[s]:t}))},A=async()=>{if(B())return alert("Please sign first.");const s=O();x(u,s),m(null)},T=async()=>{const s=i.fields?.filter(t=>t.required&&!o[t.id])||[];if(s.length>0){alert(`Please complete all required fields. (${s.length} remaining)`);return}v(!0);try{const t={ip:"127.0.0.1",userAgent:navigator.userAgent,timestamp:new Date().toISOString()};await S(k,"submitPublicEnvelope")({companyId:g,requestId:h,accessToken:d,fieldValues:o,auditData:t}),L(!0),M({particleCount:150,spread:70,origin:{y:.6}})}catch(t){console.error("Submission Error:",t),alert("Error saving document: "+t.message)}finally{v(!1)}};if(z)return e.jsxs("div",{className:"h-screen flex items-center justify-center bg-gray-50",children:[e.jsx(N,{className:"animate-spin text-blue-600 mb-2",size:40}),e.jsx("p",{className:"text-gray-500 font-medium ml-3",children:"Loading secure document..."})]});if(f)return e.jsx("div",{className:"h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg border border-red-100 text-center max-w-md",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(R,{size:32})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:f})]})});if(F)return e.jsx("div",{className:"h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs("div",{className:"bg-white p-10 rounded-2xl shadow-xl border border-green-100 text-center max-w-md animate-in zoom-in-95 duration-300",children:[e.jsx("div",{className:"w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(b,{size:48})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Document Signed!"}),e.jsxs("p",{className:"text-gray-600 mb-6",children:["Thank you, ",e.jsx("strong",{children:i.recipientName}),". The document has been securely sealed and sent to the sender."]}),e.jsx("button",{onClick:()=>window.close(),className:"text-blue-600 font-semibold hover:underline",children:"Close Window"})]})});const $=s=>{const t=s.width<100,a=s.width||(t?25:160),c=s.height||(t?5:40),l={left:`${s.xPosition}%`,top:`${s.yPosition}%`,width:`${a}${t?"%":"px"}`,height:`${c}${t?"%":"px"}`,position:"absolute",zIndex:20,transform:"translate(0, 0)"};if(i.status==="signed")return null;switch(s.type){case"text":return e.jsx("input",{style:l,className:"border-2 border-blue-400 bg-blue-50/90 px-2 text-sm rounded",placeholder:"Type here...",value:o[s.id]||"",onChange:r=>x(s.id,r.target.value)});case"date":return e.jsx("input",{type:"date",style:l,className:"border-2 border-green-400 bg-green-50/90 px-2 text-sm rounded",value:o[s.id]||"",onChange:r=>x(s.id,r.target.value)});case"checkbox":return e.jsx("input",{type:"checkbox",style:l,className:"accent-purple-600 cursor-pointer",checked:!!o[s.id],onChange:r=>x(s.id,r.target.checked)});case"signature":{const r=!!o[s.id];return e.jsx("div",{style:l,onClick:()=>m(s.id),className:`cursor-pointer border-2 border-dashed rounded flex items-center justify-center gap-2 shadow-sm transition ${r?"bg-yellow-100 border-yellow-600":"bg-yellow-50/90 border-yellow-400 hover:bg-yellow-100"}`,children:r?e.jsxs("div",{className:"text-yellow-800 font-bold text-xs flex items-center gap-1",children:[e.jsx(b,{size:14})," Signed"]}):e.jsxs("div",{className:"text-yellow-700 font-medium text-xs flex items-center gap-1",children:[e.jsx(X,{size:14})," Sign"]})})}default:return null}};return e.jsxs("div",{className:"min-h-screen bg-gray-100 flex flex-col font-sans",children:[e.jsxs("header",{className:"bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-30",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-gray-800",children:i?.title||"Document"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Recipient: ",i?.recipientEmail]})]}),e.jsxs("button",{onClick:T,disabled:w,className:"px-6 py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 transition flex items-center gap-2 disabled:opacity-50",children:[w?e.jsx(N,{className:"animate-spin",size:16}):e.jsx(b,{size:16}),"Finish & Submit"]})]}),e.jsx("main",{className:"flex-1 overflow-y-auto p-8 flex justify-center bg-gray-200/50",children:e.jsx(H,{file:i.pdfUrl,onLoadSuccess:({numPages:s})=>D(s),className:"flex flex-col gap-6",children:Array.from(new Array(E),(s,t)=>e.jsxs("div",{className:"relative shadow-xl border border-gray-300 bg-white inline-block",children:[e.jsx(K,{pageNumber:t+1,width:Math.min(window.innerWidth-40,800),renderAnnotationLayer:!1,renderTextLayer:!1}),i?.fields?.filter(a=>a.pageNumber===t+1).map(a=>e.jsx(V.Fragment,{children:$(a)},a.id))]},t))})}),u&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden animate-in zoom-in duration-200",children:[e.jsxs("div",{className:"bg-gray-50 p-4 border-b flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-gray-700",children:"Draw Your Signature"}),e.jsx("button",{onClick:()=>m(null),children:e.jsx(G,{size:20})})]}),e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded bg-white mb-4 relative",children:[e.jsx("canvas",{id:"signature-canvas",className:"w-full h-40 touch-none cursor-crosshair"}),e.jsx("button",{id:"clear-signature",onClick:W,className:"absolute bottom-2 right-2 text-xs text-red-500 bg-white border border-gray-200 px-2 py-1 rounded",children:"Clear"})]}),e.jsx("p",{className:"text-xs text-gray-400",children:'By clicking "Adopt", I agree this is my legal signature.'})]}),e.jsxs("div",{className:"p-4 bg-gray-50 flex justify-end gap-2 border-t",children:[e.jsx("button",{onClick:()=>m(null),className:"px-4 py-2 text-gray-600 font-medium",children:"Cancel"}),e.jsx("button",{onClick:A,className:"px-6 py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700",children:"Adopt Signature"})]})]})})]})}export{re as default};
