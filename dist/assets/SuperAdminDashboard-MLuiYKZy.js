import{c as xe,B as Ce,C as n,q as Z,f as Y,a as k,af as Ne,V as pe,b as Ee,e as W,aF as Ke,w as se,aG as Je,D as e,aB as ye,W as Ns,a1 as we,F as zs,aA as Re,X as Se,L as O,Z as Qe,a5 as Ms,aj as de,aH as vs,aa as os,d as $,T as De,o as ee,aI as _s,ah as Ae,G as ge,E as ts,aJ as ws,a7 as Cs,g as be,v as cs,a8 as $e,ag as as,x as me,aK as $s,aE as Xe,av as Fs,a4 as Ve,aL as Us,H as B,I as H,as as Oe,a2 as he,ai as us,r as Te,s as ze,i as qs,P as ps,aM as gs,U as Le,R as Bs,az as Hs,ac as Os,S as Ss,aN as Gs,a3 as Qs}from"./index-Eut2KIY5.js";import{b as ks,B as We,A as Fe,P as rs,S as Ds,T as Ye,C as Vs,E as Ws}from"./CustomQuestionsBuilder-C9bbau8M.js";import{D as fe,B as Ys,W as Zs,R as As}from"./BulkUploadLayout-DCFrYteR.js";import{F as je}from"./file-text-fIi5thw4.js";import{P as ns}from"./plus-DHyG1REA.js";import{T as Ie}from"./trash-2-RTc4kdO5.js";import{P as Ge}from"./pen-DKw8HDfG.js";import{S as Ks}from"./shield-alert-CyrU0uX3.js";import{S as ds}from"./save-xDZOd2sT.js";import{a as Ls,S as Ps}from"./shield-B8dSCmK2.js";import{u as Js}from"./useBulkImport-DleduGt8.js";import{E as Xs,l as et,A as st}from"./index-BbXgOzvQ.js";import{S as tt}from"./send-DbngQNm2.js";import{U as at}from"./upload-CeDmLZPo.js";import{D as rt}from"./external-link-DG7NPcwU.js";import{u as nt}from"./storage-gYyq0gBL.js";import{b as lt}from"./credit-card-DXG0d7j1.js";import"./pdfjs-CN6VhWT3.js";import"./circle-BoyhTIEe.js";import"./file-pen-line-CZApjMvZ.js";import"./user-check-BzH4u_-N.js";import"./dollar-sign-DE8xXdSp.js";const it=[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]],ot=xe("arrow-up-right",it);const ct=[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]],Rs=xe("crown",ct);const dt=[["line",{x1:"22",x2:"2",y1:"12",y2:"12",key:"1y58io"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16",key:"sgf278"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16",key:"1l4acy"}]],mt=xe("hard-drive",dt);const xt=[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]],ls=xe("key",xt);const ut=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],Is=xe("layers",ut);const pt=[["rect",{width:"7",height:"9",x:"3",y:"3",rx:"1",key:"10lvy0"}],["rect",{width:"7",height:"5",x:"14",y:"3",rx:"1",key:"16une8"}],["rect",{width:"7",height:"9",x:"14",y:"12",rx:"1",key:"1hutg5"}],["rect",{width:"7",height:"5",x:"3",y:"16",rx:"1",key:"ldoo1y"}]],gt=xe("layout-dashboard",pt);const ht=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],is=xe("lock-open",ht);const bt=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Pe=xe("play",bt);const ft=[["path",{d:"M12 22v-5",key:"1ega77"}],["path",{d:"M9 8V2",key:"14iosj"}],["path",{d:"M15 8V2",key:"18g5xt"}],["path",{d:"M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z",key:"osxo6l"}]],yt=xe("plug",ft);const jt=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Nt=xe("share-2",jt);const vt=[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]],wt=xe("tag",vt);const Ct=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],St=xe("terminal",Ct);const kt=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],Es=xe("trending-down",kt);function Dt(){const{showError:s}=Ce(),[r,a]=n.useState([]),[l,m]=n.useState([]),[p,j]=n.useState([]),[u,i]=n.useState(new Map),[h,b]=n.useState(!0),[L,N]=n.useState(!1),[v,g]=n.useState(null),[o,y]=n.useState(null),[w,x]=n.useState(null),[S,D]=n.useState(!0),[P,f]=n.useState(!0),[M,t]=n.useState({companies:!1,users:!1,apps:!1}),[d,c]=n.useState({companyCount:0,userCount:0,appCount:0}),[C,R]=n.useState(""),A=n.useCallback(async()=>{b(!0),t({companies:!1,users:!1,apps:!1}),console.log("ðŸš€ Fetching initial dashboard data (Paginated)...");const z=async(I,K,V=[])=>{try{return{success:!0,data:await I}}catch(q){return console.error(`âŒ Error fetching ${K}:`,q),{success:!1,error:q,data:V}}};try{const I=Z(Y(k,"companies"),Ne("createdAt","desc"),pe(20)),K=Z(Y(k,"users"),Ne("createdAt","desc"),pe(50)),V=Z(Ee(k,"leads"),Ne("createdAt","desc"),pe(15)),q=Z(Ee(k,"applications"),Ne("createdAt","desc"),pe(15)),[te,ne,le,G,T,_,ie]=await Promise.all([z(W(I),"Companies"),z(W(K),"Users"),z(W(V),"Leads"),z(W(q),"Applications"),z(Ke(Y(k,"companies")),"Count Companies",{data:()=>({count:0})}),z(Ke(Y(k,"users")),"Count Users",{data:()=>({count:0})}),z(Ke(Ee(k,"leads")),"Count Leads",{data:()=>({count:0})})]);if(t({companies:!te.success,users:!ne.success,apps:!le.success&&!G.success}),te.success){const re=[],J=new Map;J.set("general-leads","SafeHaul Pool (Unassigned)"),te.data.forEach(X=>{const oe=X.data();re.push({id:X.id,...oe}),J.set(X.id,oe.companyName)}),a(re),i(J),g(te.data.docs[te.data.docs.length-1]),D(te.data.docs.length===20)}if(ne.success){const re=ne.data.docs.map(F=>({id:F.id,...F.data()})),J=re.map(F=>F.id),X=new Map;if(J.length>0)try{const F=[];for(let Q=0;Q<J.length;Q+=10)F.push(J.slice(Q,Q+10));await Promise.all(F.map(async Q=>{const Ue=Z(Y(k,"memberships"),se("userId","in",Q));(await W(Ue)).forEach(Ts=>{const Ze=Ts.data(),xs=X.get(Ze.userId)||[];xs.push(Ze),X.set(Ze.userId,xs)})}))}catch(F){console.error("âš ï¸ Error fetching memberships:",F)}const oe=re.map(F=>({...F,memberships:X.get(F.id)||[]}));m(oe)}let ue=[];if(le.success){const re=le.data.docs.map(J=>{const X=J.data();let oe="general-leads";try{const Q=J.ref.parent.parent;Q&&(oe=Q.id)}catch{}return{id:J.id,...X,companyId:oe,status:X.status||"New Lead",sourceType:X.isPlatformLead?"Distributed Lead":"Direct Lead"}});ue=[...ue,...re],x(le.data.docs[le.data.docs.length-1])}if(G.success){const re=G.data.docs.map(J=>{const X=J.data();let oe=X.companyId||"unknown";try{const F=J.ref.parent.parent;F&&(oe=F.id)}catch{}return{id:J.id,...X,companyId:oe,status:X.status||"New Application",sourceType:"Company App"}});ue=[...ue,...re],y(G.data.docs[G.data.docs.length-1])}ue.sort((re,J)=>{const X=re.createdAt?.seconds||0;return(J.createdAt?.seconds||0)-X}),j(ue),f(le.success&&le.data.docs.length===15||G.success&&G.data.docs.length===15),c({companyCount:T.success?T.data.data().count:0,userCount:_.success?_.data.data().count:0,appCount:ie.success?ie.data.data().count:0})}catch(I){console.error("ðŸ”¥ Fatal Error loading recent data:",I),t({companies:!0,users:!0,apps:!0}),s("Failed to load dashboard data.")}finally{b(!1)}},[s]),E=n.useCallback(async z=>{if(!(z==="companies"&&(!v||!S))&&!(z==="applications"&&!o&&!w&&!P)){console.log(`ðŸ“¡ Loading more ${z}...`);try{if(z==="companies"){const I=Z(Y(k,"companies"),Ne("createdAt","desc"),Je(v),pe(20)),K=await W(I);if(K.empty){D(!1);return}const V=K.docs.map(q=>({id:q.id,...q.data()}));a(q=>[...q,...V]),g(K.docs[K.docs.length-1]),D(K.docs.length===20),i(q=>{const te=new Map(q);return V.forEach(ne=>te.set(ne.id,ne.companyName)),te})}else if(z==="applications"){const I=w?W(Z(Ee(k,"leads"),Ne("createdAt","desc"),Je(w),pe(15))):Promise.resolve({docs:[]}),K=o?W(Z(Ee(k,"applications"),Ne("createdAt","desc"),Je(o),pe(15))):Promise.resolve({docs:[]}),[V,q]=await Promise.all([I,K]);if(V.docs.length===0&&q.docs.length===0){f(!1);return}const te=V.docs.map(G=>{const T=G.data(),_=G.ref.parent.parent;return{id:G.id,...T,companyId:_?_.id:"general-leads",status:T.status||"New Lead",sourceType:T.isPlatformLead?"Distributed Lead":"Direct Lead"}}),ne=q.docs.map(G=>{const T=G.data(),_=G.ref.parent.parent;return{id:G.id,...T,companyId:_?_.id:T.companyId||"unknown",status:T.status||"New Application",sourceType:"Company App"}}),le=[...te,...ne].sort((G,T)=>{const _=G.createdAt?.seconds||0;return(T.createdAt?.seconds||0)-_});j(G=>[...G,...le]),V.docs.length>0&&x(V.docs[V.docs.length-1]),q.docs.length>0&&y(q.docs[q.docs.length-1]),f(V.docs.length===15||q.docs.length===15)}}catch(I){console.error(`Error loading more ${z}:`,I),s(`Failed to load more ${z}.`)}}},[v,o,w,S,P,s]),U=n.useCallback(async z=>{N(!0),b(!0),console.log(`ðŸ” Performing Client Search for: "${z}"`);try{const I=z,K=z+"ï£¿",V=Z(Y(k,"companies"),se("companyName",">=",I),se("companyName","<=",K),pe(20)),q=Z(Y(k,"users"),se("name",">=",I),se("name","<=",K),pe(20)),te=Z(Y(k,"leads"),se("searchName",">=",I.toLowerCase()),se("searchName","<=",I.toLowerCase()+"ï£¿"),pe(20)),[ne,le,G]=await Promise.all([W(V),W(q),W(te)]);a(ne.docs.map(_=>({id:_.id,..._.data()}))),m(le.docs.map(_=>({id:_.id,..._.data()})));const T=G.docs.map(_=>{const ie=_.data();return{id:_.id,...ie,companyId:ie.companyId||"unknown",sourceType:"Search Result",createdAt:ie.createdAt||{seconds:Date.now()/1e3}}});j(T)}catch(I){console.error("Search failed:",I),s("Search failed. Please try again.")}finally{b(!1),N(!1)}},[s]);return n.useEffect(()=>{const z=setTimeout(()=>{C&&C.trim().length>=2?U(C):C.trim().length===0&&A()},600);return()=>clearTimeout(z)},[C,A,U]),{companyList:r,userList:l,allApplications:p,allCompaniesMap:u,stats:d,loading:h,statsError:M,searchQuery:C,setSearchQuery:R,loadMore:E,hasMoreCompanies:S,hasMoreApps:P,searchResults:{companies:r,users:l,applications:p},totalSearchResults:r.length+l.length+p.length,refreshData:A}}function ce({label:s,icon:r,isActive:a,onClick:l}){return e.jsxs("button",{onClick:l,className:`
        flex items-center gap-3 w-full px-4 py-3 rounded-lg text-left font-medium
        ${a?"bg-blue-600 text-white shadow-md":"text-gray-700 hover:bg-gray-100"}
        transition-all
      `,children:[r,s]})}function At({activeView:s,setActiveView:r,isSearching:a,onClearSearch:l}){const m=p=>{r(p),l&&l()};return e.jsxs("nav",{className:"w-full sm:w-64 shrink-0 bg-white p-4 rounded-xl shadow-lg border border-gray-200 space-y-2 sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar",children:[e.jsx(ce,{label:"Dashboard",icon:e.jsx(gt,{size:20}),isActive:s==="dashboard"&&!a,onClick:()=>m("dashboard")}),e.jsx(ce,{label:"Analytics",icon:e.jsx(ks,{size:20}),isActive:s==="analytics"&&!a,onClick:()=>m("analytics")}),e.jsx(ce,{label:"Lead Pool",icon:e.jsx(fe,{size:20}),isActive:s==="lead-pool"&&!a,onClick:()=>m("lead-pool")}),e.jsx("div",{className:"my-2 border-t border-gray-100"}),e.jsx(ce,{label:"Companies",icon:e.jsx(We,{size:20}),isActive:s==="companies"&&!a,onClick:()=>m("companies")}),e.jsx(ce,{label:"Users",icon:e.jsx(ye,{size:20}),isActive:s==="users"&&!a,onClick:()=>m("users")}),e.jsx(ce,{label:"Unified Driver DB",icon:e.jsx(je,{size:20}),isActive:s==="applications"&&!a,onClick:()=>m("applications")}),e.jsx("div",{className:"my-2 border-t border-gray-100"}),e.jsx(ce,{label:"Global Features",icon:e.jsx(Is,{size:20}),isActive:s==="features"&&!a,onClick:()=>m("features")}),e.jsx(ce,{label:"SMS Integrations",icon:e.jsx(Ns,{size:20}),isActive:s==="integrations"&&!a,onClick:()=>m("integrations")}),e.jsx(ce,{label:"Form Builder",icon:e.jsx(je,{size:20}),isActive:s==="questions"&&!a,onClick:()=>m("questions")}),e.jsx(ce,{label:"System Health",icon:e.jsx(Fe,{size:20}),isActive:s==="system-health"&&!a,onClick:()=>m("system-health")}),e.jsx(ce,{label:"Stats Backfill",icon:e.jsx(we,{size:20}),isActive:s==="stats-backfill"&&!a,onClick:()=>m("stats-backfill")}),e.jsx("div",{className:"my-2 border-t border-gray-100"}),e.jsx(ce,{label:"Bulk Lead Adding",icon:e.jsx(fe,{size:20}),isActive:s==="bulk-lead-adding"&&!a,onClick:()=>m("bulk-lead-adding")}),e.jsx(ce,{label:"Create New",icon:e.jsx(ns,{size:20}),isActive:s==="create"&&!a,onClick:()=>m("create")})]})}function Lt({searchQuery:s,setSearchQuery:r,onDistribute:a,distributing:l,onFixData:m,fixingData:p,onCleanup:j,cleaning:u,onLogout:i}){return e.jsx("header",{className:"sticky top-0 z-10 bg-white shadow-md border-b border-gray-200",children:e.jsxs("div",{className:"container mx-auto p-4 flex justify-between items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-600 rounded-lg text-white",children:e.jsx(zs,{size:24})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Super Admin"})]}),e.jsxs("div",{className:"relative flex-1 max-w-xl",children:[e.jsx("input",{type:"text",placeholder:"Global Search...",className:"w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all",value:s,onChange:h=>r(h.target.value)}),e.jsx(Re,{size:20,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),s&&e.jsx("button",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",onClick:()=>r(""),children:e.jsx(Se,{size:20})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:j,disabled:u,className:`flex items-center gap-2 px-4 py-2 text-white text-sm font-bold rounded-lg shadow-sm transition-colors ${u?"bg-red-300 cursor-not-allowed":"bg-red-600 hover:bg-red-700"}`,title:"Delete 'Unknown Driver' and placeholder records",children:[u?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(Ie,{size:16}),u?"Purging...":"Purge Trash"]}),e.jsxs("button",{onClick:m,disabled:p,className:`flex items-center gap-2 px-4 py-2 text-white text-sm font-bold rounded-lg shadow-sm transition-colors ${p?"bg-gray-400 cursor-not-allowed":"bg-gray-700 hover:bg-gray-800"}`,title:"Migrate Drivers to Leads",children:[p?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(fe,{size:16,className:"text-yellow-400"}),p?"Migrating...":"Fix Data"]}),e.jsxs("button",{onClick:a,disabled:l,className:`flex items-center gap-2 px-4 py-2 text-white text-sm font-bold rounded-lg shadow-sm transition-colors ${l?"bg-purple-400 cursor-not-allowed":"bg-purple-600 hover:bg-purple-700"}`,children:[l?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(Qe,{size:16}),l?"Distributing...":"Distribute Leads"]})]}),e.jsxs("button",{id:"logout-button-super",className:"px-3 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-all flex items-center gap-2 ml-2",onClick:i,children:[e.jsx(Ms,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Logout"})]})]})})}function Pt({results:s,totalResults:r,allCompaniesMap:a,onViewApps:l,onEditCompany:m,onEditUser:p,onAppClick:j}){const{companies:u,users:i,applications:h}=s;return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900",children:["Search Results ",e.jsxs("span",{className:"text-gray-400 font-normal",children:["(",r," found)"]})]}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(We,{size:20})," Companies (",u.length,")"]}),e.jsx("div",{className:"space-y-4",children:u.length>0?u.map(b=>e.jsxs("div",{className:"p-4 border border-gray-200 rounded-lg bg-white flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"mb-3 sm:mb-0",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:de(b.companyName)}),e.jsxs("p",{className:"text-sm text-gray-600",children:["/",de(b.appSlug)]})]}),e.jsxs("div",{className:"flex gap-2 justify-end shrink-0",children:[e.jsxs("button",{onClick:()=>l({id:b.id,name:b.companyName}),className:"px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-all flex items-center gap-2",children:[e.jsx(je,{size:14})," View Apps"]}),e.jsxs("button",{onClick:()=>m(b.id),className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-all flex items-center gap-2",children:[e.jsx(Ge,{size:14})," Edit"]})]})]},b.id)):e.jsx("p",{className:"text-gray-500 p-4 bg-white rounded-lg border",children:"No companies found."})})]}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(ye,{size:20})," Users (",i.length,")"]}),e.jsx("div",{className:"space-y-4",children:i.length>0?i.map(b=>e.jsxs("div",{className:"p-4 border border-gray-200 rounded-lg bg-white flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"mb-3 sm:mb-0",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:de(b.name)}),e.jsx("p",{className:"text-sm text-gray-600",children:de(b.email)})]}),e.jsx("div",{className:"flex gap-2 justify-end shrink-0",children:e.jsxs("button",{onClick:()=>p({id:b.id}),className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-all flex items-center gap-2",children:[e.jsx(Ge,{size:14})," Edit"]})})]},b.id)):e.jsx("p",{className:"text-gray-500 p-4 bg-white rounded-lg border",children:"No users found."})})]}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(je,{size:20})," Driver Applications (",h.length,")"]}),e.jsx("div",{className:"space-y-4",children:h.length>0?h.map(b=>e.jsxs("button",{className:"w-full p-4 border border-gray-200 rounded-lg bg-white flex flex-col sm:flex-row sm:items-center sm:justify-between text-left hover:border-blue-500 hover:shadow-md transition-all",onClick:()=>j(b),children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:`${de(b.firstName)} ${de(b.lastName)}`}),e.jsx("p",{className:"text-sm text-gray-600",children:de(b.email)}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["From: ",e.jsx("span",{className:"font-medium text-gray-700",children:a.get(b.companyId)||"Unknown Company"})]})]}),e.jsx("span",{className:`px-3 py-1 text-xs font-semibold rounded-full ${vs(b.status||"New Application")}`,children:b.status||"New Application"})]},b.id)):e.jsx("p",{className:"text-gray-500 p-4 bg-white rounded-lg border",children:"No driver applications found."})})]})]})}function Rt(){const[s,r]=n.useState({quota_paid:200,quota_free:50,maintenance_mode:!1}),[a,l]=n.useState(!1),[m,p]=n.useState(null);n.useEffect(()=>{const u=os($(k,"system_settings","distribution"),i=>{i.exists()&&r(i.data())});return()=>u()},[]);const j=async()=>{l(!0);try{await ee($(k,"system_settings","distribution"),{quota_paid:Number(s.quota_paid),quota_free:Number(s.quota_free),maintenance_mode:s.maintenance_mode},{merge:!0}),p({type:"success",text:"Configuration updated successfully."})}catch(u){console.error(u),p({type:"error",text:"Failed to update settings."})}l(!1),setTimeout(()=>p(null),3e3)};return e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Ks,{className:"text-gray-500",size:20}),"Distribution Logic"]}),s.maintenance_mode&&e.jsxs("span",{className:"px-3 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full flex items-center gap-1",children:[e.jsx(De,{size:12})," MAINTENANCE MODE"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Paid Plan Quota"}),e.jsx("input",{type:"number",value:s.quota_paid,onChange:u=>r({...s,quota_paid:u.target.value}),className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leads per day for Paid companies"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Free Plan Quota"}),e.jsx("input",{type:"number",value:s.quota_free,onChange:u=>r({...s,quota_free:u.target.value}),className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leads per day for Free companies"})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-800",children:"Maintenance Mode"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Pause all distribution immediately."})]}),e.jsx("button",{onClick:()=>r({...s,maintenance_mode:!s.maintenance_mode}),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${s.maintenance_mode?"bg-red-600":"bg-gray-300"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${s.maintenance_mode?"translate-x-6":"translate-x-1"}`})})]}),e.jsxs("button",{onClick:j,disabled:a,className:"w-full py-2 bg-slate-900 text-white font-semibold rounded-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2",children:[a?e.jsx(Fe,{className:"animate-spin",size:18}):e.jsx(ds,{size:18}),"Update System Configuration"]}),m&&e.jsx("div",{className:`text-center text-sm font-medium ${m.type==="success"?"text-green-600":"text-red-600"}`,children:m.text})]})}function es({title:s,value:r,icon:a,loading:l,hasError:m}){let p=r;return l&&(p="..."),m&&(p="Error"),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-full ${m?"bg-red-100 text-red-600":"bg-blue-100 text-blue-600"}`,children:a}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:s}),e.jsx("p",{className:`text-3xl font-bold ${m?"text-red-600":"text-gray-900"} ${l?"animate-pulse":""}`,children:p})]})]})}function It({stats:s,statsLoading:r,statsError:a}){return e.jsxs("div",{className:"space-y-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Dashboard"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(es,{title:"Total Companies",value:s.companyCount,icon:e.jsx(We,{size:24}),loading:r,hasError:a.companies}),e.jsx(es,{title:"Total Users",value:s.userCount,icon:e.jsx(ye,{size:24}),loading:r,hasError:a.users}),e.jsx(es,{title:"Total Applications",value:s.appCount,icon:e.jsx(je,{size:24}),loading:r,hasError:a.apps})]}),e.jsx(Rt,{})]})}function Et({title:s,icon:r,children:a,className:l=""}){return e.jsxs("div",{className:`bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col ${l}`,children:[e.jsx("div",{className:"p-5 border-b border-gray-200 shrink-0",children:e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[r,s]})}),a]})}function hs({listLoading:s,statsError:r,companyList:a,onViewApps:l,onEdit:m,onDelete:p,loadMore:j,hasMore:u,isIntegrationMode:i=!1}){const[h,b]=n.useState(""),[L,N]=n.useState(1),[v,g]=n.useState(20),[o,y]=n.useState({}),[w,x]=n.useState(null),S=async(t,d,c,C)=>{t.stopPropagation();const R=C?"deactivate":"activate";if(window.confirm(`${R.toUpperCase()} "${c}"?

${C?"This company will stop receiving platform leads.":"This company will start receiving platform leads."}`)){x(d);try{await cs($(k,"companies",d),{isActive:!C}),y(A=>({...A,[d]:{...A[d],isActive:!C}}))}catch(A){alert(`Failed to ${R} company: ${A.message}`)}finally{x(null)}}};n.useEffect(()=>{if(!i||a.length===0)return;(async()=>{const d={...o};let c=!1;for(const C of a)if(!d[C.id])try{const R=await be($(k,`companies/${C.id}/integrations`,"sms_provider"));if(R.exists()){const A=R.data();d[C.id]={defaultPhoneNumber:A.defaultPhoneNumber||null,smsProvider:A.provider||null},c=!0}else d[C.id]={defaultPhoneNumber:null,smsProvider:null}}catch(R){console.error("Error fetching enrichment for",C.id,R)}c&&y(d)})()},[i,a]);const D=n.useMemo(()=>a.map(t=>({...t,...o[t.id]||{}})),[a,o]),P=n.useMemo(()=>{const t=h.toLowerCase();return t?D.filter(d=>{const c=d.companyName?.toLowerCase()||"",C=d.appSlug?.toLowerCase()||"",R=d.id.toLowerCase();return c.includes(t)||C.includes(t)||R.includes(t)}):D},[h,a]),f=Math.ceil(P.length/v),M=n.useMemo(()=>{const t=(L-1)*v;return P.slice(t,t+v)},[P,L,v]);return n.useEffect(()=>{N(1)},[h,v]),e.jsxs(Et,{title:i?"SMS Integrations Hub":"Manage Companies",icon:i?e.jsx(Ns,{size:20,className:"text-blue-600"}):e.jsx(We,{size:20,className:"text-blue-600"}),className:"h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 bg-white flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0",children:[e.jsx("div",{children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Registered Companies: ",e.jsx("strong",{children:a.length})]})}),e.jsxs("div",{className:"relative w-full sm:w-72",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(Re,{size:16,className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Search companies...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all",value:h,onChange:t=>b(t.target.value)})]})]}),e.jsx("div",{className:"flex-1 overflow-auto min-h-0 bg-gray-50",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200",children:"Company Name"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200",children:"Slug / ID"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200",children:i?"SMS Number":"Plan"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 text-center",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:s?e.jsx("tr",{children:e.jsxs("td",{colSpan:"5",className:"p-10 text-center text-gray-500",children:[e.jsx(_s,{size:"h-10 w-10",className:"mx-auto mb-2"}),"Loading companies..."]})}):r.companies?e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"p-10 text-center text-red-500",children:"Error loading companies."})}):P.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"p-10 text-center text-gray-400",children:"No companies found."})}):M.map(t=>e.jsxs("tr",{onClick:()=>m(i?t:t.id),className:"hover:bg-gray-50 transition-colors cursor-pointer",children:[e.jsx("td",{className:"px-6 py-4 align-middle",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center text-lg font-bold text-gray-500 shrink-0",children:t.companyLogoUrl?e.jsx("img",{src:t.companyLogoUrl,alt:"Logo",className:"w-full h-full object-contain rounded-lg"}):de(t.companyName).charAt(0)}),e.jsx("span",{className:"font-semibold text-gray-900",children:de(t.companyName)})]})}),e.jsx("td",{className:"px-6 py-4 align-middle",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm font-mono text-blue-600 bg-blue-50 px-2 py-0.5 rounded w-fit",children:["/",de(t.appSlug)]}),e.jsx("span",{className:"text-xs text-gray-400 mt-1 font-mono",children:t.id})]})}),e.jsx("td",{className:"px-6 py-4 align-middle",children:i?e.jsxs("div",{className:"flex flex-col",children:[t.defaultPhoneNumber?e.jsxs("span",{className:"text-sm font-bold text-green-700 bg-green-50 px-2 py-0.5 rounded w-fit flex items-center gap-1",children:[e.jsx(Ae,{size:12})," ",t.defaultPhoneNumber]}):e.jsx("span",{className:"text-xs text-gray-400 italic",children:"Not Provisioned"}),t.smsProvider&&e.jsx("span",{className:"text-[10px] text-gray-500 uppercase mt-1 tracking-widest",children:t.smsProvider})]}):t.planType==="paid"?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-200",children:[e.jsx(Rs,{size:12,fill:"currentColor"})," Pro Plan"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600 border border-gray-200",children:[e.jsx(Ls,{size:12})," Free Plan"]})}),e.jsx("td",{className:"px-6 py-4 align-middle text-center",children:e.jsx("button",{onClick:d=>S(d,t.id,t.companyName,t.isActive!==!1),disabled:w===t.id,className:"group",title:`Click to ${t.isActive!==!1?"deactivate":"activate"}`,children:w===t.id?e.jsx("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-100 text-blue-600 text-xs font-semibold",children:e.jsx(O,{size:10,className:"animate-spin"})}):t.isActive!==!1?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-semibold hover:bg-green-200 cursor-pointer",children:[e.jsx(ge,{size:10})," Active"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 text-red-600 text-xs font-semibold hover:bg-red-200 cursor-pointer",children:[e.jsx(ts,{size:10})," Inactive"]})})}),e.jsx("td",{className:"px-6 py-4 align-middle text-right",children:e.jsx("div",{className:"flex justify-end gap-2",children:i?e.jsxs("button",{onClick:()=>m(t),className:"px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2",children:[e.jsx(fe,{size:14})," Manage API"]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>l({id:t.id,name:t.companyName}),className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"View Applications",children:e.jsx(je,{size:18})}),e.jsx("button",{onClick:()=>m(t.id),className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",title:"Edit Company",children:e.jsx(Ge,{size:18})}),e.jsx("button",{onClick:()=>p({id:t.id,name:t.companyName}),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete Company",children:e.jsx(Ie,{size:18})})]})})})]},t.id))})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-4 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx("span",{children:"Show"}),e.jsxs("select",{value:v,onChange:t=>g(Number(t.target.value)),className:"border-gray-300 rounded-md text-xs py-1.5 pl-2 pr-6 bg-white focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]}),e.jsx("span",{children:"per page"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["Page ",e.jsx("strong",{children:L})," of ",e.jsx("strong",{children:f||1})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>N(t=>Math.max(1,t-1)),disabled:L===1,className:"p-2 rounded-md bg-white border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:hover:bg-white transition-all",children:e.jsx(ws,{size:16,className:"text-gray-600"})}),e.jsx("button",{onClick:()=>N(t=>Math.min(f,t+1)),disabled:L>=f,className:"p-2 rounded-md bg-white border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:hover:bg-white transition-all",children:e.jsx(Cs,{size:16,className:"text-gray-600"})})]})]})]}),u&&e.jsx("div",{className:"p-4 bg-white border-t border-gray-100 text-center",children:e.jsx("button",{onClick:()=>j("companies"),className:"px-6 py-2 text-sm font-bold text-blue-600 bg-blue-50 border border-blue-100 rounded-xl hover:bg-blue-100 transition-all",children:"Load More from Database"})})]})}function Tt({title:s,icon:r,children:a,className:l=""}){return e.jsxs("div",{className:`bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col ${l}`,children:[e.jsx("div",{className:"p-5 border-b border-gray-200 shrink-0",children:e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[r,s]})}),a]})}function zt({listLoading:s,statsError:r,userList:a=[],allCompaniesMap:l,onEdit:m,onDelete:p}){const[j,u]=n.useState(""),[i,h]=n.useState(1),[b,L]=n.useState(20),N=n.useMemo(()=>{const o=j.toLowerCase();return o?a.filter(y=>y.name?.toLowerCase().includes(o)||y.email?.toLowerCase().includes(o)):a},[j,a]),v=Math.ceil(N.length/b),g=n.useMemo(()=>{const o=(i-1)*b;return N.slice(o,o+b)},[N,i,b]);return n.useEffect(()=>{h(1)},[j,b]),e.jsxs(Tt,{title:"Manage All Users",icon:e.jsx(ye,{size:20,className:"text-blue-600"}),className:"h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 bg-white flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0",children:[e.jsx("div",{children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Total Users: ",e.jsx("strong",{children:a.length})]})}),e.jsxs("div",{className:"relative w-full sm:w-72",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(Re,{size:16,className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Search users...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all",value:j,onChange:o=>u(o.target.value)})]})]}),e.jsx("div",{className:"flex-1 overflow-auto min-h-0 bg-gray-50",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200",children:"User"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200",children:"Role & Access"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:s?e.jsx("tr",{children:e.jsxs("td",{colSpan:"3",className:"p-10 text-center text-gray-500",children:[e.jsx(O,{className:"animate-spin mx-auto mb-2"}),"Loading users..."]})}):r.users?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",className:"p-10 text-center text-red-500",children:"Error loading users."})}):N.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",className:"p-10 text-center text-gray-400",children:"No users found."})}):g.map(o=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 align-middle",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-9 h-9 rounded-full bg-purple-100 border border-purple-200 flex items-center justify-center text-sm font-bold text-purple-700 shrink-0",children:de(o.name).charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold text-gray-900",children:de(o.name)}),e.jsx("p",{className:"text-xs text-gray-500",children:de(o.email)})]})]})}),e.jsx("td",{className:"px-6 py-4 align-middle",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:o.globalRole==="super_admin"?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-200",children:[e.jsx(Ps,{size:12})," Super Admin"]}):(o.memberships?.length||0)>0?o.memberships.map(y=>e.jsxs("div",{className:"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100",children:[e.jsx($e,{size:12}),y.role==="company_admin"?"Admin":"User"," at ",l.get(y.companyId)||"Unknown"]},y.companyId)):e.jsx("span",{className:"text-xs text-gray-400 italic",children:"No active memberships"})})}),e.jsx("td",{className:"px-6 py-4 align-middle text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>m({id:o.id}),className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",title:"Edit User",children:e.jsx(Ge,{size:18})}),e.jsx("button",{onClick:()=>p({id:o.id,name:o.name}),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete User",children:e.jsx(Ie,{size:18})})]})})]},o.id))})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-4 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx("span",{children:"Show"}),e.jsxs("select",{value:b,onChange:o=>L(Number(o.target.value)),className:"border-gray-300 rounded-md text-xs py-1.5 pl-2 pr-6 bg-white focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]}),e.jsx("span",{children:"per page"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["Page ",e.jsx("strong",{children:i})," of ",e.jsx("strong",{children:v||1})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>h(o=>Math.max(1,o-1)),disabled:i===1,className:"p-2 rounded-md bg-white border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:hover:bg-white transition-all",children:e.jsx(ws,{size:16,className:"text-gray-600"})}),e.jsx("button",{onClick:()=>h(o=>Math.min(v,o+1)),disabled:i>=v,className:"p-2 rounded-md bg-white border border-gray-200 hover:bg-gray-50 disabled:opacity-50 disabled:hover:bg-white transition-all",children:e.jsx(Cs,{size:16,className:"text-gray-600"})})]})]})]})]})}function Mt({onDataUpdate:s,onClose:r}){const{csvData:a,step:l,setStep:m,importMethod:p,setImportMethod:j,sheetUrl:u,setSheetUrl:i,processingSheet:h,handleSheetImport:b,handleFileChange:L,reset:N}=Js(),[v,g]=n.useState(!1),[o,y]=n.useState(""),[w,x]=n.useState({created:0,updated:0}),S=async()=>{g(!0),y("Syncing to Global Database...");let D=0,P=0;try{let M=as(k),t=0;for(let d=0;d<a.length;d++){const c=a[d];y(`Processing ${d+1} / ${a.length}...`);let C=null,R=null;const A=Y(k,"drivers");if(!c.isEmailPlaceholder){const z=Z(A,se("personalInfo.email","==",c.email)),I=await W(z);I.empty||(C=I.docs[0])}if(!C&&c.normalizedPhone){const z=Z(A,se("personalInfo.normalizedPhone","==",c.normalizedPhone)),I=await W(z);I.empty||(C=I.docs[0])}if(C){R=C.id,P++;const z=$(k,"drivers",R),I={lastUpdatedAt:me(),"driverProfile.isBulkUpload":!0};c.firstName&&(I["personalInfo.firstName"]=c.firstName),c.lastName&&(I["personalInfo.lastName"]=c.lastName),c.phone&&(I["personalInfo.phone"]=c.phone),c.normalizedPhone&&(I["personalInfo.normalizedPhone"]=c.normalizedPhone),c.city&&(I["personalInfo.city"]=c.city),c.state&&(I["personalInfo.state"]=c.state),c.experience&&(I["qualifications.experienceYears"]=c.experience),c.driverType&&(I["driverProfile.type"]=c.driverType),M.update(z,I)}else{D++;const z=$(Y(k,"drivers"));R=z.id;const I={personalInfo:{firstName:c.firstName,lastName:c.lastName,email:c.email,phone:c.phone,normalizedPhone:c.normalizedPhone||"",city:c.city,state:c.state,zip:""},driverProfile:{type:c.driverType,availability:"actively_looking",isBulkUpload:!0,isEmailPlaceholder:!!c.isEmailPlaceholder},qualifications:{experienceYears:c.experience||"New"},createdAt:me(),lastUpdatedAt:me(),source:p==="gsheet"?"admin_gsheet_import":"admin_file_import"};M.set(z,I)}const E=$(k,"leads",R),U={firstName:c.firstName,lastName:c.lastName,email:c.email,phone:c.phone,normalizedPhone:c.normalizedPhone||"",driverType:c.driverType,experience:c.experience||"New",source:"SafeHaul Network",createdAt:me(),unavailableUntil:null};M.set(E,U,{merge:!0}),t++,t>=150&&(await M.commit(),M=as(k),t=0)}t>0&&await M.commit(),x({created:D,updated:P}),m("success"),s&&s()}catch(f){console.error("Bulk Upload Error:",f),alert("Error processing batch: "+f.message)}finally{g(!1)}};return e.jsx(Ys,{title:"Bulk Lead Adding (Global Pool)",step:l,importMethod:p,setImportMethod:j,sheetUrl:u,setSheetUrl:i,processingSheet:h,handleSheetImport:b,handleFileChange:L,csvData:a,reset:N,onConfirm:S,onClose:r,uploading:v,progress:o,stats:w})}function ss({title:s,icon:r,children:a,className:l=""}){return e.jsxs("div",{className:`bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden ${l}`,children:[e.jsx("div",{className:"p-5 border-b border-gray-200",children:e.jsxs("h2",{className:"text-xl font-semibold text-gray-700 flex items-center gap-3",children:[r,s]})}),e.jsx("div",{className:"p-5",children:a})]})}function ae({id:s,label:r,type:a="text",required:l=!1,...m}){return e.jsxs("div",{children:[e.jsx("label",{htmlFor:s,className:"block text-sm font-medium text-gray-700 mb-1",children:r}),e.jsx("input",{type:a,id:s,name:s,className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition",required:l,...m})]})}function _t({onDataUpdate:s,setActiveView:r}){const[a,l]=n.useState("company"),[m,p]=n.useState(!1),[j,u]=n.useState([]),[i,h]=n.useState({companyName:"",appSlug:"",mcNumber:"",dotNumber:"",email:"",phone:"",address:"",city:"",state:"",zip:"",planType:"free"}),[b,L]=n.useState(!0),[N,v]=n.useState({name:"",email:"",password:"",role:"company_admin"}),[g,o]=n.useState({fullName:"",email:"",password:"",companyId:"",role:"hr_user"});n.useEffect(()=>{$s().then(x=>{const S=x.docs.map(D=>({id:D.id,name:D.data().companyName}));u(S)}).catch(console.error)},[]),n.useEffect(()=>{if(i.companyName&&!i.appSlug){const x=i.companyName.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)+/g,"");h(S=>({...S,appSlug:x}))}},[i.companyName]);const y=async x=>{x.preventDefault(),p(!0);try{const S=i.planType==="paid"?200:50,D=await Us({...i,dailyQuota:S,isActive:!0,createdAt:new Date});console.log("Company created with ID:",D.id),b&&(await B(H,"createPortalUser")({fullName:N.name,email:N.email,password:N.password,companyId:D.id,role:N.role}),console.log("Admin user created successfully.")),alert("Company (and Admin) created successfully!"),s&&s(),h({companyName:"",appSlug:"",mcNumber:"",dotNumber:"",email:"",phone:"",address:"",city:"",state:"",zip:"",planType:"free"}),v({name:"",email:"",password:"",role:"company_admin"})}catch(S){console.error("Creation Error:",S),alert(`Error: ${S.message}`)}finally{p(!1)}},w=async x=>{x.preventDefault(),p(!0);try{const D=await B(H,"createPortalUser")({fullName:g.fullName,email:g.email,password:g.password,companyId:g.companyId,role:g.role});if(D.data?.error)throw new Error(D.data.error);alert("User created successfully!"),o({fullName:"",email:"",password:"",companyId:"",role:"hr_user"}),s&&s()}catch(S){console.error("User Creation Error:",S),alert(`Failed: ${S.message}`)}finally{p(!1)}};return e.jsxs("div",{className:"max-w-4xl mx-auto pb-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("header",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Create New Entity"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Add new companies or team members to the system."})]}),r&&e.jsxs("button",{onClick:()=>r("companies"),className:"px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg flex items-center gap-2",children:[e.jsx(Se,{size:20})," Close"]})]}),e.jsxs("div",{className:"flex gap-4 border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>l("company"),className:`pb-3 px-4 text-sm font-bold flex items-center gap-2 transition-all ${a==="company"?"border-b-4 border-blue-600 text-blue-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx($e,{size:18})," New Company"]}),e.jsxs("button",{onClick:()=>l("user"),className:`pb-3 px-4 text-sm font-bold flex items-center gap-2 transition-all ${a==="user"?"border-b-4 border-purple-600 text-purple-700":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Xe,{size:18})," New User Only"]})]})]}),a==="company"&&e.jsxs("form",{onSubmit:y,className:"space-y-6 animate-in fade-in slide-in-from-left-4",children:[e.jsx(ss,{title:"Company Details",icon:e.jsx($e,{className:"text-blue-600"}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 mb-2",children:[e.jsxs("div",{onClick:()=>h({...i,planType:"free"}),className:`p-4 border-2 rounded-xl cursor-pointer flex items-center gap-3 ${i.planType==="free"?"border-blue-500 bg-blue-50":"border-gray-200"}`,children:[e.jsx("div",{className:"p-2 bg-white rounded-full shadow-sm text-gray-600",children:e.jsx(Ls,{size:20})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-800",children:"Free Plan"}),e.jsx("p",{className:"text-xs text-gray-500",children:"50 Leads Daily Limit"})]})]}),e.jsxs("div",{onClick:()=>h({...i,planType:"paid"}),className:`p-4 border-2 rounded-xl cursor-pointer flex items-center gap-3 ${i.planType==="paid"?"border-yellow-500 bg-yellow-50":"border-gray-200"}`,children:[e.jsx("div",{className:"p-2 bg-white rounded-full shadow-sm text-yellow-600",children:e.jsx(Rs,{size:20})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-800",children:"Pro Plan"}),e.jsx("p",{className:"text-xs text-gray-500",children:"200 Leads Daily Limit"})]})]})]}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(ae,{id:"companyName",label:"Company Name",value:i.companyName,onChange:x=>h({...i,companyName:x.target.value}),required:!0})}),e.jsxs("div",{className:"md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100",children:[e.jsxs("div",{className:"md:col-span-3 mb-1 flex items-center gap-2 text-blue-800 font-bold text-sm",children:[e.jsx(Fs,{size:16})," Carrier Information"]}),e.jsx(ae,{id:"appSlug",label:"URL Slug",value:i.appSlug,onChange:x=>h({...i,appSlug:x.target.value}),required:!0}),e.jsx(ae,{id:"mcNumber",label:"MC Number",value:i.mcNumber,onChange:x=>h({...i,mcNumber:x.target.value})}),e.jsx(ae,{id:"dotNumber",label:"DOT Number",value:i.dotNumber,onChange:x=>h({...i,dotNumber:x.target.value})})]}),e.jsx(ae,{id:"email",label:"Contact Email",type:"email",value:i.email,onChange:x=>h({...i,email:x.target.value}),required:!0}),e.jsx(ae,{id:"phone",label:"Phone",type:"tel",value:i.phone,onChange:x=>h({...i,phone:x.target.value})}),e.jsxs("div",{className:"md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4",children:[e.jsx("div",{className:"md:col-span-3",children:e.jsx(ae,{id:"address",label:"Street Address",value:i.address,onChange:x=>h({...i,address:x.target.value})})}),e.jsx(ae,{id:"city",label:"City",value:i.city,onChange:x=>h({...i,city:x.target.value})}),e.jsx(ae,{id:"state",label:"State",value:i.state,onChange:x=>h({...i,state:x.target.value})}),e.jsx(ae,{id:"zip",label:"Zip",value:i.zip,onChange:x=>h({...i,zip:x.target.value})})]})]})}),e.jsxs(ss,{title:"Initial User Setup",icon:e.jsx(Xe,{className:"text-purple-600"}),children:[e.jsxs("div",{className:"mb-6 flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"withAdmin",className:"w-5 h-5 text-blue-600 rounded",checked:b,onChange:x=>L(x.target.checked)}),e.jsx("label",{htmlFor:"withAdmin",className:"text-gray-900 font-medium",children:"Create a portal user for this company now"})]}),b&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(ae,{id:"adminName",label:"Full Name",value:N.name,onChange:x=>v({...N,name:x.target.value}),required:b}),e.jsx(ae,{id:"adminEmail",label:"Login Email",type:"email",value:N.email,onChange:x=>v({...N,email:x.target.value}),required:b}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsxs("select",{className:"w-full p-3 border rounded-lg",value:N.role,onChange:x=>v({...N,role:x.target.value}),children:[e.jsx("option",{value:"company_admin",children:"Company Admin"}),e.jsx("option",{value:"hr_user",children:"HR User"})]})]}),e.jsx(ae,{id:"adminPass",label:"Password",value:N.password,onChange:x=>v({...N,password:x.target.value}),required:b,minLength:6})]})]}),e.jsx("div",{className:"flex justify-end gap-4",children:e.jsxs("button",{type:"submit",disabled:m,className:"px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg flex items-center gap-2 disabled:opacity-50",children:[m?e.jsx(O,{className:"animate-spin"}):e.jsx(ds,{size:20})," Create Company"]})})]}),a==="user"&&e.jsxs("form",{onSubmit:w,className:"space-y-6 animate-in fade-in slide-in-from-right-4",children:[e.jsx(ss,{title:"Create Standalone User",icon:e.jsx(Ve,{className:"text-purple-600"}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(ae,{id:"newUserName",label:"Full Name",value:g.fullName,onChange:x=>o({...g,fullName:x.target.value}),required:!0}),e.jsx(ae,{id:"newUserEmail",label:"Email Address",type:"email",value:g.email,onChange:x=>o({...g,email:x.target.value}),required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Assign to Company"}),e.jsxs("select",{className:"w-full p-3 border border-gray-300 rounded-lg",required:!0,value:g.companyId,onChange:x=>o({...g,companyId:x.target.value}),children:[e.jsx("option",{value:"",children:"-- Select Company --"}),j.map(x=>e.jsx("option",{value:x.id,children:x.name},x.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsxs("select",{className:"w-full p-3 border border-gray-300 rounded-lg",value:g.role,onChange:x=>o({...g,role:x.target.value}),children:[e.jsx("option",{value:"hr_user",children:"HR User"}),e.jsx("option",{value:"company_admin",children:"Company Admin"}),e.jsx("option",{value:"super_admin",children:"Super Admin (Careful!)"})]})]}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(ae,{id:"newUserPass",label:"Password",value:g.password,onChange:x=>o({...g,password:x.target.value}),required:!0,minLength:6})})]})}),e.jsx("div",{className:"flex justify-end gap-4",children:e.jsxs("button",{type:"submit",disabled:m,className:"px-8 py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg flex items-center gap-2 disabled:opacity-50",children:[m?e.jsx(O,{className:"animate-spin"}):e.jsx(Xe,{size:20})," Create User"]})})]})]})}function bs({title:s,icon:r,children:a,className:l=""}){return e.jsxs("div",{className:`bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col ${l}`,children:[e.jsx("div",{className:"p-5 border-b border-gray-200 shrink-0",children:e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[r,s]})}),a]})}function $t({companyList:s,onDataUpdate:r}){const{showSuccess:a,showError:l,showInfo:m}=Ce(),[p,j]=n.useState(""),[u,i]=n.useState(!1),[h,b]=n.useState(!1),L=n.useMemo(()=>{if(!p)return s;const g=p.toLowerCase();return s.filter(o=>o.companyName?.toLowerCase().includes(g))},[s,p]),N=async(g,o,y)=>{try{const w=$(k,"companies",g.id);await cs(w,{[`features.${o}`]:!y}),a(`Updated ${g.companyName}`),r()}catch(w){console.error("Update failed:",w),l("Failed to toggle feature.")}},v=async(g,o)=>{if(window.confirm(`Are you sure you want to ${o?"ENABLE":"DISABLE"} ${g} for ALL ${s.length} companies?`)){b(!0),m("Processing bulk update...");try{const w=[];for(let x=0;x<s.length;x+=400)w.push(s.slice(x,x+400));for(const x of w){const S=as(k);x.forEach(D=>{const P=$(k,"companies",D.id);S.update(P,{[`features.${g}`]:o})}),await S.commit()}a(`Successfully ${o?"Enabled":"Disabled"} feature for all companies.`),r()}catch(y){console.error("Bulk update failed:",y),l("Bulk update failed.")}finally{b(!1)}}};return e.jsxs("div",{className:"space-y-6 h-full flex flex-col",children:[e.jsx(bs,{title:"Global Feature Controls",icon:e.jsx(Is,{size:20,className:"text-blue-600"}),className:"shrink-0",children:e.jsxs("div",{className:"p-6 bg-gradient-to-r from-gray-50 to-white space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-lg",children:"Search For Drivers Access"}),e.jsx("p",{className:"text-sm text-gray-500",children:'Control access to the "Search For Drivers" global database. If disabled, users will see the "Under Development" screen with a redirect to SafeHaul Leads.'})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>v("searchDB",!1),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-white border border-red-200 text-red-600 font-bold rounded-lg hover:bg-red-50 hover:border-red-300 transition shadow-sm disabled:opacity-50",children:[h?e.jsx(O,{className:"animate-spin",size:18}):e.jsx(Oe,{size:18}),"Disable for All"]}),e.jsxs("button",{onClick:()=>v("searchDB",!0),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50",children:[h?e.jsx(O,{className:"animate-spin",size:18}):e.jsx(is,{size:18}),"Enable for All"]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-6 pt-6 border-t border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-lg",children:"Bulk Actions / Campaigns Access"}),e.jsx("p",{className:"text-sm text-gray-500",children:'Control access to SMS Reactivation Campaigns in Settings. If disabled, users will see a "Contact Account Manager" message.'})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>v("campaignsEnabled",!1),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-white border border-red-200 text-red-600 font-bold rounded-lg hover:bg-red-50 hover:border-red-300 transition shadow-sm disabled:opacity-50",children:[h?e.jsx(O,{className:"animate-spin",size:18}):e.jsx(Oe,{size:18}),"Disable for All"]}),e.jsxs("button",{onClick:()=>v("campaignsEnabled",!0),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50",children:[h?e.jsx(O,{className:"animate-spin",size:18}):e.jsx(is,{size:18}),"Enable for All"]})]})]})]})}),e.jsxs(bs,{title:"Company Feature Overrides",icon:e.jsx(Qe,{size:20,className:"text-purple-600"}),className:"flex-1 min-h-0",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 bg-white",children:e.jsxs("div",{className:"relative max-w-md",children:[e.jsx(Re,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search companies...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",value:p,onChange:g=>j(g.target.value)})]})}),e.jsx("div",{className:"flex-1 overflow-auto bg-gray-50",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200",children:"Company Name"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 text-center",children:"Search Drivers"}),e.jsx("th",{className:"px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 text-center",children:"Campaigns"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:L.map(g=>{const o=g.features?.searchDB===!0,y=g.features?.campaignsEnabled===!0;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 font-medium text-gray-900",children:g.companyName}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("button",{onClick:()=>N(g,"searchDB",o),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${o?"bg-green-500":"bg-gray-200"}`,children:e.jsx("span",{className:`${o?"translate-x-6":"translate-x-1"} inline-block h-4 w-4 transform rounded-full bg-white transition-transform`})})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("button",{onClick:()=>N(g,"campaignsEnabled",y),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 ${y?"bg-purple-500":"bg-gray-200"}`,children:e.jsx("span",{className:`${y?"translate-x-6":"translate-x-1"} inline-block h-4 w-4 transform rounded-full bg-white transition-transform`})})})]},g.id)})})]})})]})]})}const Me="safehaul_system_health_state",_e=[{id:"init",label:"1. Initializing Environment"},{id:"storage_write",label:"2. Infrastructure: Storage System"},{id:"firestore_company",label:"3. Infrastructure: Database Write"},{id:"cloud_function",label:"4. Infrastructure: Cloud Server"},{id:"sim_driver_app",label:"5. Flow: Direct Application (Slug)"},{id:"sim_doc_upload",label:"6. Flow: Document Upload (CDL)"},{id:"sim_signature",label:"7. Flow: E-Signature Capture"},{id:"test_user_access",label:"8. Security: User Creation & Reassignment"},{id:"sim_recruiter_link",label:"9. Flow: Recruiter Link Attribution"},{id:"sim_job_offer",label:"10. Flow: Company Sending Offer"},{id:"sim_offer_receive",label:"11. Flow: Driver Receiving Offer"},{id:"sim_safehaul_lead",label:"12. Data: SafeHaul & Personal Leads"},{id:"sim_pdf_gen",label:"13. Engine: PDF Generation"},{id:"sim_activity_log",label:"14. Logic: Audit Trail Logging"},{id:"test_visibility",label:"15. Data: Dashboard Visibility (All Views)"},{id:"test_integrity",label:"16. Data: DB <-> Storage Alignment"},{id:"cleanup",label:"17. System Cleanup & Data Purge"},{id:"security_audit",label:"18. Security: Automated Audit Scan"}];function Ft(){const[s,r]=n.useState("idle"),[a,l]=n.useState(0),[m,p]=n.useState(0),[j,u]=n.useState([]),[i,h]=n.useState("idle"),[b,L]=n.useState({}),N=n.useRef({}),v=n.useRef(null);n.useEffect(()=>{const P=localStorage.getItem(Me);if(P)try{const f=JSON.parse(P);if(f.status!=="success"&&f.status!=="idle"){r("paused"),l(f.currentStepIndex||0),u(f.logs||[]);const M=f.testData||{};L(M),N.current=M,p(f.progress||0),g("âš ï¸ Restored previous test session. Ready to resume.","warning")}}catch(f){console.error("Failed to load saved health state",f),localStorage.removeItem(Me)}},[]),n.useEffect(()=>{if(s==="idle")return;const P={status:s,currentStepIndex:a,logs:j,testData:b,progress:m};localStorage.setItem(Me,JSON.stringify(P))},[s,a,j,b,m]);const g=n.useCallback((P,f="info")=>{u(M=>[...M,{id:Date.now()+Math.random(),time:new Date().toISOString(),message:P,type:f}])},[]),o=P=>new Promise(f=>setTimeout(f,P)),y=async()=>{h("running"),g("ðŸ› ï¸ Initiating System Structure Repair...","info");try{const f=await B(H,"syncSystemStructure")();if(f.data.success)h("success"),g(`âœ… Repair Complete: ${f.data.message}`,"success"),g(`ðŸ“Š Stats: Scanned ${f.data.stats.companies+f.data.stats.leads} docs, Fixed ${f.data.stats.fixes} issues.`,"success");else throw new Error(f.data.message||"Unknown failure")}catch(P){console.error("Repair failed:",P),h("error"),g(`âŒ Repair Failed: ${P.message}`,"error")}},w=async(P=!1)=>{P?(r("running"),N.current=b,g("ðŸ”„ Resuming Diagnostic...","info")):(r("running"),u([]),L({}),N.current={},l(0),p(0),g("ðŸš€ Starting Comprehensive System Diagnostic...","info")),v.current=new AbortController;try{for(let f=P?a:0;f<_e.length&&!v.current?.signal.aborted;f++){const M=_e[f];l(f),p(Math.round(f/_e.length*100)),g(`Testing: ${M.label}...`,"info"),await x(M.id),await o(1e3)}v.current?.signal.aborted||(p(100),r("success"),g("âœ… All Systems Operational. Test Complete.","success"),localStorage.removeItem(Me))}catch(f){console.error("Diagnostic Error:",f),r("error"),g(`âŒ FAILURE: ${f.message}`,"error")}},x=async P=>{const f=N.current,M=t=>{const d={...N.current,...t};N.current=d,L(d)};switch(P){case"init":{if(!navigator.onLine)throw new Error("No Internet Connection");g("âœ… Network Connection Verified.","success");break}case"storage_write":{const t=`system_health_tests/SYS_TEST_${Date.now()}.txt`,d=Te(ze,t);await gs(d,"System Health Check - Write Test"),M({fileRefPath:t}),g("âœ… Storage Write Access Verified.","success");break}case"firestore_company":{const t=`SYS_TEST_${Date.now()}`;await ee($(k,"companies",t),{companyName:"Test Company A",appSlug:`test-slug-${Date.now()}`,isTestRecord:!0,createdAt:me(),dailyQuota:50,status:"active"});const d=`SYS_TEST_B_${Date.now()}`;await ee($(k,"companies",d),{companyName:"Test Company B",isTestRecord:!0});const c=`SYS_DRIVER_${Date.now()}`;await ee($(k,"drivers",c),{personalInfo:{firstName:"Test",lastName:"Driver",email:`driver_${Date.now()}@test.com`},isTestRecord:!0,createdAt:me()}),M({companyId:t,companyIdB:d,driverId:c}),g("âœ… Test Companies & Driver Created.","success");break}case"cloud_function":{if(!(await B(H,"runMigration")({mode:"ping"})).data?.success)throw new Error("Cloud Function Ping Failed");g("âœ… Cloud Functions are Responding.","success");break}case"sim_driver_app":{if(!f.companyId||!f.driverId)throw new Error("Missing IDs");const t=$(k,"companies",f.companyId,"applications",f.driverId);await ee(t,{driverId:f.driverId,status:"New Application",submittedAt:me(),applicantName:"Test Driver",source:"Slug Apply",companyId:f.companyId,isTestRecord:!0}),g("âœ… Driver Application Submitted via Slug.","success");break}case"sim_doc_upload":{const t=`companies/${f.companyId}/applications/${f.driverId}/cdl_front.txt`,d=Te(ze,t);await gs(d,"FAKE CDL CONTENT"),M({cdlPath:t});const c=$(k,"companies",f.companyId,"applications",f.driverId);await ee(c,{"cdl-front":{url:"http://fake-url.com",storagePath:t}},{merge:!0}),g("âœ… CDL Document Uploaded & Linked to Profile.","success");break}case"sim_signature":{const t=$(k,"companies",f.companyId,"applications",f.driverId);await ee(t,{signature:{name:"Test Driver",date:new Date().toISOString(),data:"base64_fake_signature_string"},isCertified:!0},{merge:!0}),g("âœ… E-Signature Successfully Captured.","success");break}case"test_user_access":{const t=`systest_${Date.now()}@example.com`,d="Test1234!";g(".. Creating temporary user...","info");const C=await B(H,"createPortalUser")({fullName:"System Test User",email:t,password:d,companyId:f.companyId,role:"hr_user"});if(!C.data?.userId)throw new Error("User creation failed (No UID returned)");const R=C.data.userId;M({tempUserId:R});const A=Z(Y(k,"memberships"),se("userId","==",R),se("companyId","==",f.companyId)),E=await W(A);if(E.empty)throw new Error("User created but NOT assigned to Company A.");g(".. User assigned to Company A.","info");const U=E.docs[0].id;await he($(k,"memberships",U)),await ee($(k,"memberships",`TEMP_MEM_${Date.now()}`),{userId:R,companyId:f.companyIdB,role:"company_admin",isTestRecord:!0});const z=Z(Y(k,"memberships"),se("userId","==",R),se("companyId","==",f.companyIdB));if((await W(z)).empty)throw new Error("Reassignment Failed: User not found in Company B.");g("âœ… User Access Cycle (Create -> Assign -> Reassign) Verified.","success");break}case"sim_recruiter_link":{const t=`TEST_REC_${Date.now()}`,d=$(k,"companies",f.companyId,"applications",`LINKED_APP_${Date.now()}`);if(await ee(d,{status:"New Application",applicantName:"Linked Driver",source:"Recruiter Link",assignedTo:t,isTestRecord:!0,submittedAt:me()}),(await be(d)).data().assignedTo!==t)throw new Error("Recruiter Link Logic Failed: 'assignedTo' field missing or incorrect.");M({linkedAppId:d.id}),g("âœ… Recruiter Attribution Logic Verified.","success");break}case"sim_job_offer":{const t=$(k,"companies",f.companyId,"applications",f.driverId);await ee(t,{status:"Offer Sent",offerDetails:{payRate:"0.70",payType:"CPM",generatedAt:new Date().toISOString()}},{merge:!0}),g("âœ… Job Offer Sent.","success");break}case"sim_offer_receive":{const t=$(k,"companies",f.companyId,"applications",f.driverId);if((await be(t)).data().status!=="Offer Sent")throw new Error("Status update failed.");g("âœ… Driver Received Offer.","success");break}case"sim_safehaul_lead":{const t=`SH_LEAD_${Date.now()}`;await ee($(k,"leads",t),{name:"SafeHaul Test Lead",status:"active",isTestRecord:!0,createdAt:me()});const d=ps.currentUser;let c=null;d?(c=`MY_LEAD_${Date.now()}`,await ee($(k,"companies",f.companyId,"leads",c),{name:"Personal Assigned Lead",status:"new",assignedTo:d.uid,isTestRecord:!0})):g("âš ï¸ Skipping 'My Leads' creation (No Admin logged in).","warning"),M({globalLeadId:t,myLeadId:c}),g("âœ… SafeHaul & Personal Leads Created.","success");break}case"sim_pdf_gen":{try{const t=new Xs;if(t.text("System Health Check",10,10),!t.output("datauristring").startsWith("data:application/pdf"))throw new Error("Invalid PDF header");g("âœ… PDF Generation Engine OK.","success")}catch(t){throw new Error(`PDF Engine Error: ${t.message}`)}break}case"sim_activity_log":{const t=$(Y(k,"companies",f.companyId,"applications",f.driverId,"activities"));if(await ee(t,{type:"test",text:"Audit Log Test",createdAt:me()}),!(await be(t)).exists())throw new Error("Activity Log failed to write.");g("âœ… Audit/Activity Logging OK.","success");break}case"test_visibility":{const t=Z(Y(k,"companies",f.companyId,"applications"));if(!(await W(t)).docs.find(E=>E.id===f.driverId))throw new Error("Dashboard Visibility Error: Application not showing in query.");const C=$(Y(k,"companies",f.companyId,"leads"));await ee(C,{name:"Standard Company Lead",status:"new",isTestRecord:!0});const R=Z(Y(k,"companies",f.companyId,"leads"));if((await W(R)).empty)throw new Error("Dashboard Visibility Error: Leads not showing in query.");if(f.globalLeadId&&!(await be($(k,"leads",f.globalLeadId))).exists())throw new Error("Visibility Error: SafeHaul (Global) lead not retrievable.");if(f.myLeadId){const E=ps.currentUser,U=Z(Y(k,"companies",f.companyId,"leads"),se("assignedTo","==",E.uid));if((await W(U)).empty)throw new Error("Visibility Error: 'My Leads' query returned empty.")}g("âœ… Dashboard Visibility Verified (Apps, Company Leads, SafeHaul, My Leads).","success");break}case"test_integrity":{const t=$(k,"companies",f.companyId,"applications",f.driverId),c=(await be(t)).data()["cdl-front"]?.storagePath;if(!c)throw new Error("Integrity Fail: DB missing file path.");try{const C=Te(ze,c);await qs(C),g("âœ… Database <-> Storage Alignment OK.","success")}catch{throw new Error(`Integrity Fail: File in DB but not in Storage. Path: ${c}`)}break}case"cleanup":{g("ðŸ§¹ Starting cleanup...","info");const t=N.current;if(t.companyId)try{const d=Z(Y(k,"companies",t.companyId,"applications")),c=await W(d);for(const A of c.docs)await he(A.ref);const C=Z(Y(k,"companies",t.companyId,"leads")),R=await W(C);for(const A of R.docs)await he(A.ref);await he($(k,"companies",t.companyId))}catch(d){console.error("Cleanup company A error:",d)}if(t.companyIdB)try{await he($(k,"companies",t.companyIdB))}catch(d){console.error("Cleanup company B error:",d)}if(t.driverId)try{await he($(k,"drivers",t.driverId))}catch(d){console.error("Cleanup driver error:",d)}if(t.globalLeadId)try{await he($(k,"leads",t.globalLeadId))}catch(d){console.error("Cleanup global lead error:",d)}if(t.fileRefPath)try{await us(Te(ze,t.fileRefPath))}catch(d){console.error("Cleanup storage file error:",d)}if(t.cdlPath)try{await us(Te(ze,t.cdlPath))}catch(d){console.error("Cleanup CDL file error:",d)}try{const d=Z(Y(k,"memberships"),se("isTestRecord","==",!0)),c=await W(d);for(const C of c.docs)await he(C.ref)}catch(d){console.error("Cleanup memberships error:",d)}g("âœ… All test data cleaned up.","success");break}case"security_audit":{g("ðŸ•µï¸ Running Security & Integrity Audit...","info");const t=B(H,"runSecurityAudit");try{const c=(await t({scanOnly:!0})).data.report;c.criticalIssues>0?g(`âš ï¸ Audit Found ${c.criticalIssues} Critical Issues. Score: ${c.score}/100`,"warning"):g(`v Audit Passed. Score: ${c.score}/100`,"success"),c.checks.forEach(C=>{const R=C.status==="PASS"?"âœ…":C.status==="FAIL"?"âŒ":"â„¹ï¸";g(`${R} [${C.type}] ${C.message}`,C.status==="FAIL"?"error":"info")})}catch(d){throw new Error(`Security Audit Failed: ${d.message}`)}break}default:g(`âš ï¸ Unknown step: ${P}`,"warning")}},S=()=>{v.current?.abort(),r("paused"),g("â¸ï¸ Diagnostics Paused.","warning")},D=()=>{v.current?.abort(),r("idle"),l(0),p(0),u([]),L({}),N.current={},localStorage.removeItem(Me)};return{status:s,currentStep:_e[a],progress:m,logs:j,steps:_e,runDiagnostics:w,pauseDiagnostics:S,resetDiagnostics:D,runSystemRepair:y,repairStatus:i}}function Ut(){const{runDiagnostics:s,pauseDiagnostics:r,resetDiagnostics:a,runSystemRepair:l,repairStatus:m,status:p,progress:j,logs:u,currentStep:i}=Ft(),h=n.useRef(null);n.useEffect(()=>{h.current?.scrollIntoView({behavior:"smooth"})},[u]);const b=()=>{switch(p){case"success":return"text-green-600 bg-green-50 border-green-200";case"error":return"text-red-600 bg-red-50 border-red-200";case"running":return"text-blue-600 bg-blue-50 border-blue-200";case"paused":return"text-orange-600 bg-orange-50 border-orange-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Fe,{className:"text-blue-600"})," System Health & Diagnostics"]}),e.jsx("p",{className:"text-gray-500",children:"Deep inspection of Storage, Database, and Cloud Function integrity."})]}),e.jsx("div",{className:"flex gap-3",children:e.jsxs("button",{onClick:l,disabled:m==="running",className:`px-4 py-2 text-white font-bold rounded-lg shadow-md transition-all flex items-center gap-2
                    ${m==="running"?"bg-gray-400 cursor-not-allowed":m==="success"?"bg-green-600 hover:bg-green-700":"bg-indigo-600 hover:bg-indigo-700"}`,title:"Force database structure to match Schema Config",children:[m==="running"?e.jsx(we,{className:"animate-spin",size:18}):e.jsx(Zs,{size:18}),m==="running"?"Repairing...":"Sync Backend Structure"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-6",children:[e.jsxs("div",{className:`p-6 rounded-xl border-2 ${b()} transition-colors`,children:[e.jsx("h2",{className:"text-lg font-bold mb-2 uppercase tracking-wide",children:"Status"}),e.jsx("div",{className:"text-3xl font-black mb-4 capitalize",children:p==="idle"?"Ready":p}),e.jsx("div",{className:"relative w-full h-4 bg-gray-200 rounded-full overflow-hidden mb-2",children:e.jsx("div",{className:"absolute top-0 left-0 h-full bg-current transition-all duration-500 ease-out",style:{width:`${j}%`}})}),e.jsxs("div",{className:"flex justify-between text-xs font-semibold opacity-75",children:[e.jsxs("span",{children:[j,"% Complete"]}),e.jsx("span",{children:i?.label||"Waiting..."})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-4",children:[e.jsxs("h3",{className:"font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Ps,{size:20})," Control Center"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[p==="running"?e.jsxs("button",{onClick:r,className:"w-full py-3 bg-orange-100 text-orange-700 font-bold rounded-lg hover:bg-orange-200 flex items-center justify-center gap-2",children:[e.jsx(rs,{size:20})," Pause Test"]}):p==="paused"?e.jsxs("button",{onClick:()=>s(!0),className:"w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2",children:[e.jsx(Pe,{size:20})," Resume Test"]}):e.jsxs("button",{onClick:()=>s(!1),className:"w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 shadow-lg hover:shadow-blue-200",children:[e.jsx(Pe,{size:20})," Start Deep Diagnostic"]}),(p==="paused"||p==="error"||p==="success")&&e.jsxs("button",{onClick:()=>{(p==="success"||window.confirm("This will clear saved test progress. Continue?"))&&a()},className:"w-full py-2 bg-gray-100 text-gray-600 font-semibold rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2",children:[e.jsx(As,{size:16})," Reset"]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(qe,{icon:e.jsx(mt,{size:14}),label:"Storage"}),e.jsx(qe,{icon:e.jsx(fe,{size:14}),label:"Firestore"}),e.jsx(qe,{icon:e.jsx(Ds,{size:14}),label:"Functions"}),e.jsx(qe,{icon:e.jsx(Fe,{size:14}),label:"Latency"})]})]}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl shadow-lg overflow-hidden flex flex-col h-[500px]",children:[e.jsxs("div",{className:"bg-gray-800 p-3 flex items-center gap-2 border-b border-gray-700",children:[e.jsx(St,{size:18,className:"text-gray-400"}),e.jsx("span",{className:"text-sm font-mono text-gray-300",children:"System Output Log"})]}),e.jsxs("div",{className:"flex-1 p-4 overflow-y-auto font-mono text-sm space-y-2",children:[u.length===0&&e.jsx("div",{className:"text-gray-600 text-center mt-20",children:"Waiting for diagnostic or repair start..."}),u.map(L=>e.jsxs("div",{className:"flex gap-3 animate-in fade-in slide-in-from-left-2 duration-300",children:[e.jsx("span",{className:"text-gray-500 shrink-0",children:L.time.split("T")[1].split(".")[0]}),e.jsx("span",{className:`break-all ${L.type==="error"?"text-red-400 font-bold":L.type==="success"?"text-green-400":L.type==="warning"?"text-orange-300":"text-gray-300"}`,children:L.message})]},L.id)),e.jsx("div",{ref:h})]})]})})]})]})}function qe({icon:s,label:r}){return e.jsxs("span",{className:"px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded-md flex items-center gap-1.5 border border-gray-200",children:[s," ",r]})}function qt({companyId:s,onClose:r,onSuccess:a,sharedCredentials:l}){const{showSuccess:m,showError:p}=Ce(),[j,u]=n.useState(!1),[i,h]=n.useState(!1),[b,L]=n.useState(null),[N,v]=n.useState(""),[g,o]=n.useState(""),[y,w]=n.useState(""),[x,S]=n.useState(!l?.hasCredentials),[D,P]=n.useState(""),[f,M]=n.useState(""),[t,d]=n.useState(!0),c=x||!l?.hasCredentials,C=async()=>{if(!y.trim()){p("JWT token is required to test connection.");return}if(c&&(!D.trim()||!f.trim())){p("Client ID and Client Secret are required to test connection.");return}h(!0),L(null);try{const E=await B(H,"testLineConnection")({companyId:s,jwt:y.trim(),clientId:c?D.trim():void 0,clientSecret:c?f.trim():void 0,isSandbox:t});L({success:!0,message:E.data.message,accountId:E.data.accountId,extensionName:E.data.extensionName,availableNumbers:E.data.availableNumbers||[]}),m(`âœ“ Connected! ${E.data.extensionName}`)}catch(A){console.error("Test Connection Error:",A),L({success:!1,message:A.message}),p(A.message||"Connection test failed.")}finally{h(!1)}},R=async A=>{if(A.preventDefault(),!N.trim()){p("Phone number is required.");return}if(!y.trim()){p("JWT token is required for this line.");return}if(c&&(!D.trim()||!f.trim())){p("Client ID and Client Secret are required.");return}u(!0);try{const U=await B(H,"addPhoneLine")({companyId:s,phoneNumber:N.trim(),label:g.trim()||N.trim(),jwt:y.trim(),...c&&{clientId:D.trim(),clientSecret:f.trim(),isSandbox:t}});U.data.success&&(m(U.data.message||`Line ${U.data.phoneNumber} added successfully.`),U.data.verification?.identity&&m(`Verified: ${U.data.verification.identity}`),a?.(),r())}catch(E){console.error("Add Line Error:",E),p(E.message||"Failed to add phone line.")}finally{u(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-in fade-in",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex justify-between items-center",children:[e.jsxs("h3",{className:"font-bold text-white flex items-center gap-2",children:[e.jsx(Ae,{size:18}),"Add Phone Line"]}),e.jsx("button",{onClick:r,className:"text-white/80 hover:text-white transition-colors",children:e.jsx(Se,{size:20})})]}),e.jsxs("form",{onSubmit:R,className:"p-6 space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1.5",children:"Phone Number *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"tel",placeholder:"+1 (555) 123-4567",className:"w-full p-2.5 pl-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:N,onChange:A=>v(A.target.value),required:!0}),e.jsx(Ae,{size:16,className:"absolute left-3 top-3 text-gray-400"})]}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:"E.164 format preferred (e.g., +15551234567)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1.5",children:"Label (Optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Recruitment Hotline",className:"w-full p-2.5 pl-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:g,onChange:A=>o(A.target.value)}),e.jsx(wt,{size:16,className:"absolute left-3 top-3 text-gray-400"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1.5",children:"JWT Token for This Line *"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{placeholder:"eyJ0...",className:"w-full p-2.5 pl-10 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none resize-none",rows:3,value:y,onChange:A=>w(A.target.value),required:!0}),e.jsx(ls,{size:16,className:"absolute left-3 top-3 text-gray-400"})]}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:"Generate this in RingCentral Developer Portal for the user who owns this number."})]}),l?.hasCredentials&&e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600 cursor-pointer p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("input",{type:"checkbox",checked:x,onChange:A=>S(A.target.checked),className:"rounded text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Use per-line credentials"}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-0.5",children:"Enable if this line belongs to a different RingCentral app/account"})]})]}),c&&e.jsxs("div",{className:"border-t border-gray-200 pt-5 mt-5 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-blue-600 bg-blue-50 p-2 rounded-lg",children:[e.jsx(ls,{size:14}),e.jsx("span",{className:"font-medium",children:l?.hasCredentials?"Per-Line Credentials (Multi-Tenant Mode)":"Enter RingCentral App Credentials"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1.5",children:"Client ID *"}),e.jsx("input",{type:"text",placeholder:"Enter RingCentral Client ID",className:"w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:D,onChange:A=>P(A.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1.5",children:"Client Secret *"}),e.jsx("input",{type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",className:"w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:f,onChange:A=>M(A.target.value),required:!0})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t,onChange:A=>d(A.target.checked),className:"rounded text-blue-600 focus:ring-blue-500"}),"Use Sandbox Environment (for testing)"]})]}),b&&e.jsxs("div",{className:`p-3 rounded-lg text-sm ${b.success?"bg-green-50 border border-green-200 text-green-700":"bg-red-50 border border-red-200 text-red-700"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b.success?e.jsx(ge,{size:16}):e.jsx(Le,{size:16}),e.jsx("span",{className:"font-medium",children:b.success?"Connection Successful!":"Connection Failed"})]}),e.jsx("p",{className:"text-xs mt-1",children:b.message}),b.availableNumbers?.length>0&&e.jsxs("div",{className:"mt-2 text-xs",children:[e.jsx("span",{className:"font-medium",children:"Available Numbers: "}),b.availableNumbers.slice(0,3).map(A=>A.phoneNumber).join(", "),b.availableNumbers.length>3&&` +${b.availableNumbers.length-3} more`]})]}),e.jsxs("div",{className:"pt-3 space-y-2",children:[e.jsx("button",{type:"button",onClick:C,disabled:i||!y.trim(),className:"w-full py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 border border-gray-300",children:i?e.jsxs(e.Fragment,{children:[e.jsx(O,{size:16,className:"animate-spin"}),"Testing Connection..."]}):e.jsxs(e.Fragment,{children:[e.jsx(yt,{size:16}),"Test Connection"]})}),e.jsx("button",{type:"submit",disabled:j,className:"w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-70 shadow-md",children:j?e.jsxs(e.Fragment,{children:[e.jsx(O,{size:18,className:"animate-spin"}),"Verifying & Adding..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{size:18}),"Verify & Add Line"]})}),e.jsx("p",{className:"text-[10px] text-gray-400 text-center",children:"Credentials will be verified before the line is provisioned"})]})]})]})})}function Bt({companyId:s,companyName:r}){const{showSuccess:a,showError:l}=Ce(),[m,p]=n.useState([]),[j,u]=n.useState(!0),[i,h]=n.useState(!1),[b,L]=n.useState(null),[N,v]=n.useState(!1),[g,o]=n.useState(null);n.useEffect(()=>{if(!s)return;const w=$(k,"companies",s,"integrations","sms_provider"),x=os(w,S=>{if(S.exists()){const D=S.data();p(D.inventory||[]),h(!!(D.config?.clientId&&D.config?.clientSecret)),o(D.defaultPhoneNumber||null)}else p([]),h(!1);u(!1)},S=>{console.error("Error listening to SMS config:",S),u(!1)});return()=>x()},[s]);const y=n.useCallback(async w=>{if(window.confirm(`Are you sure you want to remove ${w}? Any users assigned to this line will be unassigned.`)){L(w);try{const S=await B(H,"removePhoneLine")({companyId:s,phoneNumber:w});S.data.success&&(a(S.data.message||`Line ${w} removed.`),S.data.clearedAssignments>0&&a(`${S.data.clearedAssignments} assignment(s) cleared.`))}catch(x){console.error("Remove Line Error:",x),l(x.message||"Failed to remove line.")}finally{L(null)}}},[s,a,l]);return j?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-8 flex flex-col items-center justify-center gap-4",children:[e.jsx(we,{className:"w-8 h-8 text-blue-500 animate-spin"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"Loading phone lines..."})]}):e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Ae,{className:"text-blue-600",size:20}),"Phone Line Wallet"]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:[m.length," line",m.length!==1?"s":""," provisioned for ",r||"this company"]})]}),e.jsxs("button",{onClick:()=>v(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg flex items-center gap-2 text-sm transition-colors shadow-sm",children:[e.jsx(ns,{size:16}),"Add Line"]})]}),m.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Ae,{className:"w-8 h-8 text-gray-400"})}),e.jsx("h4",{className:"font-bold text-gray-800 mb-2",children:"No Phone Lines"}),e.jsx("p",{className:"text-sm text-gray-500 max-w-sm mx-auto mb-6",children:"Add phone lines to enable SMS functionality. Each line requires its own JWT token from RingCentral."}),e.jsxs("button",{onClick:()=>v(!0),className:"px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg inline-flex items-center gap-2 transition-colors",children:[e.jsx(ns,{size:16}),"Add First Line"]})]}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 text-xs font-bold text-gray-500 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:"Phone Number"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Label"}),e.jsx("th",{className:"px-6 py-3 text-center",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-center",children:"Default"}),e.jsx("th",{className:"px-6 py-3 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:m.map(w=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"font-mono text-sm font-medium text-gray-900",children:w.phoneNumber})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("span",{className:"text-sm text-gray-600",children:w.label||"-"}),w.usageType&&e.jsx("span",{className:"ml-2 text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded",children:w.usageType})]}),e.jsx("td",{className:"px-6 py-4 text-center",children:w.status==="active"?e.jsxs("span",{className:"inline-flex items-center gap-1 text-xs font-medium text-green-700 bg-green-50 px-2 py-1 rounded-full",children:[e.jsx(ge,{size:12}),"Active"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 text-xs font-medium text-orange-700 bg-orange-50 px-2 py-1 rounded-full",children:[e.jsx(Le,{size:12}),w.status||"Unknown"]})}),e.jsx("td",{className:"px-6 py-4 text-center",children:w.phoneNumber===g?e.jsxs("span",{className:"inline-flex items-center gap-1 text-xs font-medium text-blue-700 bg-blue-50 px-2 py-1 rounded-full",children:[e.jsx(Ve,{size:12}),"Default"]}):e.jsx("span",{className:"text-gray-300",children:"-"})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsx("button",{onClick:()=>y(w.phoneNumber),disabled:b===w.phoneNumber,className:"text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors disabled:opacity-50",title:"Remove Line",children:b===w.phoneNumber?e.jsx(we,{size:16,className:"animate-spin"}):e.jsx(Ie,{size:16})})})]},w.phoneNumber))})]}),e.jsx("div",{className:"px-6 py-3 bg-gray-50 border-t border-gray-100",children:e.jsxs("p",{className:"text-[10px] text-gray-400 flex items-center gap-1.5",children:[e.jsx(Le,{size:10}),"JWT tokens are encrypted and never exposed to Company Admins"]})}),N&&e.jsx(qt,{companyId:s,onClose:()=>v(!1),onSuccess:()=>{},sharedCredentials:{hasCredentials:i}})]})}function Ht({companyId:s,companyName:r,onBack:a}){const{showSuccess:l,showError:m,showWarning:p}=Ce(),[j,u]=n.useState("ringcentral"),[i,h]=n.useState({isSandbox:!0}),[b,L]=n.useState(!1),[N,v]=n.useState(""),[g,o]=n.useState(!1),[y,w]=n.useState(!1),[x,S]=n.useState(!0),[D,P]=n.useState(null);Bs.useEffect(()=>{if(!s){S(!1);return}(async()=>{S(!0),P(null);try{const c=await be($(k,`companies/${s}/integrations`,"sms_provider"));if(c.exists()){const C=c.data();C.provider&&u(C.provider);const R=C.config?.clientId,A=C.config?.clientSecret,E=!!(R&&R.includes(":"));L(E),h(U=>({...U,isSandbox:C.config?.isSandbox==="true"||C.config?.isSandbox===!0,phoneNumber:C.config?.phoneNumber||"",clientId:"",clientSecret:"",subAccountId:C.config?.subAccountId||""}))}}catch(c){console.error("Error loading existing config:",c),P("Failed to load existing configuration. You can still set up new credentials.")}finally{S(!1)}})()},[s]);const f=(d,c)=>h(C=>({...C,[d]:c})),M=async d=>{if(d.preventDefault(),!s)return m("No company selected. Please go back and select a company first.");o(!0);try{const c={...i},C=c.clientId&&c.clientId.trim()!=="",R=c.clientSecret&&c.clientSecret.trim()!=="";if(b&&!C&&(c.clientId="__PRESERVE__"),b&&!R&&(c.clientSecret="__PRESERVE__"),!b&&(!C||!R)){m("Client ID and Client Secret are required."),o(!1);return}c.phoneNumber&&(c.phoneNumber=c.phoneNumber.replace(/[^\d+]/g,"")),Object.keys(c).forEach(U=>{typeof c[U]!="string"&&c[U]!==null&&(c[U]=String(c[U]))});const E=await B(H,"saveIntegrationConfig")({companyId:s,provider:j,config:c});if(E.data?.warning)p(E.data.warning),l(`Configuration saved. (${E.data.inventoryCount||0} numbers found)`);else{const U=E.data?.syncMeta;let z=`Integration saved and verified successfully. (${E.data.inventoryCount||0} numbers found)`;E.data.inventoryCount===0&&U&&(z+=` - User: ${U.identity||"Unknown"} - Diagnostics: Acc(${U.accCount}) Ext(${U.extCount}) RawTotal(${U.rawCount})`,console.log("RingCentral Diagnostic Meta:",U)),l(z)}}catch(c){console.error(c),m(`Save Failed: ${c.message} `)}finally{o(!1)}},t=async()=>{if(!N)return m("Enter a phone number to test.");w(!0);try{const c=await B(H,"sendTestSMS")({companyId:s,testPhoneNumber:N});c.data.success?l("Test Message Sent!"):m("Test Failed: "+c.data.message)}catch(d){console.error(d);let c=d.message;(d.message.includes("ENOTFOUND")||d.message.includes("network")||d.message.includes("fetch"))&&(c=`The ${j} server appears to be unreachable.This is likely a temporary service or DNS outage at ${j}. Your settings are saved, but testing is currently disabled by the provider.`),m(`Test Failed: ${c} `)}finally{w(!1)}};return x?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm p-10 flex flex-col items-center justify-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-gray-500 font-medium font-inter",children:"Loading existing configuration..."})]}):e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(fe,{className:"text-blue-600",size:24}),e.jsxs("span",{children:["SMS Integration ",e.jsx("span",{className:"text-gray-400 font-normal",children:"for"})," ",r||"Company"]})]}),a&&e.jsxs("button",{onClick:a,className:"flex items-center gap-1 text-sm font-medium text-gray-500 hover:text-gray-800 transition-colors",children:[e.jsx(Hs,{size:16})," Back to List"]})]}),D&&e.jsxs("div",{className:"mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-orange-800 text-sm flex items-center gap-3",children:[e.jsx(Fe,{size:18}),D]}),e.jsxs("form",{onSubmit:M,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Select Provider"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{type:"button",onClick:()=>u("ringcentral"),className:`flex-1 py-3 px-4 rounded-lg border font-medium transition-all ${j==="ringcentral"?"bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500":"bg-white border-gray-300 text-gray-600 hover:bg-gray-50"}`,children:"RingCentral"}),e.jsx("button",{type:"button",onClick:()=>u("8x8"),className:`flex-1 py-3 px-4 rounded-lg border font-medium transition-all ${j==="8x8"?"bg-orange-50 border-orange-500 text-orange-700 ring-1 ring-orange-500":"bg-white border-gray-300 text-gray-600 hover:bg-gray-50"}`,children:"8x8"})]})]}),e.jsxs("div",{className:"bg-gray-50 p-5 rounded-lg border border-gray-200 space-y-4",children:[j==="ringcentral"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800",children:[e.jsx(Ds,{size:14}),e.jsxs("label",{className:"font-bold flex items-center gap-2 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",checked:i.isSandbox||!1,onChange:d=>f("isSandbox",d.target.checked),className:"rounded text-blue-600 focus:ring-blue-500"}),"Use Sandbox Environment (DevTest)"]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:["Client ID",b&&e.jsx("span",{className:"ml-2 text-green-600 font-normal normal-case",children:"âœ“ Saved"})]}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none",value:i.clientId||"",onChange:d=>f("clientId",d.target.value),placeholder:b?"(Leave blank to keep existing)":"Enter Client ID",required:!b})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:["Client Secret",b&&e.jsx("span",{className:"ml-2 text-green-600 font-normal normal-case",children:"âœ“ Saved"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"password",className:"w-full p-2 pl-10 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none",value:i.clientSecret||"",onChange:d=>f("clientSecret",d.target.value),placeholder:b?"(Leave blank to keep existing)":"Enter Client Secret",required:!b}),e.jsx(Oe,{size:16,className:"absolute left-3 top-2.5 text-gray-400"})]})]}),e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-100 rounded text-[11px] text-blue-800",children:[e.jsx("p",{className:"font-bold mb-1",children:"Global Integration Note:"}),"These shared credentials allow the system to interact with your ",j," App. Individual phone lines and their JWTs are managed separately in the ",e.jsx("b",{children:"Digital Wallet"})," section below."]})]}),j==="8x8"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"SubAccount ID"}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none",value:i.subAccountId||"",onChange:d=>f("subAccountId",d.target.value),placeholder:"Enter SubAccount ID",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"API Key"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"password",className:"w-full p-2 pl-10 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none",value:i.apiKey||"",onChange:d=>f("apiKey",d.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",required:!0}),e.jsx(ls,{size:16,className:"absolute left-3 top-2.5 text-gray-400"})]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"tel",placeholder:"+1 (555) 000-0000",className:"p-2 border border-gray-300 rounded w-40 text-sm",value:N,onChange:d=>v(d.target.value)}),e.jsx("button",{type:"button",onClick:t,disabled:y||!N,className:"px-3 py-2 bg-gray-100 text-gray-700 font-bold rounded hover:bg-gray-200 disabled:opacity-50 flex items-center gap-2 text-sm",children:y?"Sending...":e.jsxs(e.Fragment,{children:[e.jsx(tt,{size:14})," Test"]})})]}),e.jsx("button",{type:"submit",disabled:g,className:"px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 disabled:opacity-50 flex items-center gap-2 shadow-sm",children:g?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx(ds,{size:18})," Secure Save"]})})]})]}),j==="ringcentral"&&e.jsx("div",{className:"mt-8 pt-8 border-t border-gray-200",children:e.jsx(Bt,{companyId:s,companyName:r})})]})}function Ot(){const[s,r]=n.useState(!1),[a,l]=n.useState(null),[m,p]=n.useState(""),j=async(i,h)=>{r(!0),p(""),l(null);try{const L=await B(H,"backfillCompanyStats",{timeout:54e4})({companyId:i,dryRun:h});l(L.data)}catch(b){console.error("Backfill error:",b),p(b.message||"Failed to run backfill")}finally{r(!1)}},u=async i=>{r(!0),p(""),l(null);try{const b=await B(H,"backfillAllStats",{timeout:54e4})({dryRun:i});l(b.data)}catch(h){console.error("Backfill All error:",h),p(h.message||"Failed to run backfill")}finally{r(!1)}};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Performance Stats Backfill"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Rebuild stats_daily from all historical activity data. Use dry-run first to preview results."})]}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Ray Star LLC (Test Company)"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Company ID: ",e.jsx("code",{className:"bg-white px-2 py-1 rounded text-xs",children:"iHexmEEmD8ygvL6qZ5Zd"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>j("iHexmEEmD8ygvL6qZ5Zd",!0),disabled:s,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[s?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(Pe,{size:16}),"Dry-Run (Preview)"]}),e.jsxs("button",{onClick:()=>j("iHexmEEmD8ygvL6qZ5Zd",!1),disabled:s,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[s?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(ge,{size:16}),"Run Actual Backfill"]})]})]}),e.jsxs("div",{className:"mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"All Companies"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"âš ï¸ This will process all companies. Only run after verifying Ray Star LLC results."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>u(!0),disabled:s,className:"flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[s?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(Pe,{size:16}),"Dry-Run All"]}),e.jsxs("button",{onClick:()=>u(!1),disabled:s,className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[s?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(ge,{size:16}),"Run All Companies"]})]})]}),m&&e.jsxs("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3",children:[e.jsx(Le,{size:20,className:"text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-red-900 mb-1",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700",children:m})]})]}),a&&e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx(ge,{size:20,className:"text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-green-900 mb-1",children:a.dryRun?"Dry-Run Complete":"Backfill Complete"}),e.jsx("p",{className:"text-sm text-green-700",children:a.dryRun?"Preview generated successfully. No data was modified.":"Stats have been written to Firestore."})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 space-y-2",children:[a.companyId&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Company ID:"}),e.jsx("span",{className:"font-mono text-gray-900",children:a.companyId})]}),a.companiesProcessed&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Companies Processed:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:a.companiesProcessed})]}),a.companiesSucceeded&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Companies Succeeded:"}),e.jsx("span",{className:"font-semibold text-green-600",children:a.companiesSucceeded})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Total Activities Processed:"}),e.jsx("span",{className:"font-semibold text-blue-600",children:a.totalActivitiesProcessed?.toLocaleString()||0})]}),a.legacyCount!==void 0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 pl-4",children:"â†³ Legacy (activities):"}),e.jsx("span",{className:"text-gray-700",children:a.legacyCount.toLocaleString()})]}),a.modernCount!==void 0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 pl-4",children:"â†³ Modern (activity_logs):"}),e.jsx("span",{className:"text-gray-700",children:a.modernCount.toLocaleString()})]}),a.daysWithStats&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Days with Stats:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:a.daysWithStats})]}),a.daysWritten&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Days Written:"}),e.jsx("span",{className:"font-semibold text-green-600",children:a.daysWritten})]})]}),a.preview&&a.preview.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("h5",{className:"text-sm font-semibold text-gray-900 mb-2",children:["Preview (First ",a.preview.length," Days)"]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 max-h-64 overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-gray-700",children:"Date"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-semibold text-gray-700",children:"Dials"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-semibold text-gray-700",children:"Connected"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-semibold text-gray-700",children:"Users"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:a.preview.map((i,h)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 font-mono text-xs",children:i.dateKey}),e.jsx("td",{className:"px-3 py-2 text-right font-semibold",children:i.totalDials}),e.jsx("td",{className:"px-3 py-2 text-right text-green-600",children:i.connected}),e.jsx("td",{className:"px-3 py-2 text-right text-gray-600",children:i.userCount})]},h))})]})})]})]})]})}function Gt(){const[s,r]=n.useState(null),[a,l]=n.useState(null),[m,p]=n.useState([]),[j,u]=n.useState(!0),[i,h]=n.useState(!0),[b,L]=n.useState(!0),[N,v]=n.useState(null),[g,o]=n.useState(!1),[y,w]=n.useState(!1),[x,S]=n.useState(!1),[D,P]=n.useState(!1),[f,M]=n.useState(!1),[t,d]=n.useState(!1),[c,C]=n.useState(!1),[R,A]=n.useState(null),E=n.useCallback(async()=>{u(!0);try{const _=await B(H,"getLeadSupplyAnalytics")();r(_.data)}catch(T){console.error("Supply analytics error:",T),v("Failed to load supply data.")}finally{u(!1)}},[]),U=n.useCallback(async()=>{h(!0);try{const _=await B(H,"getBadLeadsAnalytics")();l(_.data)}catch(T){console.error("Bad leads analytics error:",T)}finally{h(!1)}},[]),z=n.useCallback(async()=>{L(!0);try{const _=await B(H,"getCompanyDistributionStatus")();p(_.data?.companies||[])}catch(T){console.error("Company distribution error:",T)}finally{L(!1)}},[]),I=n.useCallback(()=>{E(),U(),z()},[E,U,z]);return n.useEffect(()=>{const T=os($(k,"system_settings","distribution"),_=>{_.exists()&&d(_.data().maintenance_mode||!1)});return()=>T()},[]),n.useEffect(()=>{I()},[I]),{supplyData:s,badLeadsData:a,companyDistData:m,loadingSupply:j,loadingBadLeads:i,loadingCompanies:b,error:N,distributing:g,cleaning:y,recalling:x,unlocking:D,migrating:f,maintenanceMode:t,savingMaintenance:c,togglingCompany:R,refreshAll:I,toggleCompanyActive:async(T,_,ie)=>{const ue=ie?"deactivate":"activate";if(window.confirm(`${ue.toUpperCase()} "${_}"?

${ie?"This company will stop receiving platform leads.":"This company will start receiving platform leads."}`)){A(T);try{await cs($(k,"companies",T),{isActive:!ie}),z()}catch(re){alert(`Failed to ${ue} company: ${re.message}`)}finally{A(null)}}},handleDistribute:async()=>{if(window.confirm("Force distribute leads to all companies NOW? This will start a new distribution round.")){o(!0);try{const _=await B(H,"distributeDailyLeads",{timeout:6e5})();alert(`âœ… Distribution complete!

${_.data.details?.join(`
`)||_.data.message}`),I()}catch(T){alert(`âŒ Distribution failed: ${T.message}`)}finally{o(!1)}}},handleCleanup:async()=>{if(window.confirm("Remove bad/test leads from the pool? This cannot be undone.")){w(!0);try{const _=await B(H,"cleanupBadLeads",{timeout:54e4})();alert(`âœ… Cleanup complete!

${_.data.message}`),I()}catch(T){alert(`âŒ Cleanup failed: ${T.message}`)}finally{w(!1)}}},handleRecall:async()=>{if(window.confirm(`âš ï¸ RECALL ALL PLATFORM LEADS?

This will DELETE all SafeHaul Network leads from ALL companies and unlock them in the global pool.

This action cannot be undone!`)){S(!0);try{const _=await B(H,"recallAllPlatformLeads",{timeout:6e5})();alert(`âœ… Recall complete!

Deleted: ${_.data.deletedCount} leads
Unlocked: ${_.data.unlockedCount} pool leads`),I()}catch(T){alert(`âŒ Recall failed: ${T.message}`)}finally{S(!1)}}},handleForceUnlock:async()=>{if(window.confirm("Unlock ALL leads in the pool? This makes every lead available for distribution.")){P(!0);try{const _=await B(H,"forceUnlockPool",{timeout:54e4})();alert(`âœ… Pool unlocked!

${_.data.message}`),I()}catch(T){alert(`âŒ Unlock failed: ${T.message}`)}finally{P(!1)}}},handleMigrate:async()=>{if(window.confirm("Migrate drivers collection to leads pool? This imports missing drivers.")){M(!0);try{const _=await B(H,"migrateDriversToLeads",{timeout:54e4})();alert(`âœ… Migration complete!

${_.data.message}`),I()}catch(T){alert(`âŒ Migration failed: ${T.message}`)}finally{M(!1)}}},toggleMaintenance:async()=>{C(!0);try{await ee($(k,"system_settings","distribution"),{maintenance_mode:!t},{merge:!0})}catch(T){alert(`Failed to toggle maintenance: ${T.message}`)}finally{C(!1)}}}}function Be({title:s,value:r,icon:a,color:l="blue",loading:m=!1}){const p={blue:"bg-blue-50 text-blue-600 border-blue-100",green:"bg-green-50 text-green-600 border-green-100",orange:"bg-orange-50 text-orange-600 border-orange-100",red:"bg-red-50 text-red-600 border-red-100",purple:"bg-purple-50 text-purple-600 border-purple-100"};return e.jsx("div",{className:`p-5 rounded-2xl border-2 ${p[l]} transition-all hover:shadow-md`,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold uppercase tracking-wider opacity-60",children:s}),m?e.jsx(O,{className:"animate-spin mt-2",size:24}):e.jsx("p",{className:"text-3xl font-black mt-1",children:r?.toLocaleString()||0})]}),e.jsx("div",{className:"p-2 rounded-lg bg-white/50",children:e.jsx(a,{size:24})})]})})}function ke({label:s,icon:r,onClick:a,loading:l,disabled:m,variant:p="default",danger:j=!1}){const u="flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-semibold transition-all text-sm",i={default:j?"bg-red-600 text-white hover:bg-red-700 disabled:bg-red-300":"bg-slate-900 text-white hover:bg-slate-800 disabled:bg-slate-400",outline:j?"border-2 border-red-300 text-red-600 hover:bg-red-50 disabled:opacity-50":"border-2 border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50",warning:"bg-orange-500 text-white hover:bg-orange-600 disabled:bg-orange-300"};return e.jsxs("button",{onClick:a,disabled:m||l,className:`${u} ${i[p]}`,children:[l?e.jsx(O,{className:"animate-spin",size:18}):e.jsx(r,{size:18}),s]})}function Qt({onDataUpdate:s}){const{supplyData:r,badLeadsData:a,companyDistData:l,loadingSupply:m,loadingBadLeads:p,loadingCompanies:j,error:u,distributing:i,cleaning:h,recalling:b,unlocking:L,migrating:N,maintenanceMode:v,savingMaintenance:g,togglingCompany:o,refreshAll:y,toggleCompanyActive:w,handleDistribute:x,handleCleanup:S,handleRecall:D,handleForceUnlock:P,handleMigrate:f,toggleMaintenance:M}=Gt(),t=r?.health?.status==="deficit",d=i||h||b||L||N;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(fe,{className:"text-blue-600",size:28}),"Lead Pool Management"]}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Manage the global SafeHaul Network lead distribution system"})]}),e.jsx("button",{onClick:y,disabled:m,className:"p-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-all shadow-sm",children:e.jsx(we,{size:20,className:m?"animate-spin text-blue-600":"text-gray-600"})})]}),u&&e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 flex items-center gap-2",children:[e.jsx(De,{size:20}),u]}),v&&e.jsxs("div",{className:"p-4 bg-red-100 border-2 border-red-300 rounded-xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(rs,{className:"text-red-600",size:24}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-red-800",children:"Distribution Paused"}),e.jsx("p",{className:"text-sm text-red-600",children:"Maintenance mode is ON. No leads will be distributed."})]})]}),e.jsx("button",{onClick:M,disabled:g,className:"px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all",children:g?e.jsx(O,{className:"animate-spin",size:18}):"Resume"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Be,{title:"Total in Pool",value:r?.supply?.totalInPool,icon:fe,color:"blue",loading:m}),e.jsx(Be,{title:"Available Now",value:r?.supply?.availableNow,icon:t?Es:Ye,color:t?"red":"green",loading:m}),e.jsx(Be,{title:"Locked",value:r?.supply?.locked,icon:Oe,color:"orange",loading:m}),e.jsx(Be,{title:"Bad Leads",value:a?.stats?.totalBad,icon:De,color:"red",loading:p})]}),r&&e.jsx("div",{className:`p-5 rounded-2xl border-2 ${t?"border-red-200 bg-red-50":"border-green-200 bg-green-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[t?e.jsx(ts,{className:"text-red-600",size:28}):e.jsx(ge,{className:"text-green-600",size:28}),e.jsxs("div",{children:[e.jsx("p",{className:`font-bold text-lg ${t?"text-red-800":"text-green-800"}`,children:t?"SUPPLY SHORTAGE":"HEALTHY SURPLUS"}),e.jsxs("p",{className:`text-sm ${t?"text-red-600":"text-green-600"}`,children:["Daily Demand: ",r.demand.totalDailyQuota," | Available: ",r.supply.availableNow," | Gap: ",r.health.gap>0?"+":"",r.health.gap]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:[r.demand.companiesCount," active companies"]}),e.jsxs("p",{className:"text-sm text-gray-500",children:[r.distribution.totalDistributedInCirculation," leads in circulation"]})]})]})}),e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-200 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4",children:"Actions"}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-3 gap-3",children:[e.jsx(ke,{label:"Distribute Now",icon:Pe,onClick:()=>{x().then(()=>s?.())},loading:i,disabled:d||v}),e.jsx(ke,{label:"Cleanup Bad Leads",icon:Ie,onClick:S,loading:h,disabled:d,variant:"outline"}),e.jsx(ke,{label:"Force Unlock Pool",icon:is,onClick:P,loading:L,disabled:d,variant:"outline"}),e.jsx(ke,{label:"Migrate Drivers",icon:at,onClick:f,loading:N,disabled:d,variant:"outline"}),e.jsx(ke,{label:v?"Resume Distribution":"Pause Distribution",icon:v?Pe:rs,onClick:M,loading:g,disabled:d,variant:v?"default":"warning"}),e.jsx(ke,{label:"Recall All Leads",icon:As,onClick:()=>{D().then(()=>s?.())},loading:b,disabled:d,variant:"outline",danger:!0})]})]}),a&&e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(De,{className:"text-orange-500",size:20}),"Bad Leads Analysis"]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"text-center p-3 bg-red-50 rounded-xl",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600",children:a?.stats?.missingContact||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"No Contact Info"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-50 rounded-xl",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600",children:a?.stats?.testData||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Test Data"})]}),e.jsxs("div",{className:"text-center p-3 bg-orange-50 rounded-xl",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:a?.stats?.missingNames||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Missing Names"})]}),e.jsxs("div",{className:"text-center p-3 bg-orange-50 rounded-xl",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:a?.stats?.placeholderEmails||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Placeholder Emails"})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-50 rounded-xl",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:a?.stats?.shortPhones||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Short Phones"})]}),e.jsxs("div",{className:"text-center p-3 bg-purple-50 rounded-xl",children:[e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:a?.stats?.duplicatePhones||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Duplicates"})]})]})]}),r&&e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(ye,{className:"text-blue-600",size:20}),"Distribution Overview"]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl",children:[e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:r.demand.companiesCount}),e.jsx("p",{className:"text-sm text-gray-500",children:"Active Companies"})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl",children:[e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:r.demand.totalDailyQuota}),e.jsx("p",{className:"text-sm text-gray-500",children:"Daily Demand"})]}),e.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl",children:[e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:r.distribution.totalDistributedInCirculation}),e.jsx("p",{className:"text-sm text-gray-500",children:"Platform Leads"})]}),e.jsxs("div",{className:"p-4 bg-purple-50 rounded-xl",children:[e.jsx("p",{className:"text-3xl font-bold text-purple-600",children:r.distribution.totalPrivateUploads}),e.jsx("p",{className:"text-sm text-gray-500",children:"Private Uploads"})]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(ye,{className:"text-blue-600",size:20}),"Company Distribution Status"]}),j?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(O,{className:"animate-spin text-blue-600",size:32})}):l.length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No company data available"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-700 text-sm",children:"Company"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700 text-sm",children:"Status"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700 text-sm",children:"Daily Quota"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700 text-sm",children:"Platform Leads"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700 text-sm",children:"Private Leads"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700 text-sm",children:"Last Distribution"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700 text-sm",children:"Next in"})]})}),e.jsx("tbody",{children:l.map((c,C)=>{const R=c.isActive,A=c.nextDistribution,E=c.lastDistribution;return e.jsxs("tr",{className:`border-b border-gray-100 hover:bg-gray-50 ${R?"":"opacity-50"}`,children:[e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:c.companyName}),e.jsx("p",{className:"text-xs text-gray-500",children:c.slug})]})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsx("button",{onClick:U=>{U.stopPropagation(),w(c.id,c.companyName,R)},disabled:o===c.id,className:"group relative",title:`Click to ${R?"deactivate":"activate"} this company`,children:o===c.id?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-600 text-xs font-semibold",children:[e.jsx(O,{size:12,className:"animate-spin"}),"Updating..."]}):R?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold hover:bg-green-200 transition-colors cursor-pointer",children:[e.jsx(ge,{size:12}),"Active"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-600 text-xs font-semibold hover:bg-red-200 transition-colors cursor-pointer",children:[e.jsx(ts,{size:12}),"Inactive"]})})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsx("span",{className:"font-semibold text-gray-900",children:c.dailyQuota||0})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsx("span",{className:"font-semibold text-blue-600",children:c.platformLeadsCount||0})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsx("span",{className:"font-semibold text-purple-600",children:c.privateLeadsCount||0})}),e.jsx("td",{className:"py-3 px-4 text-center",children:E?e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-gray-700 font-medium",children:E.date}),e.jsx("p",{className:"text-gray-500 text-xs",children:E.time})]}):e.jsx("span",{className:"text-gray-400 text-sm",children:"Never"})}),e.jsx("td",{className:"py-3 px-4 text-center",children:R&&A?e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"text-gray-700 font-semibold",children:A.countdown}),e.jsx("p",{className:"text-gray-500 text-xs",children:A.exactTime})]}):e.jsx("span",{className:"text-gray-400 text-sm",children:"â€”"})})]},c.id)})})]})})]})]})}const Vt="America/Chicago";function Wt(){const[s,r]=n.useState(!0),[a,l]=n.useState({summary:{totalCalls:0,totalEmails:0,totalApplications:0,activeRecruiters:0},companyPerformance:[],userPerformance:[],dailyTrend:[]}),[m,p]=n.useState("7d"),j=i=>new Intl.DateTimeFormat("en-CA",{timeZone:Vt,year:"numeric",month:"2-digit",day:"2-digit"}).format(i),u=i=>{const h=new Date(i+"T12:00:00Z");return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric"}).format(h)};return n.useEffect(()=>{let i=!0;return(async()=>{r(!0);try{const b=new Date,L=j(b),N=new Date(b);m==="7d"&&N.setDate(N.getDate()-6),m==="30d"&&N.setDate(N.getDate()-29),m==="90d"&&N.setDate(N.getDate()-89);const v=j(N),g=await W(Y(k,"companies"));if(!i)return;let o=0;const y={},w={},x={};let S=new Date(N);const D=new Date(b);for(;S<=D;){const t=u(j(S));x[t]=0,S.setDate(S.getDate()+1)}for(const t of g.docs){const d=t.id,c=t.data().companyName||"Unknown Company",C=Z(Y(k,"companies",d,"stats_daily"),se("__name__",">=",v),se("__name__","<=",L)),R=await W(C);y[d]||(y[d]={companyId:d,companyName:c,callsMade:0,actions:0}),R.forEach(A=>{const E=A.data(),U=A.id,z=u(U),I=E.totalDials||0;o+=I,y[d].callsMade+=I,y[d].actions+=I,x.hasOwnProperty(z)&&(x[z]+=I);const K=E.byUser||{};Object.entries(K).forEach(([V,q])=>{w[V]||(w[V]={userId:V,userName:q.name||"Unknown User",companyName:c,callsMade:0}),w[V].callsMade+=q.dials||0})})}if(!i)return;const P=Object.values(y).filter(t=>t.callsMade>0).sort((t,d)=>d.callsMade-t.callsMade),f=Object.values(w).filter(t=>t.userId!=="system"&&t.userId!=="unknown").sort((t,d)=>d.callsMade-t.callsMade),M=Object.entries(x).map(([t,d])=>({date:t,value:d}));l({summary:{totalCalls:o,totalEmails:0,totalApplications:0,activeRecruiters:f.length},companyPerformance:P,userPerformance:f,dailyTrend:M})}catch(b){console.error("Analytics Error:",b)}finally{i&&r(!1)}})(),()=>{i=!1}},[m]),{loading:s,stats:a,dateRange:m,setDateRange:p}}function Yt(){const[s,r]=n.useState(null),[a,l]=n.useState(!0),[m,p]=n.useState(null),j=async()=>{l(!0),p(null);try{const b=await B(H,"getLeadSupplyAnalytics")();r(b.data)}catch(h){console.error(h),p("Failed to load inventory data.")}finally{l(!1)}};if(n.useEffect(()=>{j()},[]),a)return e.jsxs("div",{className:"p-8 flex flex-col items-center justify-center bg-white rounded-2xl border border-gray-200 shadow-sm h-64",children:[e.jsx(O,{className:"animate-spin text-blue-600 mb-2",size:32}),e.jsx("p",{className:"text-gray-400 text-sm font-medium",children:"Analyzing Lead Supply..."})]});if(m)return e.jsxs("div",{className:"p-6 text-red-600 bg-red-50 rounded-2xl border border-red-100 text-center",children:[e.jsx("p",{className:"font-bold",children:m}),e.jsx("button",{onClick:j,className:"mt-2 text-sm underline hover:text-red-800",children:"Try Again"})]});if(!s)return null;const u=s.health.status==="deficit",i=Math.min(100,Math.round(s.supply.availableNow/(s.demand.totalDailyQuota||1)*100));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(fe,{className:"text-blue-600"})," Supply & Demand"]}),e.jsx("button",{onClick:j,className:"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all",title:"Refresh Data",children:e.jsx(we,{size:18})})]}),e.jsxs("div",{className:`p-6 rounded-2xl border-2 transition-all duration-500 ${u?"border-red-100 bg-gradient-to-br from-red-50 to-white":"border-green-100 bg-gradient-to-br from-green-50 to-white"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:`text-xs font-bold uppercase tracking-wider mb-1 ${u?"text-red-600":"text-green-600"}`,children:"Market Status"}),e.jsx("h3",{className:`text-3xl font-black ${u?"text-red-900":"text-green-900"}`,children:u?"SUPPLY SHORTAGE":"HEALTHY SURPLUS"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:u?`You need ${Math.abs(s.health.gap)} more leads to meet today's quotas.`:`You have enough leads for ${Math.floor(s.supply.availableNow/(s.demand.totalDailyQuota||1))} days.`})]}),e.jsx("div",{className:`p-3 rounded-full shadow-sm ${u?"bg-red-100 text-red-600":"bg-green-100 text-green-600"}`,children:u?e.jsx(Es,{size:32}):e.jsx(Ye,{size:32})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between text-xs font-bold text-gray-500 mb-1",children:[e.jsxs("span",{children:["Demand: ",s.demand.totalDailyQuota]}),e.jsxs("span",{children:["Supply: ",s.supply.availableNow]})]}),e.jsx("div",{className:"w-full h-3 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-1000 ${u?"bg-red-500":"bg-green-500"}`,style:{width:`${i}%`}})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white/80 p-3 rounded-xl border border-gray-100 shadow-sm",children:[e.jsx("span",{className:"block text-gray-400 text-xs font-bold uppercase",children:"Required"}),e.jsx("span",{className:"font-black text-gray-900 text-xl",children:s.demand.totalDailyQuota})]}),e.jsxs("div",{className:"bg-white/80 p-3 rounded-xl border border-gray-100 shadow-sm",children:[e.jsx("span",{className:"block text-gray-400 text-xs font-bold uppercase",children:"Available"}),e.jsx("span",{className:"font-black text-gray-900 text-xl",children:s.supply.availableNow})]}),e.jsxs("div",{className:"bg-white/80 p-3 rounded-xl border border-gray-100 shadow-sm",children:[e.jsx("span",{className:"block text-gray-400 text-xs font-bold uppercase",children:"Net Gap"}),e.jsxs("span",{className:`font-black text-xl ${u?"text-red-600":"text-green-600"}`,children:[s.health.gap>0?"+":"",s.health.gap]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white p-5 rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsxs("h4",{className:"font-bold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ye,{size:18,className:"text-blue-600"})," Global Pool"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Total Leads in DB"}),e.jsx("span",{className:"font-medium text-gray-900",children:s.supply.totalInPool})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Currently Locked (In Use)"}),e.jsx("span",{className:"font-medium text-orange-600",children:s.supply.locked})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Fresh / Unlocked"}),e.jsx("span",{className:"font-bold text-green-600",children:s.supply.availableNow})]})]})]}),e.jsxs("div",{className:"bg-white p-5 rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsxs("h4",{className:"font-bold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx($e,{size:18,className:"text-purple-600"})," Distribution"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Active Companies"}),e.jsx("span",{className:"font-medium text-gray-900",children:s.demand.companiesCount})]}),e.jsx("div",{className:"border-t border-gray-100 my-2"}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Private Uploads"}),e.jsx("span",{className:"font-bold text-purple-600",children:s.distribution.totalPrivateUploads})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Platform Leads"}),e.jsx("span",{className:"font-bold text-blue-600",children:s.distribution.totalDistributedInCirculation})]})]})]})]})]})}function He({title:s,value:r,icon:a,colorClass:l,trend:m}){return e.jsxs("div",{className:"bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider mb-1",children:s}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900",children:r}),m&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-xs font-medium text-green-600 bg-green-50 w-fit px-2 py-0.5 rounded",children:[e.jsx(Ye,{size:12}),e.jsx("span",{children:m})]})]}),e.jsx("div",{className:`p-3 rounded-lg ${l}`,children:e.jsx(a,{size:20})})]})}function Zt({data:s}){if(!s||s.length===0)return e.jsx("div",{className:"h-48 flex items-center justify-center text-gray-400 text-sm",children:"No data available"});const r=200,a=800,l=20,m=Math.max(...s.map(j=>j.value),5),p=s.map((j,u)=>{const i=u/(s.length-1)*(a-l*2)+l,h=r-j.value/m*(r-l*2)-l;return`${i},${h}`}).join(" ");return e.jsx("div",{className:"w-full h-64 overflow-hidden",children:e.jsxs("svg",{viewBox:`0 0 ${a} ${r}`,className:"w-full h-full overflow-visible",children:[[0,.25,.5,.75,1].map(j=>e.jsx("line",{x1:l,y1:r-j*(r-l*2)-l,x2:a-l,y2:r-j*(r-l*2)-l,stroke:"#f3f4f6",strokeWidth:"1"},j)),e.jsx("polyline",{fill:"none",stroke:"#2563eb",strokeWidth:"3",points:p,strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("polygon",{fill:"url(#gradient)",points:`${l},${r-l} ${p} ${a-l},${r-l}`,opacity:"0.1"}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"gradient",x1:"0",x2:"0",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#2563eb"}),e.jsx("stop",{offset:"100%",stopColor:"white"})]})}),e.jsx("text",{x:l,y:r,className:"text-[10px] fill-gray-400",children:s[0]?.date}),e.jsx("text",{x:a/2,y:r,className:"text-[10px] fill-gray-400 text-anchor-middle",children:s[Math.floor(s.length/2)]?.date}),e.jsx("text",{x:a-l,y:r,className:"text-[10px] fill-gray-400 text-anchor-end",children:s[s.length-1]?.date})]})})}function Kt(){const{loading:s,stats:r,dateRange:a,setDateRange:l}=Wt(),[m,p]=n.useState("overview"),j=()=>{let u=[],i=[],h="export.csv";m==="users"?(u=["Recruiter Name","Company","Calls Made","Last Active"],i=r.userPerformance.map(v=>[v.userName,v.companyName,v.callsMade,v.lastActive?new Date(v.lastActive.seconds*1e3).toLocaleString():"N/A"]),h=`recruiter_performance_${a}.csv`):(u=["Company Name","Calls Made","Total Actions"],i=r.companyPerformance.map(v=>[v.companyName,v.callsMade,v.actions]),h=`company_performance_${a}.csv`);const b="data:text/csv;charset=utf-8,"+[u,...i].map(v=>v.join(",")).join(`
`),L=encodeURI(b),N=document.createElement("a");N.setAttribute("href",L),N.setAttribute("download",h),document.body.appendChild(N),N.click(),document.body.removeChild(N)};return s?e.jsx("div",{className:"p-12 text-center text-gray-500",children:"Loading analytics..."}):e.jsxs("div",{className:"space-y-6 h-full flex flex-col",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm shrink-0",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(ks,{className:"text-blue-600"})," Platform Analytics"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Monitor usage and performance across all companies."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"flex bg-gray-100 p-1 rounded-lg",children:["7d","30d","90d"].map(u=>e.jsx("button",{onClick:()=>l(u),className:`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${a===u?"bg-white text-blue-700 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:u.toUpperCase()},u))}),e.jsxs("button",{onClick:j,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 transition shadow-sm",children:[e.jsx(rt,{size:16})," Export ",m==="users"?"Recruiters":"Companies"]})]})]}),e.jsx("div",{className:"shrink-0",children:e.jsx(Yt,{})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 shrink-0",children:[e.jsx(He,{title:"Total Calls",value:r.summary.totalCalls,icon:Ae,colorClass:"bg-blue-100 text-blue-600",trend:"Real-time"}),e.jsx(He,{title:"Active Companies",value:r.companyPerformance.length,icon:ye,colorClass:"bg-purple-100 text-purple-600",trend:"Active"}),e.jsx(He,{title:"Active Recruiters",value:r.summary.activeRecruiters,icon:Ve,colorClass:"bg-orange-100 text-orange-600",trend:"This Period"}),e.jsx(He,{title:"Platform Health",value:"100%",icon:Qe,colorClass:"bg-yellow-100 text-yellow-600",trend:"Operational"})]}),e.jsxs("div",{className:"flex-1 min-h-0 bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex border-b border-gray-200 px-6 pt-2 overflow-x-auto",children:[e.jsx("button",{onClick:()=>p("overview"),className:`py-3 px-4 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${m==="overview"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-800"}`,children:"Activity Overview"}),e.jsx("button",{onClick:()=>p("companies"),className:`py-3 px-4 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${m==="companies"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-800"}`,children:"Company Performance"}),e.jsx("button",{onClick:()=>p("users"),className:`py-3 px-4 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${m==="users"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-800"}`,children:"Recruiter Stats"})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 bg-gray-50",children:[m==="overview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm",children:[e.jsxs("h4",{className:"text-sm font-bold text-gray-800 mb-6 flex items-center gap-2",children:[e.jsx(Ye,{size:16,className:"text-blue-500"})," Daily Activity Trend"]}),e.jsx(Zt,{data:r.dailyTrend})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-800 mb-4",children:"Top Companies (By Calls)"}),e.jsxs("div",{className:"space-y-4",children:[r.companyPerformance.slice(0,5).map((u,i)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-xs",children:i+1}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:u.companyName})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-2 w-24 bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 rounded-full",style:{width:`${u.callsMade/(r.summary.totalCalls||1)*100}%`}})}),e.jsxs("span",{className:"text-xs font-bold text-gray-600",children:[u.callsMade," calls"]})]})]},i)),r.companyPerformance.length===0&&e.jsx("p",{className:"text-xs text-gray-400 italic",children:"No data yet."})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-gray-200 shadow-sm",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-800 mb-4",children:"Top Recruiters (By Calls)"}),e.jsxs("div",{className:"space-y-4",children:[r.userPerformance.slice(0,5).map((u,i)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 font-bold text-xs",children:i+1}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:u.userName}),e.jsx("p",{className:"text-[10px] text-gray-400",children:u.companyName})]})]}),e.jsxs("span",{className:"text-xs font-bold text-gray-600",children:[u.callsMade," calls"]})]},i)),r.userPerformance.length===0&&e.jsx("p",{className:"text-xs text-gray-400 italic",children:"No data yet."})]})]})]})]}),m==="companies"&&e.jsx("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 text-xs font-bold text-gray-500 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 border-b border-gray-200",children:"Company"}),e.jsx("th",{className:"px-6 py-4 border-b border-gray-200 text-center",children:"Calls Made"}),e.jsx("th",{className:"px-6 py-4 border-b border-gray-200 text-center",children:"Total Actions"}),e.jsx("th",{className:"px-6 py-4 border-b border-gray-200 text-right",children:"Engagement"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[r.companyPerformance.map(u=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 font-medium text-gray-900",children:u.companyName}),e.jsx("td",{className:"px-6 py-4 text-center text-gray-600",children:u.callsMade}),e.jsx("td",{className:"px-6 py-4 text-center text-gray-600",children:u.actions}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-bold ${u.callsMade>20?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"}`,children:[u.callsMade>20?"High":"Low"," ",e.jsx(ot,{size:12})]})})]},u.companyId)),r.companyPerformance.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-6 text-center text-gray-400 italic",children:"No data found for this period."})})]})]})}),m==="users"&&e.jsx("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 text-xs font-bold text-gray-500 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 border-b border-gray-200",children:"Recruiter Name"}),e.jsx("th",{className:"px-6 py-4 border-b border-gray-200",children:"Company"}),e.jsx("th",{className:"px-6 py-4 border-b border-gray-200 text-center",children:"Calls Made"}),e.jsx("th",{className:"px-6 py-4 border-b border-gray-200 text-right",children:"Last Active"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[r.userPerformance.map(u=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 font-bold text-gray-900",children:u.userName}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:u.companyName}),e.jsx("td",{className:"px-6 py-4 text-center text-blue-600 font-mono font-bold",children:u.callsMade}),e.jsx("td",{className:"px-6 py-4 text-right text-sm text-gray-500",children:u.lastActive?.toDate?u.lastActive.toDate().toLocaleString():"Unknown"})]},u.userId)),r.userPerformance.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"p-6 text-center text-gray-400 italic",children:"No activity found for this period."})})]})]})})]})]})]})}const Jt=({type:s})=>{switch(s){case"Company App":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200",children:[e.jsx(je,{size:12})," Direct App"]});case"Global Pool":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200",children:[e.jsx(Qe,{size:12})," Global Pool"]});case"Distributed Lead":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 border border-indigo-200",children:[e.jsx(Nt,{size:12})," Distributed"]});case"Company Import":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200",children:[e.jsx($e,{size:12})," Company Import"]});default:return e.jsx("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600",children:s})}};function Xt({allApplications:s,allCompaniesMap:r,onAppClick:a,onDataUpdate:l,loadMore:m,hasMore:p}){const{showSuccess:j,showError:u}=Ce(),[i,h]=n.useState(""),[b,L]=n.useState("All"),[N,v]=n.useState({key:"date",direction:"desc"}),[g,o]=n.useState(null),[y,w]=n.useState(1),[x,S]=n.useState(50),D=n.useMemo(()=>{let t=[...s];if(i){const d=i.toLowerCase();t=t.filter(c=>{const C=`${c.firstName||""} ${c.lastName||""}`.toLowerCase(),R=(c.email||"").toLowerCase(),A=(c.phone||"").toLowerCase(),E=(r.get(c.companyId)||"").toLowerCase();return C.includes(d)||R.includes(d)||A.includes(d)||E.includes(d)})}return b!=="All"&&(t=t.filter(d=>d.sourceType===b)),t.sort((d,c)=>{const C=d.createdAt?.seconds||0,R=c.createdAt?.seconds||0;if(N.key==="date")return N.direction==="asc"?C-R:R-C;if(N.key==="name"){const A=`${d.firstName} ${d.lastName}`,E=`${c.firstName} ${c.lastName}`;return N.direction==="asc"?A.localeCompare(E):E.localeCompare(A)}return 0}),t},[s,i,b,N,r]),P=Math.ceil(D.length/x),f=n.useMemo(()=>{const t=(y-1)*x;return D.slice(t,t+x)},[D,y,x]),M=async(t,d)=>{if(t.stopPropagation(),!!window.confirm(`SUPER ADMIN WARNING:

Are you sure you want to PERMANENTLY DELETE this record for ${d.firstName} ${d.lastName}?

This will remove it from the source collection. This cannot be undone.`)){o(d.id);try{let c;if(d.sourceType==="Global Pool"||d.sourceType==="Bulk Lead")c=$(k,"leads",d.id);else if(d.companyId&&d.companyId!=="general-leads"){const C=d.sourceType==="Company App"?"applications":"leads";c=$(k,"companies",d.companyId,C,d.id)}else c=$(k,"leads",d.id);await he(c),j("Record deleted successfully."),l()}catch(c){console.error("Delete failed:",c),u("Failed to delete. Check console.")}finally{o(null)}}};return e.jsxs("div",{className:"space-y-6 h-full flex flex-col",children:[e.jsxs("div",{className:"bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row gap-4 justify-between items-end md:items-center shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Unified Driver Database"}),e.jsxs("p",{className:"text-sm text-gray-500",children:[D.length," records found across all systems"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full md:w-auto",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Re,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Global Search...",className:"pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-64",value:i,onChange:t=>h(t.target.value)})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Os,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsxs("select",{className:"pl-9 pr-8 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none appearance-none",value:b,onChange:t=>L(t.target.value),children:[e.jsx("option",{value:"All",children:"All Sources"}),e.jsx("option",{value:"Global Pool",children:"Global Pool"}),e.jsx("option",{value:"Company App",children:"Direct Applications"}),e.jsx("option",{value:"Distributed Lead",children:"Distributed Leads"}),e.jsx("option",{value:"Company Import",children:"Company Imports"})]})]})]})]}),e.jsxs("div",{className:"flex-1 bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col",children:[e.jsx("div",{className:"overflow-auto flex-1",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10 shadow-sm text-xs font-bold text-gray-500 uppercase tracking-wider",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Driver"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Source / Type"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Owner"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Status"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Date"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200 text-right",children:"Admin"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[f.map(t=>e.jsxs("tr",{onClick:()=>a(t),className:"hover:bg-blue-50 cursor-pointer transition-colors group",children:[e.jsxs("td",{className:"px-6 py-3",children:[e.jsxs("div",{className:"font-bold text-gray-900",children:[t.firstName," ",t.lastName]}),e.jsx("div",{className:"text-xs text-gray-400 font-mono flex gap-2",children:t.email})]}),e.jsx("td",{className:"px-6 py-3",children:e.jsx(Jt,{type:t.sourceType})}),e.jsx("td",{className:"px-6 py-3",children:e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:r.get(t.companyId)||(t.companyId==="general-leads"?"System (Unassigned)":t.companyId)})}),e.jsx("td",{className:"px-6 py-3",children:e.jsx("span",{className:"inline-block px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600 border-gray-200",children:t.status||"New"})}),e.jsx("td",{className:"px-6 py-3 text-sm text-gray-500",children:t.createdAt?.seconds?new Date(t.createdAt.seconds*1e3).toLocaleDateString():"--"}),e.jsx("td",{className:"px-6 py-3 text-right",onClick:d=>d.stopPropagation(),children:e.jsx("button",{onClick:d=>M(d,t),disabled:g===t.id,className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"Delete Permanently",children:g===t.id?e.jsx(O,{size:16,className:"animate-spin"}):e.jsx(Ie,{size:16})})})]},t.id)),D.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"p-10 text-center text-gray-400",children:"No drivers found matching your search."})})]})]})}),e.jsxs("div",{className:"p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center text-sm text-gray-600",children:[e.jsxs("div",{children:["Showing ",f.length," of ",D.length]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{disabled:y===1,onClick:()=>w(t=>t-1),className:"px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50",children:"Prev"}),e.jsx("button",{disabled:y===P,onClick:()=>w(t=>t+1),className:"px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50",children:"Next"})]})]})]})]})}const fs={version:"2.0.0",sections:[{id:"personalInfo",title:"Personal Information",stepNumber:1,order:0,fields:[{key:"firstName",label:"First Name",type:"text",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(a)",canCompanyHide:!1,canCompanyModify:!1,placeholder:"John"},{key:"middleName",label:"Middle Name",type:"text",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!0,placeholder:"M"},{key:"lastName",label:"Last Name",type:"text",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(a)",canCompanyHide:!1,canCompanyModify:!1,placeholder:"Doe"},{key:"suffix",label:"Suffix",type:"text",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!0,placeholder:"Jr."},{key:"known-by-other-name",label:"Known by other name(s)?",type:"checkbox",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!0},{key:"otherName",label:"Other Name(s)",type:"text",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!0,dependsOn:"known-by-other-name",showWhen:"yes"},{key:"ssn",label:"Social Security Number",type:"text",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!1,placeholder:"XXX-XX-XXXX",helpText:"Required for background check"},{key:"dob",label:"Date of Birth",type:"date",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(a)",canCompanyHide:!1,canCompanyModify:!1,helpText:"Must be at least 21 for interstate"},{key:"phone",label:"Phone",type:"tel",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(a)",canCompanyHide:!1,canCompanyModify:!1,placeholder:"(555) 555-5555"},{key:"email",label:"Email",type:"email",required:!0,dotRequired:!1,canCompanyHide:!1,canCompanyModify:!1,placeholder:"you@example.com"},{key:"sms-consent",label:"Can we send you SMS messages?",type:"radio",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!0,options:[{label:"Yes",value:"yes"},{label:"No",value:"no"}]},{key:"referralSource",label:"How did you hear about us?",type:"text",required:!1,dotRequired:!1,canCompanyHide:!0,canCompanyModify:!0,placeholder:"e.g. Facebook, Indeed, Friend..."}]},{id:"currentAddress",title:"Current Address",stepNumber:1,order:1,fields:[{key:"street",label:"Address 1",type:"text",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(1)",canCompanyHide:!1,canCompanyModify:!1,placeholder:"123 Main St"},{key:"city",label:"City",type:"text",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(1)",canCompanyHide:!1,canCompanyModify:!1},{key:"state",label:"State",type:"select",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(1)",canCompanyHide:!1,canCompanyModify:!1},{key:"zip",label:"ZIP Code",type:"text",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(1)",canCompanyHide:!1,canCompanyModify:!1,placeholder:"12345"},{key:"residence-3-years",label:"Lived at this residence for 3 years or more?",type:"radio",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(2)",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Yes",value:"yes"},{label:"No",value:"no"}],helpText:"DOT requires 3 years of address history"}]},{id:"qualifications",title:"Qualification Information",stepNumber:2,order:0,fields:[{key:"legal-work",label:"Legally eligible to work in the U.S.?",type:"radio",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(8)",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Yes",value:"yes"},{label:"No",value:"no"}]},{key:"english-fluency",label:"Can you read, write, speak and understand English?",type:"radio",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.11(b)(2)",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Yes",value:"yes"},{label:"No",value:"no"}]}]},{id:"drugAlcohol",title:"Drug & Alcohol History",stepNumber:2,order:1,fields:[{key:"drug-test-positive",label:"Have you ever tested positive or refused a DOT drug/alcohol test?",type:"radio",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 40.25(j)",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Yes",value:"yes"},{label:"No",value:"no"}]},{key:"drug-test-explanation",label:"Please explain",type:"textarea",required:!1,dotRequired:!1,canCompanyHide:!1,canCompanyModify:!0,dependsOn:"drug-test-positive",showWhen:"yes"},{key:"dot-return-to-duty",label:"Can you provide documentation for DOT return to duty process?",type:"radio",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 40.285",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Yes",value:"yes"},{label:"No",value:"no"}]}]},{id:"license",title:"License Information",stepNumber:3,order:0,fields:[{key:"cdlState",label:"License State",type:"select",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(3)",canCompanyHide:!1,canCompanyModify:!1},{key:"cdlClass",label:"License Class",type:"radio",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(3)",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Class A",value:"Class A"},{label:"Class B",value:"Class B"},{label:"Class C",value:"Class C"},{label:"Non-CDL",value:"Non-CDL"}]},{key:"cdlNumber",label:"License Number",type:"text",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(3)",canCompanyHide:!1,canCompanyModify:!1},{key:"cdlExpiration",label:"License Expiration",type:"date",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(3)",canCompanyHide:!1,canCompanyModify:!1},{key:"endorsements",label:"Endorsements",type:"checkboxes",required:!1,dotRequired:!0,fmcsaReference:"49 CFR 391.21(b)(3)",canCompanyHide:!1,canCompanyModify:!1,options:[{label:"Hazmat (H)",value:"H"},{label:"Tanker (N)",value:"N"},{label:"Doubles/Triples (T)",value:"T"},{label:"Passenger (P)",value:"P"},{label:"School Bus (S)",value:"S"}]}]},{id:"consent",title:"Certification & Signature",stepNumber:9,order:0,fields:[{key:"final-certification",label:"I certify that all information is true and complete",type:"checkbox",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(e)",canCompanyHide:!1,canCompanyModify:!1},{key:"signature",label:"Signature",type:"signature",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(e)",canCompanyHide:!1,canCompanyModify:!1},{key:"signature-date",label:"Date",type:"date",required:!0,dotRequired:!0,fmcsaReference:"49 CFR 391.21(e)",canCompanyHide:!1,canCompanyModify:!1}]}]},ys="system_settings",js="application_schema";function ea(){const{currentUser:s}=Ss(),[r,a]=n.useState(null),[l,m]=n.useState(!0),[p,j]=n.useState(null),[u,i]=n.useState(!1),h=n.useCallback(async()=>{m(!0),j(null);try{const o=$(k,ys,js),y=await be(o);y.exists()?a(y.data()):(console.log("[useGlobalSchema] No schema found, seeding..."),await ee(o,{...fs,createdAt:me(),updatedAt:me()}),a(fs))}catch(o){console.error("[useGlobalSchema] Error fetching schema:",o),j(o.message)}finally{m(!1)}},[]);n.useEffect(()=>{h()},[h]);const b=n.useCallback(async o=>{i(!0),j(null);try{const y=$(k,ys,js),w=r?.version||"1.0.0",[x,S,D]=w.split(".").map(Number),P=`${x}.${S}.${D+1}`,f={...o,version:P,updatedAt:me(),updatedBy:s?.uid||"unknown"};return await ee(y,f),a(f),{success:!0,version:P}}catch(y){return console.error("[useGlobalSchema] Error saving schema:",y),j(y.message),{success:!1,error:y.message}}finally{i(!1)}},[r,s]),L=n.useCallback((o,y)=>{if(!r)return;const w=r.sections.map(x=>x.id===o?{...x,fields:y}:x);a({...r,sections:w})},[r]),N=n.useCallback((o,y)=>{if(!r)return;const w=r.sections.map(x=>x.id===o?{...x,fields:[...x.fields||[],y]}:x);a({...r,sections:w})},[r]),v=n.useCallback((o,y)=>{if(!r)return{success:!1,error:"No schema loaded"};if(r.sections.find(D=>D.id===o)?.fields?.find(D=>D.key===y)?.dotRequired)return{success:!1,error:"Cannot delete DOT-required field"};const S=r.sections.map(D=>D.id===o?{...D,fields:D.fields.filter(P=>P.key!==y)}:D);return a({...r,sections:S}),{success:!0}},[r]),g=n.useCallback(()=>r?r.sections.flatMap(o=>(o.fields||[]).map(y=>({...y,sectionId:o.id,sectionTitle:o.title,stepNumber:o.stepNumber}))):[],[r]);return{schema:r,loading:l,error:p,saving:u,saveSchema:b,updateSection:L,addField:N,deleteField:v,getAllFields:g,refetch:h}}function sa(){const{schema:s,loading:r,error:a,saving:l,saveSchema:m,refetch:p}=ea(),[j,u]=n.useState(!1),[i,h]=n.useState(null),b=n.useMemo(()=>i!==null?i:s?.sections?s.sections.flatMap((v,g)=>(v.fields||[]).map((o,y)=>({...o,id:o.key,sectionId:v.id,sectionTitle:v.title,stepNumber:v.stepNumber,order:g*100+y}))):[],[s,i]),L=v=>{h(v),u(!1)},N=async()=>{if(!s)return;const v=new Map;for(const y of i||b){const w=y.sectionId||"custom";if(!v.has(w)){const f=s.sections.find(M=>M.id===w);v.set(w,{id:w,title:f?.title||y.sectionTitle||"Custom Questions",stepNumber:f?.stepNumber||y.stepNumber||8,order:f?.order||99,fields:[]})}const{sectionId:x,sectionTitle:S,order:D,...P}=y;v.get(w).fields.push(P)}const g={...s,sections:Array.from(v.values())};(await m(g)).success&&(u(!0),h(null),setTimeout(()=>u(!1),3e3))};return r?e.jsxs("div",{className:"flex items-center justify-center py-20",children:[e.jsx(O,{className:"animate-spin text-blue-600",size:40}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading global schema..."})]}):a?e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-xl p-6 text-center",children:[e.jsx(Le,{className:"mx-auto text-red-500 mb-3",size:40}),e.jsx("h3",{className:"text-lg font-bold text-red-700",children:"Failed to load schema"}),e.jsx("p",{className:"text-red-600 text-sm mb-4",children:a}),e.jsxs("button",{onClick:p,className:"inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:[e.jsx(we,{size:16})," Retry"]})]}):e.jsxs("div",{className:"p-6 max-w-5xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Global Application Questions"}),e.jsxs("p",{className:"text-gray-500",children:["Define the standard questions asked to all drivers.",s?.version&&e.jsxs("span",{className:"ml-2 text-xs bg-gray-100 px-2 py-0.5 rounded",children:["v",s.version]})]})]}),j&&e.jsxs("div",{className:"flex items-center gap-2 text-green-600 bg-green-50 px-4 py-2 rounded-lg",children:[e.jsx(ge,{size:18}),e.jsx("span",{className:"font-medium",children:"Saved successfully!"})]})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-3 text-xs",children:[e.jsx("span",{className:"inline-flex items-center gap-1 bg-amber-100 text-amber-700 px-2 py-1 rounded",children:"ðŸ›¡ï¸ DOT Required = FMCSA mandated"}),e.jsx("span",{className:"inline-flex items-center gap-1 bg-gray-100 text-gray-600 px-2 py-1 rounded",children:"ðŸ”’ Locked = Companies cannot hide"}),e.jsx("span",{className:"inline-flex items-center gap-1 bg-blue-50 text-blue-600 px-2 py-1 rounded",children:"ðŸ“ Editable = Label can be customized"})]})]}),e.jsx(Vs,{questions:b,onChange:L,onSave:N,loading:l})]})}function ta({isSearching:s,activeView:r,setActiveView:a,searchResults:l,totalSearchResults:m,allCompaniesMap:p,stats:j,statsError:u,listLoading:i,companyList:h,userList:b,allApplications:L,onViewApps:N,onEditCompany:v,onEditUser:g,onAppClick:o,onDeleteCompany:y,onDeleteUser:w,onDataUpdate:x,loadMore:S,hasMoreCompanies:D,hasMoreApps:P,selectedIntegrationCompany:f,onSelectIntegrationCompany:M,onBackToIntegrations:t}){if(s)return e.jsx(Pt,{results:l,totalResults:m,allCompaniesMap:p,onViewApps:N,onEditCompany:v,onEditUser:g,onAppClick:o});switch(r){case"dashboard":return e.jsx(It,{stats:j,statsLoading:i,statsError:u});case"analytics":return e.jsx(Kt,{});case"lead-pool":return e.jsx(Qt,{onDataUpdate:x});case"companies":return e.jsx(hs,{listLoading:i,statsError:u,companyList:h,onViewApps:N,onEdit:v,onDelete:y,loadMore:S,hasMore:D});case"users":return e.jsx(zt,{listLoading:i,statsError:u,userList:b,allCompaniesMap:p,onEdit:g,onDelete:w});case"applications":return e.jsx(Xt,{allApplications:L,allCompaniesMap:p,onAppClick:o,onDataUpdate:x,loadMore:S,hasMore:P});case"features":return e.jsx($t,{companyList:h,onDataUpdate:x});case"system-health":return e.jsx(Ut,{});case"bulk-lead-adding":return e.jsx(Mt,{onDataUpdate:x,onClose:()=>a("dashboard")});case"create":return e.jsx(_t,{allCompaniesMap:p,onDataUpdate:x});case"integrations":return e.jsx(hs,{listLoading:i,statsError:u,companyList:h,onViewApps:N,onEdit:M,onDelete:y,loadMore:S,hasMore:D,isIntegrationMode:!0});case"integration-setup":return e.jsx(Ht,{companyId:f?.id,companyName:f?.companyName,onBack:t});case"stats-backfill":return e.jsx(Ot,{});case"questions":return e.jsx(sa,{});default:return null}}function ve({id:s,label:r,...a}){return e.jsxs("div",{children:[e.jsx("label",{htmlFor:s,className:"block text-sm font-medium text-gray-700 mb-1",children:r}),e.jsx("input",{id:s,className:"w-full p-3 border border-gray-300 rounded-lg",...a})]})}function aa({companyDoc:s,onClose:r,onSave:a}){const[l,m]=n.useState({}),[p,j]=n.useState(null),[u,i]=n.useState(""),[h,b]=n.useState(!1),[L,N]=n.useState(""),[v,g]=n.useState("");n.useEffect(()=>{if(s){const x=s.data();m({companyName:x.companyName||"",appSlug:x.appSlug||"",phone:x.contact?.phone||"",email:x.contact?.email||"",street:x.address?.street||"",city:x.address?.city||"",state:x.address?.state||"",zip:x.address?.zip||"",mcNumber:x.legal?.mcNumber||"",dotNumber:x.legal?.dotNumber||"",companyLogoUrl:x.companyLogoUrl||"",planType:x.planType||"free"}),i(x.appSlug||"")}},[s]);const o=x=>{const{id:S,value:D}=x.target;m(P=>({...P,[S]:D}))},y=x=>{x.target.files[0]?j(x.target.files[0]):j(null)},w=async()=>{b(!0),N(""),g("");let x=l.companyLogoUrl;try{p&&(N("Uploading logo..."),x=await nt(s.id,p));const S={companyName:l.companyName,appSlug:l.appSlug.toLowerCase().trim(),address:{street:l.street,city:l.city,state:l.state.toUpperCase(),zip:l.zip},contact:{phone:l.phone,email:l.email},legal:{mcNumber:l.mcNumber,dotNumber:l.dotNumber},companyLogoUrl:x,planType:l.planType};N("Saving company data..."),await Gs(s.id,S,u),N("Successfully saved!"),g("success"),await a(),setTimeout(r,1500)}catch(S){console.error("Error updating company:",S),N(S.message),g("error")}finally{b(!1)}};return e.jsx("div",{id:"edit-company-modal",className:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-200",children:[e.jsxs("header",{className:"p-5 border-b border-gray-200 flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Edit Company"}),e.jsx("button",{className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full",onClick:r,children:e.jsx(Se,{size:20})})]}),e.jsxs("div",{className:"p-5 overflow-y-auto space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 text-blue-800 font-bold",children:[e.jsx(lt,{size:20})," Subscription Plan"]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all ${l.planType==="free"?"bg-white border-blue-500 ring-2 ring-blue-200":"bg-white border-gray-200 hover:border-blue-300"}`,children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Free Plan",e.jsx("br",{}),e.jsx("span",{className:"text-xs text-gray-500",children:"50 Leads/Day"})]}),e.jsx("input",{type:"radio",name:"planType",id:"planType",value:"free",checked:l.planType==="free",onChange:x=>m({...l,planType:"free"}),className:"h-4 w-4 text-blue-600"})]}),e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all ${l.planType==="paid"?"bg-white border-green-500 ring-2 ring-green-200":"bg-white border-gray-200 hover:border-green-300"}`,children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Paid Plan",e.jsx("br",{}),e.jsx("span",{className:"text-xs text-gray-500",children:"200 Leads/Day"})]}),e.jsx("input",{type:"radio",name:"planType",id:"planType",value:"paid",checked:l.planType==="paid",onChange:x=>m({...l,planType:"paid"}),className:"h-4 w-4 text-green-600"})]})]})]}),e.jsx("hr",{className:"border-gray-100"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(ve,{id:"companyName",label:"Company Name",required:!0,value:l.companyName,onChange:o}),e.jsx(ve,{id:"appSlug",label:"Unique URL Slug",required:!0,value:l.appSlug,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"logo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Company Logo"}),e.jsxs("div",{className:"flex items-center gap-4",children:[l.companyLogoUrl&&e.jsx("img",{src:l.companyLogoUrl,alt:"Current Logo",className:"w-16 h-16 object-contain rounded-lg border border-gray-200 p-1 bg-gray-50"}),e.jsx("input",{type:"file",id:"logo",className:"w-full p-3 border border-gray-300 rounded-lg",onChange:y,accept:"image/png, image/jpeg"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(ve,{id:"phone",label:"Contact Phone",type:"tel",value:l.phone,onChange:o}),e.jsx(ve,{id:"email",label:"Contact Email",type:"email",value:l.email,onChange:o})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(ve,{id:"city",label:"City",value:l.city,onChange:o}),e.jsx(ve,{id:"state",label:"State",value:l.state,onChange:o,maxLength:"2"}),e.jsx(ve,{id:"zip",label:"ZIP Code",value:l.zip,onChange:o})]})]}),e.jsxs("footer",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center rounded-b-xl",children:[e.jsx("p",{className:`text-sm ${v==="success"?"text-green-600":"text-red-600"}`,children:L}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{className:"px-5 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-all",onClick:r,children:"Cancel"}),e.jsx("button",{className:"px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all shadow-md",onClick:w,disabled:h,children:h?"Saving...":"Save Changes"})]})]})]})})}function ra({companyId:s,companyName:r,onClose:a}){const[l,m]=n.useState(!0),[p,j]=n.useState([]),[u,i]=n.useState(""),[h,b]=n.useState("");n.useEffect(()=>{async function o(){if(s){m(!0),i("");try{const y=await et(s);!y||y.length===0?j([]):j(y)}catch(y){console.error("Error loading applications:",y),i("Could not load applications. Please check your internet connection or permissions.")}finally{m(!1)}}}o()},[s]);const L=o=>{const y=o.firstName||o["first-name"]||o.personalInfo?.firstName||o.personalInfo?.["first-name"]||"",w=o.lastName||o["last-name"]||o.personalInfo?.lastName||o.personalInfo?.["last-name"]||"";return!y&&!w?"Unknown Driver":`${y} ${w}`.trim()},N=o=>o.email||o.personalInfo?.email||"No Email",v=o=>o.phone||o.personalInfo?.phone||"No Phone",g=n.useMemo(()=>{const o=h.toLowerCase();return o?p.filter(y=>{const w=L(y).toLowerCase(),x=N(y).toLowerCase(),S=(y.status||"").toLowerCase();return w.includes(o)||x.includes(o)||S.includes(o)}):p},[h,p]);return e.jsx("div",{id:"view-apps-modal",className:"fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[60]",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[85vh] flex flex-col border border-gray-200 overflow-hidden animate-in zoom-in-95 duration-200",onClick:o=>o.stopPropagation(),children:[e.jsxs("header",{className:"p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(je,{className:"text-blue-600"})," Driver Applications"]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Viewing records for ",e.jsx("span",{className:"font-semibold text-gray-900",children:r})]})]}),e.jsx("button",{className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors",onClick:a,children:e.jsx(Se,{size:24})})]}),e.jsx("div",{className:"p-4 border-b border-gray-200 bg-white shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Filter by driver name, email, or status...",className:"w-full p-2.5 pl-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:h,onChange:o=>b(o.target.value)}),e.jsx(Re,{size:18,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-0 bg-gray-50",children:[l&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-gray-500",children:[e.jsx(O,{className:"animate-spin mb-2",size:32}),e.jsx("p",{children:"Loading records..."})]}),u&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-red-600 px-6 text-center",children:[e.jsx(Le,{size:32,className:"mb-2"}),e.jsx("p",{children:u})]}),!l&&!u&&g.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-gray-400",children:[e.jsx(Ve,{size:48,className:"mb-2 opacity-20"}),e.jsx("p",{children:h?"No matches found.":"No applications submitted yet."})]}),!l&&!u&&g.length>0&&e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-gray-100 text-xs font-bold text-gray-500 uppercase sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Driver Name"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200",children:"Contact"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200 text-center",children:"Status"}),e.jsx("th",{className:"px-6 py-3 border-b border-gray-200 text-right",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white",children:g.map(o=>e.jsxs("tr",{className:"hover:bg-blue-50 transition-colors",children:[e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("span",{className:"font-bold text-gray-900 block",children:L(o)}),e.jsx("span",{className:"text-xs text-gray-400 font-mono",children:o.id})]}),e.jsxs("td",{className:"px-6 py-4 text-sm text-gray-600",children:[e.jsx("div",{children:N(o)}),e.jsx("div",{className:"text-xs text-gray-400",children:v(o)})]}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:`inline-flex px-2.5 py-1 rounded-full text-xs font-bold border ${vs(o.status||"New Application").replace("bg-","bg-opacity-10 bg-").replace("text-","border-")}`,children:o.status||"New Application"})}),e.jsx("td",{className:"px-6 py-4 text-right text-sm text-gray-500",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(Qs,{size:12}),o.submittedAt?.seconds?new Date(o.submittedAt.seconds*1e3).toLocaleDateString():o.createdAt?.seconds?new Date(o.createdAt.seconds*1e3).toLocaleDateString():"--"]})})]},o.id))})]})]}),e.jsx("footer",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-end items-center rounded-b-xl shrink-0",children:e.jsx("button",{className:"px-6 py-2 bg-white border border-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-100 transition-all shadow-sm",onClick:a,children:"Close View"})})]})})}function na({companyId:s,companyName:r,onClose:a,onConfirm:l}){const[m,p]=n.useState(!1),[j,u]=n.useState(""),i=async()=>{p(!0),u("");try{await B(H,"deleteCompany")({companyId:s}),await l(),a()}catch(h){console.error("Error deleting company:",h),u(h.message),p(!1)}};return e.jsx("div",{id:"delete-company-modal",className:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg border border-gray-200",children:[e.jsxs("header",{className:"p-5 border-b border-gray-200 flex justify-between items-center",children:[e.jsxs("h2",{className:"text-2xl font-bold text-red-700 flex items-center gap-2",children:[e.jsx(De,{}),"Delete Company?"]}),e.jsx("button",{className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full",onClick:a,children:e.jsx(Se,{size:20})})]}),e.jsxs("div",{className:"p-5",children:[e.jsxs("p",{className:"text-gray-600 mb-2",children:["Are you sure you want to delete ",e.jsx("strong",{className:"font-bold text-gray-900",children:r}),"?"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"This is a destructive action. It will permanently delete the company, all its users, all applications, and all associated files. This cannot be undone."}),j&&e.jsx("p",{id:"delete-company-error",className:"text-sm text-red-600 mb-4 p-3 bg-red-50 rounded-lg border border-red-200",children:j})]}),e.jsxs("footer",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-4 rounded-b-xl",children:[e.jsx("button",{className:"px-5 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-all",onClick:a,disabled:m,children:"Cancel"}),e.jsx("button",{className:"px-5 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 disabled:opacity-50 transition-all shadow-md",onClick:i,disabled:m,children:m?"Deleting...":"Delete Company"})]})]})})}function la({userId:s,userName:r,onClose:a,onConfirm:l}){const[m,p]=n.useState(!1),[j,u]=n.useState(""),i=async()=>{p(!0),u("");try{await B(H,"deletePortalUser")({userId:s}),await l(),a()}catch(h){console.error("Error deleting user:",h),u(h.message),p(!1)}};return e.jsx("div",{id:"delete-user-modal",className:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg border border-gray-200",children:[e.jsxs("header",{className:"p-5 border-b border-gray-200 flex justify-between items-center",children:[e.jsxs("h2",{className:"text-2xl font-bold text-red-700 flex items-center gap-2",children:[e.jsx(De,{}),"Delete User?"]}),e.jsx("button",{className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full",onClick:a,children:e.jsx(Se,{size:20})})]}),e.jsxs("div",{className:"p-5",children:[e.jsxs("p",{className:"text-gray-600 mb-2",children:["Are you sure you want to delete ",e.jsx("strong",{className:"font-bold text-gray-900",children:r}),"?"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"This is a destructive action. It will permanently delete the user's login, their user profile, and all their company memberships. This cannot be undone."}),j&&e.jsx("p",{id:"delete-user-error",className:"text-sm text-red-600 mb-4 p-3 bg-red-50 rounded-lg border border-red-200",children:j})]}),e.jsxs("footer",{className:"p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-4 rounded-b-xl",children:[e.jsx("button",{className:"px-5 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-all",onClick:a,disabled:m,children:"Cancel"}),e.jsx("button",{className:"px-5 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 disabled:opacity-50 transition-all shadow-md",onClick:i,disabled:m,children:m?"Deleting...":"Delete User"})]})]})})}function ia({editingCompanyDoc:s,deletingCompany:r,editingUser:a,deletingUser:l,viewingCompanyApps:m,selectedApplication:p,allCompaniesMap:j,onClose:u,onRefreshData:i,onPhoneClick:h}){return e.jsxs(e.Fragment,{children:[s&&e.jsx(aa,{companyDoc:s,onClose:u,onSave:i}),r&&e.jsx(na,{companyId:r.id,companyName:r.name,onClose:u,onConfirm:i}),a&&e.jsx(Ws,{userId:a.id,allCompaniesMap:j,onClose:u,onSave:i}),l&&e.jsx(la,{userId:l.id,userName:l.name,onClose:u,onConfirm:i}),m&&e.jsx(ra,{companyId:m.id,companyName:m.name,onClose:u}),p&&e.jsx(st,{companyId:p.companyId,applicationId:p.appId,collectionName:"applications",onClose:u,onStatusChange:i})]})}function Pa(){const{handleLogout:s}=Ss(),{showSuccess:r,showError:a,showInfo:l}=Ce(),[m,p]=n.useState("dashboard"),{searchResults:j,totalSearchResults:u,refreshData:i,loadMore:h,hasMoreCompanies:b,hasMoreApps:L,searchQuery:N,setSearchQuery:v,allCompaniesMap:g,stats:o,statsError:y,loading:w,companyList:x,userList:S,allApplications:D}=Dt(),[P,f]=n.useState(null),[M,t]=n.useState(null),[d,c]=n.useState(null),[C,R]=n.useState(null),[A,E]=n.useState(null),[U,z]=n.useState(null),[I,K]=n.useState(null),[V,q]=n.useState(!1),[te,ne]=n.useState(!1),[le,G]=n.useState(!1),T=N.length>0,_=()=>{f(null),t(null),c(null),R(null),E(null),z(null)},ie=async F=>{try{const Q=await be($(k,"companies",F));Q.exists()&&f(Q)}catch(Q){console.error("Error opening edit company:",Q),a("Could not load company details.")}},ue=F=>{z({companyId:F.companyId,appId:F.id})},re=(F,Q)=>{F&&F.stopPropagation(),Q&&Q.phone?window.location.href=`tel:${Q.phone}`:a("No phone number available for this driver.")},J=async()=>{if(window.confirm("Are you sure you want to distribute daily leads? This will FORCE ROTATE current leads.")){q(!0),l("Distribution started. This may take a few minutes...");try{const Q=await B(H,"distributeDailyLeads",{timeout:6e5})(),Ue=Q.data.details||[],ms=Ue.length>0?Ue.join(`
`):"Distribution complete.";console.log("Distribution Result:",Q.data),r("Success! Check console for details."),alert(`Distribution Report:
`+ms),i()}catch(F){console.error("Distribution Failed:",F),a("Error distributing leads: "+F.message)}finally{q(!1)}}},X=async()=>{if(window.confirm("Run database migration to copy DRIVERS to LEADS? This is required if the pool is empty.")){ne(!0),l("Starting migration... this may take a moment.");try{const Q=await B(H,"migrateDriversToLeads",{timeout:54e4})();r(Q.data.message),i()}catch(F){console.error("Migration Failed:",F),a("Migration failed: "+F.message)}finally{ne(!1)}}},oe=async()=>{G(!0),l("Purging trash leads...");try{const Q=await B(H,"cleanupBadLeads",{timeout:54e4})();r(Q.data.message),i()}catch(F){console.error("Cleanup Failed:",F),a("Cleanup failed: "+F.message)}finally{G(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"super-admin-container",className:"min-h-screen bg-gray-50",children:[e.jsx(Lt,{searchQuery:N,setSearchQuery:v,onDistribute:J,distributing:V,onFixData:X,fixingData:te,onCleanup:oe,cleaning:le,onLogout:s}),e.jsxs("div",{className:"container mx-auto p-4 sm:p-8 flex gap-8 items-start",children:[e.jsx(At,{activeView:m,setActiveView:p,isSearching:T,onClearSearch:()=>v("")}),e.jsx("main",{className:"flex-1 w-full min-w-0",children:e.jsx(ta,{isSearching:T,activeView:m,setActiveView:p,searchResults:j,totalSearchResults:u,allCompaniesMap:g,selectedIntegrationCompany:I,onSelectIntegrationCompany:F=>{K(F),p("integration-setup")},onBackToIntegrations:()=>{K(null),p("integrations")},stats:o,statsError:y,listLoading:w,companyList:x,userList:S,allApplications:D,onViewApps:E,onEditCompany:ie,onEditUser:c,onAppClick:ue,onDeleteCompany:t,onDeleteUser:R,onDataUpdate:i,loadMore:h,hasMoreCompanies:b,hasMoreApps:L})})]})]}),e.jsx(ia,{editingCompanyDoc:P,deletingCompany:M,editingUser:d,deletingUser:C,viewingCompanyApps:A,selectedApplication:U,allCompaniesMap:g,onClose:_,onRefreshData:i,onPhoneClick:re})]})}export{Pa as SuperAdminDashboard};
